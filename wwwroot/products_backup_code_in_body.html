<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>شاشة المنتجات - NaderProductsApp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- مكتبات الباركود و QR -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 0;
        }

        header {
            background: #1f2933;
            color: #fff;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        header h1 {
            margin: 0;
            font-size: 18px;
        }

        .header-actions {
            display: flex;
            gap: 6px;
        }

        button,
        .btn {
            border: none;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-primary { background-color: #2563eb; color: #fff; }
        .btn-secondary { background-color: #4b5563; color: #fff; }
        .btn-danger { background-color: #dc2626; color: #fff; }
        .btn-outline {
            background-color: transparent;
            border: 1px solid #d1d5db;
            color: #111827;
        }

        main {
            padding: 12px 18px 40px;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
        }

        .toolbar input[type="text"],
        .toolbar input[type="number"],
        .toolbar select {
            padding: 5px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 12px;
        }

        .card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(15, 23, 42, 0.12);
            padding: 10px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        thead { background-color: #e5e7eb; }

        th, td {
            padding: 6px 4px;
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
        }

        th { font-weight: 600; }

        tbody tr:nth-child(even) { background-color: #f9fafb; }

        .badge {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 999px;
            font-size: 11px;
        }
        .badge-green { background-color: #dcfce7; color: #166534; }
        .badge-yellow { background-color: #fef9c3; color: #854d0e; }
        .badge-red { background-color: #fee2e2; color: #b91c1c; }
        .badge-blue { background-color: #dbeafe; color: #1d4ed8; }

        /* Modal عام */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal {
            background: #fff;
            border-radius: 12px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 14px 18px 18px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 16px;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px 10px;
            margin-bottom: 8px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .form-group label {
            font-size: 12px;
            color: #374151;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select {
            padding: 5px 7px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 12px;
        }

        .form-group input[type="checkbox"] {
            transform: scale(1.05);
            margin-left: 3px;
        }

        .form-inline {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .section-title {
            margin-top: 10px;
            margin-bottom: 4px;
            font-size: 13px;
            font-weight: 600;
            color: #111827;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-start;
            gap: 8px;
            margin-top: 8px;
        }

        .small-text {
            font-size: 11px;
            color: #6b7280;
        }

        /* منطقة طباعة الباركود (نستخدمها فقط في نافذة جديدة) */
        #barcodePrintArea { display: none; }

        @media (max-width: 700px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
        }
    </style>
</head>
<body>
<header>
    <h1>إدارة المنتجات</h1>
    <div class="header-actions">
        <button class="btn btn-secondary" onclick="goHome()">العودة للرئيسية</button>
        <button class="btn btn-primary" onclick="openNewProductModal()">+ منتج جديد</button>
        <button class="btn btn-outline" onclick="printProducts()">🖨 طباعة النتائج</button>
        <button class="btn btn-secondary" onclick="openSettingsModal()">⚙️ إعدادات الشاشة</button>
    </div>
</header>

<main>
    <div class="toolbar">
        <input id="searchText" type="text" placeholder="بحث بالباركود أو اسم المنتج..." oninput="applyFilters()" />
        <input id="supplierSearch" type="text" placeholder="بحث باسم المورد..." oninput="applyFilters()" />
        <input id="remainingMin" type="number" placeholder="أدنى كمية متبقية" oninput="applyFilters()" style="max-width:120px;" />
        <input id="remainingMax" type="number" placeholder="أعلى كمية متبقية" oninput="applyFilters()" style="max-width:120px;" />

        <select id="stockFilter" onchange="applyFilters()">
            <option value="all">حالة المخزون: الكل</option>
            <option value="available">متوفر</option>
            <option value="low">منخفض</option>
            <option value="out">نافد</option>
        </select>

        <select id="expiryFilter" onchange="applyFilters()">
            <option value="all">الصلاحية: الكل</option>
            <option value="expired">منتهي</option>
            <option value="near">قريب الانتهاء</option>
            <option value="valid">ساري</option>
            <option value="noexpiry">بدون صلاحية</option>
        </select>

        <button class="btn btn-outline" onclick="loadProducts()">تحديث القائمة</button>
    </div>

    <div class="card">
        <table>
            <thead>
            <tr>
                <th>الباركود</th>
                <th>اسم المنتج</th>
                <th>المورد</th>
                <th>التصنيف</th>
                <th>الكمية</th>
                <th>مباع</th>
                <th>المتبقي</th>
                <th>حالة المخزون</th>
                <th>تاريخ الصلاحية</th>
                <th>حالة الصلاحية</th>
                <th>سعر الشراء</th>
                <th>سعر البيع</th>
                <th>الضريبة</th>
                <th>العرض</th>
                <th>إجراءات</th>
            </tr>
            </thead>
            <tbody id="productsBody">
            </tbody>
        </table>
    </div>
</main>

<div id="barcodePrintArea"></div>

<!-- Modal المنتج -->
<div id="productModalBackdrop" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modalTitle">منتج جديد</h2>
            <button class="modal-close" onclick="closeProductModal()">&times;</button>
        </div>

        <form id="productForm">
            <input type="hidden" id="productId" />

            <div class="section-title">البيانات الأساسية</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="Barcode">الباركود</label>
                    <input type="text" id="Barcode" required />
                </div>
                <div class="form-group">
                    <label for="Name">اسم المنتج</label>
                    <input type="text" id="Name" required />
                </div>
                <div class="form-group">
                    <label for="SupplierName">اسم المورد</label>
                    <input type="text" id="SupplierName" />
                </div>
                <div class="form-group">
                    <label for="Category">التصنيف</label>
                    <input type="text" id="Category" />
                </div>
                <div class="form-group">
                    <label for="Quantity">الكمية في المخزون</label>
                    <input type="number" id="Quantity" min="0" value="0" />
                </div>
                <div class="form-group">
                    <label for="MinQuantity">حد أدنى للتنبيه</label>
                    <input type="number" id="MinQuantity" min="0" value="0" />
                </div>
                <div class="form-group">
                    <label for="SoldQuantity">الكمية المباعة (اختياري)</label>
                    <input type="number" id="SoldQuantity" min="0" value="0" />
                </div>
                <div class="form-group">
                    <label for="PurchasePrice">سعر الشراء</label>
                    <input type="number" id="PurchasePrice" step="0.01" min="0" value="0" />
                </div>
                <div class="form-group">
                    <label for="SalePrice">سعر البيع</label>
                    <input type="number" id="SalePrice" step="0.01" min="0" value="0" />
                </div>
                <div class="form-group">
                    <label>الضريبة على سعر البيع</label>
                    <div class="form-inline">
                        <input type="checkbox" id="IsVatIncluded" checked />
                        <label for="IsVatIncluded">السعر شامل الضريبة</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="ExpiryDate">تاريخ انتهاء الصلاحية</label>
                    <input type="date" id="ExpiryDate" />
                    <span class="small-text">اتركه فارغًا لو لا يوجد صلاحية</span>
                </div>
            </div>

            <div class="section-title">بيانات العرض (Offer)</div>
            <div class="form-grid">
                <div class="form-group">
                    <label>تفعيل العرض</label>
                    <div class="form-inline">
                        <input type="checkbox" id="OfferEnabled" />
                        <label for="OfferEnabled">يوجد عرض على هذا المنتج</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="OfferName">اسم العرض</label>
                    <input type="text" id="OfferName" />
                </div>
                <div class="form-group">
                    <label for="OfferPrice">سعر العرض</label>
                    <input type="number" id="OfferPrice" step="0.01" min="0" value="0" />
                </div>
                <div class="form-group">
                    <label>الضريبة على سعر العرض</label>
                    <div class="form-inline">
                        <input type="checkbox" id="OfferVatIncluded" checked />
                        <label for="OfferVatIncluded">سعر العرض شامل الضريبة</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="OfferStart">بداية العرض</label>
                    <input type="date" id="OfferStart" />
                </div>
                <div class="form-group">
                    <label for="OfferEnd">نهاية العرض</label>
                    <input type="date" id="OfferEnd" />
                </div>
            </div>

            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">حفظ</button>
                <button type="button" class="btn btn-outline" onclick="printBarcodeFromForm()">طباعة باركود</button>
                <button type="button" class="btn btn-secondary" onclick="closeProductModal()">إلغاء</button>
            </div>
        </form>

        <p class="small-text">
            إذا فعّلت العرض، يجب تعبئة: اسم العرض، سعر العرض، تاريخ البداية والنهاية.
        </p>
    </div>
</div>

<!-- Modal إعدادات الشاشة -->
<div id="settingsModalBackdrop" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h2>إعدادات الشاشة والباركود</h2>
            <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
        </div>

        <div class="section-title">إعدادات الضريبة</div>
        <div class="form-grid">
            <div class="form-group">
                <label for="VatRate">نسبة الضريبة %</label>
                <input type="number" id="VatRate" step="0.01" min="0" max="100" />
                <span class="small-text">تستخدم في حساب السعر مع الضريبة وطباعة الباركود بالسعر الصحيح.</span>
            </div>
            <div class="form-group">
                <label for="ExpiryNearDays">عدد الأيام لاعتبار المنتج "قريب الانتهاء"</label>
                <input type="number" id="ExpiryNearDays" min="1" />
            </div>
        </div>

        <div class="section-title">تغيير أسعار جميع المنتجات (حسب النتائج الحالية)</div>
        <div class="form-grid">
            <div class="form-group">
                <label for="BulkDirection">الاتجاه</label>
                <select id="BulkDirection">
                    <option value="up">زيادة</option>
                    <option value="down">نقص</option>
                </select>
            </div>
            <div class="form-group">
                <label for="BulkMode">طريقة التغيير</label>
                <select id="BulkMode">
                    <option value="percent">نسبة مئوية %</option>
                    <option value="amount">مبلغ ثابت</option>
                </select>
            </div>
            <div class="form-group">
                <label for="BulkValue">القيمة</label>
                <input type="number" id="BulkValue" step="0.01" />
            </div>
            <div class="form-group">
                <label>تطبيق على:</label>
                <div class="form-inline">
                    <input type="checkbox" id="BulkAffectSale" checked />
                    <label for="BulkAffectSale">سعر البيع</label>
                    <input type="checkbox" id="BulkAffectPurchase" />
                    <label for="BulkAffectPurchase">سعر الشراء</label>
                </div>
            </div>
        </div>

        <div class="section-title">إعدادات طباعة الباركود</div>
        <div class="form-grid">
            <div class="form-group">
                <label for="StoreName">اسم المتجر في الباركود</label>
                <input type="text" id="StoreName" />
            </div>
            <div class="form-group">
                <label for="PrinterName">اسم الطابعة (للتذكير)</label>
                <input type="text" id="PrinterName" />
            </div>
            <div class="form-group">
                <label for="BarcodeType">نوع الكود</label>
                <select id="BarcodeType">
                    <option value="barcode">باركود (CODE128)</option>
                    <option value="qr">QR</option>
                </select>
            </div>
            <div class="form-group">
                <label for="LabelWidth">عرض الملصق (px)</label>
                <input type="number" id="LabelWidth" min="50" />
            </div>
            <div class="form-group">
                <label for="LabelHeight">ارتفاع الملصق (px)</label>
                <input type="number" id="LabelHeight" min="30" />
            </div>
            <div class="form-group">
                <label>طباعة السعر على الملصق</label>
                <div class="form-inline">
                    <input type="checkbox" id="BarcodeShowPrice" checked />
                    <label for="BarcodeShowPrice">إظهار السعر</label>
                </div>
                <select id="BarcodePriceMode">
                    <option value="withVat">سعر بعد الضريبة</option>
                    <option value="withoutVat">سعر قبل الضريبة</option>
                </select>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-primary" onclick="saveSettings()">حفظ الإعدادات</button>
            <button class="btn btn-outline" onclick="applyBulkPriceChange()">تطبيق تغيير الأسعار الآن</button>
            <button class="btn btn-secondary" onclick="closeSettingsModal()">إغلاق</button>
        </div>
    </div>
</div>

<script>
    let allProducts = [];
    let filteredProducts = [];
    let screenSettings = {
        vatRate: 15,
        expiryNearDays: 30,
        labelWidth: 180,
        labelHeight: 90,
        storeName: "",
        printerName: "",
        barcodeType: "barcode",
        showPrice: true,
        priceMode: "withVat"
    };

    function goHome() {
        window.location.href = "index.html";
    }

    function loadSettingsFromStorage() {
        try {
            const raw = localStorage.getItem("productsScreenSettings");
            if (raw) {
                const obj = JSON.parse(raw);
                screenSettings = Object.assign(screenSettings, obj);
            }
        } catch {}
    }

    function fillSettingsForm() {
        document.getElementById("VatRate").value = screenSettings.vatRate;
        document.getElementById("ExpiryNearDays").value = screenSettings.expiryNearDays;
        document.getElementById("StoreName").value = screenSettings.storeName || "";
        document.getElementById("PrinterName").value = screenSettings.printerName || "";
        document.getElementById("BarcodeType").value = screenSettings.barcodeType;
        document.getElementById("LabelWidth").value = screenSettings.labelWidth;
        document.getElementById("LabelHeight").value = screenSettings.labelHeight;
        document.getElementById("BarcodeShowPrice").checked = !!screenSettings.showPrice;
        document.getElementById("BarcodePriceMode").value = screenSettings.priceMode;
    }

    function openSettingsModal() {
        fillSettingsForm();
        document.getElementById("settingsModalBackdrop").style.display = "flex";
    }

    function closeSettingsModal() {
        document.getElementById("settingsModalBackdrop").style.display = "none";
    }

    function saveSettings() {
        const vat = parseFloat(document.getElementById("VatRate").value || "15");
        const near = parseInt(document.getElementById("ExpiryNearDays").value || "30", 10);
        const storeName = document.getElementById("StoreName").value.trim();
        const printerName = document.getElementById("PrinterName").value.trim();
        const barcodeType = document.getElementById("BarcodeType").value;
        const labelWidth = parseInt(document.getElementById("LabelWidth").value || "180", 10);
        const labelHeight = parseInt(document.getElementById("LabelHeight").value || "90", 10);
        const showPrice = document.getElementById("BarcodeShowPrice").checked;
        const priceMode = document.getElementById("BarcodePriceMode").value;

        screenSettings.vatRate = isNaN(vat) ? 15 : vat;
        screenSettings.expiryNearDays = isNaN(near) ? 30 : near;
        screenSettings.storeName = storeName;
        screenSettings.printerName = printerName;
        screenSettings.barcodeType = barcodeType;
        screenSettings.labelWidth = labelWidth;
        screenSettings.labelHeight = labelHeight;
        screenSettings.showPrice = showPrice;
        screenSettings.priceMode = priceMode;

        localStorage.setItem("productsScreenSettings", JSON.stringify(screenSettings));
        alert("تم حفظ الإعدادات.");
        applyFilters();
    }

    function openNewProductModal() {
        document.getElementById("modalTitle").textContent = "منتج جديد";
        document.getElementById("productId").value = "";

        document.getElementById("Barcode").value = "";
        document.getElementById("Name").value = "";
        document.getElementById("SupplierName").value = "";
        document.getElementById("Category").value = "";
        document.getElementById("Quantity").value = 0;
        document.getElementById("MinQuantity").value = 0;
        document.getElementById("SoldQuantity").value = 0;
        document.getElementById("PurchasePrice").value = 0;
        document.getElementById("SalePrice").value = 0;
        document.getElementById("IsVatIncluded").checked = true;
        document.getElementById("ExpiryDate").value = "";

        document.getElementById("OfferEnabled").checked = false;
        document.getElementById("OfferName").value = "";
        document.getElementById("OfferPrice").value = 0;
        document.getElementById("OfferVatIncluded").checked = true;
        document.getElementById("OfferStart").value = "";
        document.getElementById("OfferEnd").value = "";

        showProductModal();
    }

    function openEditProduct(id) {
        const product = allProducts.find(p => p.id === id || p.Id === id);
        if (!product) {
            alert("تعذر العثور على هذا المنتج.");
            return;
        }

        document.getElementById("modalTitle").textContent = "تعديل منتج";
        document.getElementById("productId").value = product.id || product.Id;

        document.getElementById("Barcode").value = product.barcode || product.Barcode || "";
        document.getElementById("Name").value = product.name || product.Name || "";
        document.getElementById("SupplierName").value = product.supplierName || product.SupplierName || "";
        document.getElementById("Category").value = product.category || product.Category || "";
        document.getElementById("Quantity").value = product.quantity ?? product.Quantity ?? 0;
        document.getElementById("MinQuantity").value = product.minQuantity ?? product.MinQuantity ?? 0;
        document.getElementById("SoldQuantity").value = product.soldQuantity ?? product.SoldQuantity ?? 0;
        document.getElementById("PurchasePrice").value = product.purchasePrice ?? product.PurchasePrice ?? 0;
        document.getElementById("SalePrice").value = product.salePrice ?? product.SalePrice ?? 0;
        document.getElementById("IsVatIncluded").checked = (product.isVatIncluded ?? product.IsVatIncluded ?? true);

        const exp = product.expiryDate || product.ExpiryDate;
        document.getElementById("ExpiryDate").value = exp ? String(exp).substring(0, 10) : "";

        document.getElementById("OfferEnabled").checked = product.offerEnabled ?? product.OfferEnabled ?? false;
        document.getElementById("OfferName").value = product.offerName ?? product.OfferName ?? "";
        document.getElementById("OfferPrice").value = product.offerPrice ?? product.OfferPrice ?? 0;
        document.getElementById("OfferVatIncluded").checked = product.offerVatIncluded ?? product.OfferVatIncluded ?? true;

        const os = product.offerStart || product.OfferStart;
        const oe = product.offerEnd || product.OfferEnd;
        document.getElementById("OfferStart").value = os ? String(os).substring(0, 10) : "";
        document.getElementById("OfferEnd").value = oe ? String(oe).substring(0, 10) : "";

        showProductModal();
    }

    function showProductModal() {
        document.getElementById("productModalBackdrop").style.display = "flex";
    }

    function closeProductModal() {
        document.getElementById("productModalBackdrop").style.display = "none";
    }

    async function loadProducts() {
        try {
            const res = await fetch("/api/products");
            if (!res.ok) {
                const t = await res.text();
                console.error("خطأ في جلب المنتجات", t);
                alert("خطأ في جلب المنتجات:\\n" + t);
                return;
            }

            allProducts = await res.json();
            applyFilters();
        } catch (e) {
            console.error(e);
            alert("تعذر الاتصال بالسيرفر.");
        }
    }

    function formatDate(dateString) {
        if (!dateString) return "";
        try {
            return String(dateString).substring(0, 10);
        } catch {
            return "";
        }
    }

    function getRemaining(product) {
        const q = product.quantity ?? product.Quantity ?? 0;
        const sold = product.soldQuantity ?? product.SoldQuantity ?? 0;
        const hasRemaining = product.remainingQuantity ?? product.RemainingQuantity;
        if (hasRemaining != null) return hasRemaining;
        return q - sold;
    }

    function getStockBadge(product) {
        const remaining = getRemaining(product);
        const min = product.minQuantity ?? product.MinQuantity ?? 0;

        if (remaining <= 0) return '<span class="badge badge-red">نافد</span>';
        if (remaining <= min) return '<span class="badge badge-yellow">منخفض</span>';
        return '<span class="badge badge-green">متوفر</span>';
    }

    function getExpiryStatus(product) {
        const exp = product.expiryDate || product.ExpiryDate;
        if (!exp) return "noexpiry";

        const d = new Date(exp);
        if (isNaN(d)) return "noexpiry";

        const now = new Date();
        const diffMs = d - now;
        const diffDays = diffMs / (1000 * 60 * 60 * 24);
        if (diffDays < 0) return "expired";
        if (diffDays <= screenSettings.expiryNearDays) return "near";
        return "valid";
    }

    function getExpiryBadge(product) {
        const status = getExpiryStatus(product);
        if (status === "expired") return '<span class="badge badge-red">منتهي</span>';
        if (status === "near") return '<span class="badge badge-yellow">قريب الانتهاء</span>';
        if (status === "valid") return '<span class="badge badge-green">ساري</span>';
        return '<span class="badge">بدون صلاحية</span>';
    }

    function getOfferStatusBadge(product) {
        const offerEnabled = product.offerEnabled ?? product.OfferEnabled;
        if (!offerEnabled) return '<span class="badge">لا يوجد عرض</span>';

        const now = new Date();
        const start = product.offerStart ? new Date(product.offerStart) :
                     product.OfferStart ? new Date(product.OfferStart) : null;
        const end = product.offerEnd ? new Date(product.offerEnd) :
                   product.OfferEnd ? new Date(product.OfferEnd) : null;

        if (start && now < start) return '<span class="badge badge-blue">عرض لم يبدأ</span>';
        if (end && now > end) return '<span class="badge badge-red">عرض منتهي</span>';
        return '<span class="badge badge-green">عرض ساري</span>';
    }

    function applyFilters() {
        const search = document.getElementById("searchText").value.trim().toLowerCase();
        const supplierSearch = document.getElementById("supplierSearch").value.trim().toLowerCase();
        const stockFilter = document.getElementById("stockFilter").value;
        const expiryFilter = document.getElementById("expiryFilter").value;
        const remainingMinVal = document.getElementById("remainingMin").value;
        const remainingMaxVal = document.getElementById("remainingMax").value;

        const remainingMin = remainingMinVal ? parseFloat(remainingMinVal) : null;
        const remainingMax = remainingMaxVal ? parseFloat(remainingMaxVal) : null;

        const tbody = document.getElementById("productsBody");
        tbody.innerHTML = "";

        filteredProducts = allProducts.filter(p => {
            if (search) {
                const text = (String(p.barcode || p.Barcode || "") + " " + String(p.name || p.Name || "")).toLowerCase();
                if (!text.includes(search)) return false;
            }

            if (supplierSearch) {
                const s = String(p.supplierName || p.SupplierName || "").toLowerCase();
                if (!s.includes(supplierSearch)) return false;
            }

            const remaining = getRemaining(p);

            if (remainingMin != null && remaining < remainingMin) return false;
            if (remainingMax != null && remaining > remainingMax) return false;

            const min = p.minQuantity ?? p.MinQuantity ?? 0;
            if (stockFilter === "available" && !(remaining > min)) return false;
            if (stockFilter === "low" && !(remaining > 0 && remaining <= min)) return false;
            if (stockFilter === "out" && !(remaining <= 0)) return false;

            const expStatus = getExpiryStatus(p);
            if (expiryFilter !== "all" && expStatus !== expiryFilter) return false;

            return true;
        });

        filteredProducts.forEach(p => {
            const remaining = getRemaining(p);
            const purchase = p.purchasePrice ?? p.PurchasePrice ?? 0;
            const sale = p.salePrice ?? p.SalePrice ?? 0;
            const isVatIncluded = (p.isVatIncluded ?? p.IsVatIncluded ?? true);

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${p.barcode || p.Barcode || ""}</td>
                <td>${p.name || p.Name || ""}</td>
                <td>${p.supplierName || p.SupplierName || ""}</td>
                <td>${p.category || p.Category || ""}</td>
                <td>${p.quantity ?? p.Quantity ?? 0}</td>
                <td>${p.soldQuantity ?? p.SoldQuantity ?? 0}</td>
                <td>${remaining}</td>
                <td>${getStockBadge(p)}</td>
                <td>${formatDate(p.expiryDate || p.ExpiryDate)}</td>
                <td>${getExpiryBadge(p)}</td>
                <td>${purchase}</td>
                <td>${sale}</td>
                <td>${isVatIncluded ? "شامل" : "غير شامل"}</td>
                <td>${getOfferStatusBadge(p)}</td>
                <td>
                    <button class="btn btn-outline" onclick="openEditProduct(${p.id || p.Id})">تعديل</button>
                    <button class="btn btn-danger" onclick="deleteProduct(${p.id || p.Id})">حذف</button>
                    <button class="btn btn-outline" onclick="printBarcodeForProduct(${p.id || p.Id})">باركود</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function deleteProduct(id) {
        if (!confirm("هل أنت متأكد من حذف هذا المنتج؟")) return;

        try {
            const res = await fetch(`/api/products/${id}`, { method: "DELETE" });
            if (!res.ok) {
                const t = await res.text();
                console.error("Delete error", t);
                alert("خطأ أثناء حذف المنتج:\\n" + t);
                return;
            }
            await loadProducts();
        } catch (e) {
            console.error(e);
            alert("تعذر الاتصال بالسيرفر.");
        }
    }

    async function saveProduct(event) {
        event.preventDefault();

        const id = document.getElementById("productId").value;

        const Barcode = document.getElementById("Barcode").value.trim();
        const Name = document.getElementById("Name").value.trim();
        const SupplierName = document.getElementById("SupplierName").value.trim();
        const Category = document.getElementById("Category").value.trim();
        const Quantity = parseInt(document.getElementById("Quantity").value || "0", 10);
        const MinQuantity = parseInt(document.getElementById("MinQuantity").value || "0", 10);
        const SoldQuantity = parseInt(document.getElementById("SoldQuantity").value || "0", 10);
        const PurchasePrice = parseFloat(document.getElementById("PurchasePrice").value || "0");
        const SalePrice = parseFloat(document.getElementById("SalePrice").value || "0");
        const IsVatIncluded = document.getElementById("IsVatIncluded").checked;

        const ExpiryDateVal = document.getElementById("ExpiryDate").value;

        const OfferEnabled = document.getElementById("OfferEnabled").checked;
        const OfferName = document.getElementById("OfferName").value.trim();
        const OfferPriceVal = document.getElementById("OfferPrice").value;
        const OfferPrice = OfferPriceVal ? parseFloat(OfferPriceVal) : null;
        const OfferVatIncluded = document.getElementById("OfferVatIncluded").checked;
        const OfferStartVal = document.getElementById("OfferStart").value;
        const OfferEndVal = document.getElementById("OfferEnd").value;

        if (!Barcode || !Name) {
            alert("الباركود واسم المنتج حقول إلزامية.");
            return;
        }

        if (OfferEnabled) {
            if (!OfferName || !OfferStartVal || !OfferEndVal || !OfferPriceVal || isNaN(OfferPrice)) {
                alert("إذا فعّلت العرض يجب تعبئة: اسم العرض، سعر العرض، تاريخ البداية والنهاية.");
                return;
            }
        }

        const productData = {
            barcode: Barcode,
            name: Name,
            supplierName: SupplierName,
            category: Category,
            quantity: Quantity,
            minQuantity: MinQuantity,
            soldQuantity: SoldQuantity,
            purchasePrice: PurchasePrice,
            salePrice: SalePrice,
            isVatIncluded: IsVatIncluded,
            expiryDate: ExpiryDateVal ? ExpiryDateVal : null,
            offerEnabled: OfferEnabled,
            offerName: OfferName,
            offerPrice: OfferPrice,
            offerStart: OfferStartVal ? OfferStartVal : null,
            offerEnd: OfferEndVal ? OfferEndVal : null,
            offerVatIncluded: OfferVatIncluded
        };

        if (id) {
            productData.id = parseInt(id, 10);
        }

        const url = id ? `/api/products/${id}` : "/api/products";
        const method = id ? "PUT" : "POST";

        try {
            const res = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(productData)
            });

            if (!res.ok) {
                const errorText = await res.text();
                console.error("Save error", errorText);
                alert("خطأ من السيرفر أثناء حفظ المنتج:\\n" + errorText);
                return;
            }

            closeProductModal();
            await loadProducts();
        } catch (e) {
            console.error(e);
            alert("تعذر الاتصال بالسيرفر أثناء حفظ المنتج.");
        }
    }

    async function applyBulkPriceChange() {
        if (!filteredProducts || filteredProducts.length === 0) {
            alert("لا توجد منتجات مطبقة عليها الفلاتر الحالية.");
            return;
        }

        const direction = document.getElementById("BulkDirection").value;
        const mode = document.getElementById("BulkMode").value;
        const valueRaw = document.getElementById("BulkValue").value;
        const affectSale = document.getElementById("BulkAffectSale").checked;
        const affectPurchase = document.getElementById("BulkAffectPurchase").checked;

        const value = parseFloat(valueRaw || "0");
        if (!affectSale && !affectPurchase) {
            alert("اختر على الأقل نوع سعر واحد لتطبيق التغيير (بيع/شراء).");
            return;
        }
        if (isNaN(value) || value <= 0) {
            alert("أدخل قيمة صحيحة أكبر من صفر.");
            return;
        }

        if (!confirm("سيتم تعديل أسعار جميع المنتجات الظاهرة في البحث الحالي. هل أنت متأكد؟")) return;

        for (const p of filteredProducts) {
            const updated = Object.assign({}, p);

            function getVal(v) {
                if (v == null) return 0;
                return typeof v === "number" ? v : parseFloat(v);
            }

            function calcNew(oldVal) {
                let v = getVal(oldVal);
                if (mode === "percent") {
                    const factor = value / 100;
                    if (direction === "up") v = v * (1 + factor);
                    else v = v * (1 - factor);
                } else {
                    if (direction === "up") v = v + value;
                    else v = v - value;
                }
                if (v < 0) v = 0;
                return parseFloat(v.toFixed(2));
            }

            if (affectSale) {
                updated.salePrice = calcNew(p.salePrice ?? p.SalePrice);
            }
            if (affectPurchase) {
                updated.purchasePrice = calcNew(p.purchasePrice ?? p.PurchasePrice);
            }

            try {
                const res = await fetch(`/api/products/${p.id || p.Id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updated)
                });
                if (!res.ok) {
                    console.error("Bulk update error for product", p.id || p.Id, await res.text());
                }
            } catch (e) {
                console.error("Bulk update exception for product", p.id || p.Id, e);
            }
        }

        alert("تم تنفيذ تغيير الأسعار على المنتجات الظاهرة.");
        await loadProducts();
    }

    function printProducts() {
        window.print();
    }

    function openBarcodeWindowForProducts(products) {
        const w = window.open("", "_blank");
        if (!w) {
            alert("المتصفح منع فتح نافذة للطباعة. اسمح بالنوافذ المنبثقة.");
            return;
        }

        const storeName = screenSettings.storeName || "";
        const showPrice = screenSettings.showPrice;
        const priceMode = screenSettings.priceMode;
        const vatRate = screenSettings.vatRate || 15;
        const labelWidth = screenSettings.labelWidth || 180;
        const labelHeight = screenSettings.labelHeight || 90;
        const barcodeType = screenSettings.barcodeType || "barcode";

        let html = `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<title>طباعة باركود</title>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<style>
body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}
#printArea {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}
.label {
    border: 1px solid #d1d5db;
    border-radius: 4px;
    padding: 4px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    box-sizing: border-box;
}
.store-name { font-size: 10px; margin-bottom: 2px; }
.product-name { font-size: 9px; margin-top: 2px; text-align: center; }
.price { font-size: 10px; margin-top: 2px; font-weight: 600; }
</style>
</head>
<body>
<div id="printArea">
`;

        products.forEach(p => {
            const code = p.barcode || p.Barcode || "";
            const name = String(p.name || p.Name || "").substring(0, 24);
            let basePrice = p.salePrice ?? p.SalePrice ?? 0;
            basePrice = typeof basePrice === "number" ? basePrice : parseFloat(basePrice || "0");
            let priceToShow = basePrice;
            if (priceMode === "withVat") {
                const factor = 1 + (vatRate / 100);
                priceToShow = basePrice * factor;
            }

            html += `<div class="label" style="width:${labelWidth}px;height:${labelHeight}px;">`;
            if (storeName) {
                html += `<div class="store-name">${storeName}</div>`;
            }

            if (barcodeType === "barcode") {
                html += `<svg class="code" data-type="barcode" data-code="${code}"></svg>`;
            } else {
                const val = code || name;
                html += `<canvas class="code" data-type="qr" data-code="${val}"></canvas>`;
            }

            html += `<div class="product-name">${name}</div>`;

            if (showPrice) {
                html += `<div class="price">${priceToShow.toFixed(2)} ر.س</div>`;
            }

            html += `</div>`;
        });

        html += `
</div>
<script>
window.addEventListener("load", function () {
    const elements = document.querySelectorAll(".code");
    elements.forEach(el => {
        const type = el.getAttribute("data-type");
        const code = el.getAttribute("data-code") || "";
        if (!code) return;
        try {
            if (type === "barcode") {
                JsBarcode(el, code, {
                    format: "CODE128",
                    displayValue: false,
                    margin: 0,
                    fontSize: 10
                });
            } else {
                new QRious({
                    element: el,
                    value: code,
                    size: Math.min(${labelWidth} - 10, ${labelHeight} - 20)
                });
            }
        } catch (e) { console.error(e); }
    });
    window.print();
});
</script>
</body>
</html>`;

        w.document.open();
        w.document.write(html);
        w.document.close();
    }

    function printBarcodeForProduct(id) {
        const p = allProducts.find(x => x.id === id || x.Id === id);
        if (!p) {
            alert("تعذر العثور على المنتج للطباعة.");
            return;
        }
        openBarcodeWindowForProducts([p]);
    }

    function printBarcodeFromForm() {
        const Barcode = document.getElementById("Barcode").value.trim();
        const Name = document.getElementById("Name").value.trim();
        let SalePrice = parseFloat(document.getElementById("SalePrice").value || "0");

        if (!Barcode && !Name) {
            alert("أدخل باركود أو اسم المنتج قبل طباعة الباركود.");
            return;
        }
        if (isNaN(SalePrice)) SalePrice = 0;

        const temp = {
            barcode: Barcode,
            name: Name,
            salePrice: SalePrice
        };
        openBarcodeWindowForProducts([temp]);
    }

    document.getElementById("productForm").addEventListener("submit", saveProduct);

    window.addEventListener("DOMContentLoaded", () => {
        loadSettingsFromStorage();
        loadProducts();
    });
</script>
</body>
</html>
