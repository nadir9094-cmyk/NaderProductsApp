<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>‘«‘… «·„‰ Ã« </title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: "Segoe UI", Tahoma, sans-serif;
            background: #f3f4f6;
            margin: 0;
        }
        header {
            background: #1f2937;
            color: white;
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            margin: 0;
            font-size: 20px;
        }
        .header-actions {
            display: flex;
            gap: 6px;
        }
        .btn {
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
        }
        .btn-primary { background: #2563eb; color: #fff; }
        .btn-secondary { background: #e5e7eb; color: #111827; }
        .btn-danger { background: #ef4444; color: #fff; }
        .btn-outline { background: transparent; border: 1px solid #9ca3af; color: #111827; }
        .btn:disabled { opacity: 0.6; cursor: default; }
        main {
            padding: 12px 16px 30px;
            max-width: 1300px;
            margin: 0 auto;
        }
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        .toolbar input, .toolbar select {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 13px;
        }
        .toolbar-group {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }
        thead {
            background: #e5e7eb;
        }
        th, td {
            padding: 7px 6px;
            font-size: 13px;
            border-bottom: 1px solid #f3f4f6;
            text-align: center;
        }
        tbody tr:nth-child(even) { background: #f9fafb; }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 999px;
            font-size: 11px;
        }
        .badge-success { background: #dcfce7; color: #15803d; }
        .badge-warning { background: #fef9c3; color: #854d0e; }
        .badge-danger { background: #fee2e2; color: #b91c1c; }
        .badge-offer { background: #dbeafe; color: #1d4ed8; }
        .footer-bar {
            margin-top: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #4b5563;
        }
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal {
            background: white;
            border-radius: 10px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 14px 16px 16px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 8px;
            padding-bottom: 6px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 16px;
        }
        .modal-body {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px 12px;
            font-size: 13px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
            border-top: 1px solid #e5e7eb;
            margin-top: 10px;
            padding-top: 8px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .form-group label {
            font-weight: 600;
            color: #374151;
        }
        .form-group input, .form-group select {
            padding: 5px 7px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 13px;
        }
        .form-inline {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .hint { font-size: 11px; color: #6b7280; }
        @media (max-width: 900px) {
            .modal-body { grid-template-columns: repeat(2, minmax(0,1fr)); }
        }
        @media (max-width: 640px) {
            header { flex-direction: column; align-items: flex-start; gap: 8px; }
            .toolbar { flex-direction: column; align-items: flex-start; }
            .modal-body { grid-template-columns: minmax(0,1fr); }
        }
    </style>
</head>
<body>
<header>
    <h1>‘«‘… «·„‰ Ã« </h1>
    <div class="header-actions">
        <a href="/index.html" class="btn btn-secondary">? «·⁄Êœ… ··—∆Ì”Ì…</a>
    </div>
</header>

<main>
    <!-- ‘—Ìÿ «·»ÕÀ Ê«·√Ê«„— -->
    <div class="toolbar">
        <div class="toolbar-group">
            <input id="searchText" type="text" placeholder="»ÕÀ »«·«”„ √Ê «·»«—ﬂÊœ..." oninput="applyFilters()" />
            <input id="searchSupplier" type="text" placeholder="»ÕÀ »«·„Ê—œ..." oninput="applyFilters()" />
            <select id="filterStatus" onchange="applyFilters()">
                <option value="">ﬂ· Õ«·«  «·„‰ Ã</option>
                <option value="available">„ Ê›—</option>
                <option value="low">„‰Œ›÷</option>
                <option value="out">‰«›œ</option>
                <option value="expired">„‰ ÂÌ «·’·«ÕÌ…</option>
            </select>
            <select id="filterOffer" onchange="applyFilters()">
                <option value="">ﬂ· «·⁄—Ê÷</option>
                <option value="has">„‰ Ã«  ⁄·ÌÂ« ⁄—÷</option>
                <option value="none">„‰ Ã«  »œÊ‰ ⁄—÷</option>
            </select>
        </div>
        <div class="toolbar-group">
            <button class="btn btn-primary" onclick="openNewProduct()">„‰ Ã ÃœÌœ +</button>
            <button class="btn btn-secondary" onclick="reloadProducts()"> ÕœÌÀ ?</button>
            <button class="btn btn-outline" onclick="openSettings()">? ≈⁄œ«œ«  «·‘«‘…</button>
            <button class="btn btn-outline" onclick="importProducts()">? «” Ì—«œ</button>
            <button class="btn btn-outline" onclick="exportProducts()">?  ’œÌ—</button>
            <button class="btn btn-secondary" onclick="printCurrentList()">?? ÿ»«⁄… Õ”» «·»ÕÀ</button>
        </div>
    </div>

    <!-- ÃœÊ· «·„‰ Ã«  -->
    <table>
        <thead>
            <tr>
                <th>«·»«—ﬂÊœ</th>
                <th>«”„ «·„‰ Ã</th>
                <th>«·„Ê—œ</th>
                <th>«· ’‰Ì›</th>
                <th>”⁄— «·»Ì⁄</th>
                <th>«·ﬂ„Ì… «·„ »ﬁÌ…</th>
                <th>Õ«·… «·„‰ Ã</th>
                <th>«·⁄—÷</th>
                <th> «—ÌŒ «·’·«ÕÌ…</th>
                <th>≈Ã—«¡« </th>
            </tr>
        </thead>
        <tbody id="productsBody">
        </tbody>
    </table>

    <!-- ‘—Ìÿ √”›· «·ÃœÊ· -->
    <div class="footer-bar">
        <div id="countsLabel">⁄œœ «·„‰ Ã« : 0 | «·„⁄—Ê÷: 0</div>
        <div>
            <button class="btn btn-secondary" onclick="firstPage()">«·√Ê·</button>
            <button class="btn btn-secondary" onclick="prevPage()">«·”«»ﬁ</button>
            <button class="btn btn-secondary" onclick="nextPage()">«· «·Ì</button>
            <button class="btn btn-secondary" onclick="lastPage()">«·√ŒÌ—</button>
        </div>
    </div>
</main>

<!-- ‰«›–… «·„‰ Ã -->
<div id="productModalBackdrop" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h2 id="productModalTitle">≈÷«›… „‰ Ã ÃœÌœ</h2>
            <button class="btn btn-secondary" onclick="closeProductModal()">≈€·«ﬁ ?</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="productId" />
            <div class="form-group">
                <label for="barcode">«·»«—ﬂÊœ</label>
                <input id="barcode" type="text" />
            </div>
            <div class="form-group">
                <label for="name">«”„ «·„‰ Ã</label>
                <input id="name" type="text" />
            </div>
            <div class="form-group">
                <label for="supplierName">«·„Ê—œ</label>
                <input id="supplierName" type="text" />
            </div>
            <div class="form-group">
                <label for="category">«· ’‰Ì›</label>
                <input id="category" type="text" />
            </div>
            <div class="form-group">
                <label for="quantity">«·ﬂ„Ì…</label>
                <input id="quantity" type="number" min="0" />
            </div>
            <div class="form-group">
                <label for="minQuantity">Õœ √œ‰Ï ··„Œ“Ê‰</label>
                <input id="minQuantity" type="number" min="0" />
            </div>
            <div class="form-group">
                <label for="purchasePrice">”⁄— «·‘—«¡</label>
                <input id="purchasePrice" type="number" min="0" step="0.01" />
            </div>
            <div class="form-group">
                <label for="salePrice">”⁄— «·»Ì⁄</label>
                <input id="salePrice" type="number" min="0" step="0.01" />
            </div>
            <div class="form-group">
                <label>«·÷—Ì»…</label>
                <div class="form-inline">
                    <input id="isVatIncluded" type="checkbox" checked />
                    <span>«·”⁄— ‘«„· «·÷—Ì»…</span>
                </div>
            </div>
            <div class="form-group">
                <label for="expiryDate"> «—ÌŒ «·’·«ÕÌ…</label>
                <input id="expiryDate" type="date" />
            </div>

            <div class="form-group">
                <label> ›⁄Ì· «·⁄—÷</label>
                <div class="form-inline">
                    <input id="offerEnabled" type="checkbox" onchange="updateOfferInfo()" />
                    <span> ‘€Ì· ⁄—÷ ··„‰ Ã</span>
                </div>
                <div class="hint">⁄‰œ  ›⁄Ì· «·⁄—÷ ÌÃ»  ÕœÌœ «”„ «·⁄—÷ Ê”⁄— «·⁄—÷ Ê Ê«—ÌŒ «·»œ«Ì… Ê«·‰Â«Ì….</div>
            </div>
            <div class="form-group">
                <label for="offerName">«”„ «·⁄—÷</label>
                <input id="offerName" type="text" />
            </div>
            <div class="form-group">
                <label for="offerPrice">”⁄— «·⁄—÷</label>
                <input id="offerPrice" type="number" min="0" step="0.01" />
            </div>
            <div class="form-group">
                <label>«·÷—Ì»… ›Ì «·⁄—÷</label>
                <div class="form-inline">
                    <input id="offerVatIncluded" type="checkbox" checked />
                    <span>”⁄— «·⁄—÷ ‘«„· «·÷—Ì»…</span>
                </div>
            </div>
            <div class="form-group">
                <label for="offerStart">»œ«Ì… «·⁄—÷</label>
                <input id="offerStart" type="date" onchange="updateOfferInfo()" />
            </div>
            <div class="form-group">
                <label for="offerEnd">‰Â«Ì… «·⁄—÷</label>
                <input id="offerEnd" type="date" onchange="updateOfferInfo()" />
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
                <label>„⁄·Ê„«  „œ… «·⁄—÷</label>
                <div id="offerInfo" class="hint">«·⁄—÷ €Ì— „›⁄¯·.</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeProductModal()">≈·€«¡</button>
            <button class="btn btn-primary" onclick="saveProduct()">Õ›Ÿ</button>
        </div>
    </div>
</div>

<!-- ‰«›–… ≈⁄œ«œ«  «·‘«‘… Ê«·»«—ﬂÊœ -->
<div id="settingsModalBackdrop" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h2>≈⁄œ«œ«  «·‘«‘… Ê«·»«—ﬂÊœ Ê«·÷—Ì»…</h2>
            <button class="btn btn-secondary" onclick="closeSettings()">≈€·«ﬁ ?</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="taxRate">‰”»… «·÷—Ì»… %</label>
                <input id="taxRate" type="number" min="0" step="0.1" />
            </div>
            <div class="form-group">
                <label>ŒÌ«—«  «·»«—ﬂÊœ</label>
                <div class="form-inline">
                    <input id="bcShowStore" type="checkbox" />
                    <span>≈ŸÂ«— «”„ «·„Õ·</span>
                </div>
                <div class="form-inline">
                    <input id="bcShowProduct" type="checkbox" />
                    <span>≈ŸÂ«— «”„ «·„‰ Ã</span>
                </div>
                <div class="form-inline">
                    <input id="bcShowPrice" type="checkbox" />
                    <span>≈ŸÂ«— «·”⁄—</span>
                </div>
            </div>
            <div class="form-group">
                <label for="bcLabelWidth">⁄—÷ «·„·’ﬁ („„)</label>
                <input id="bcLabelWidth" type="number" min="10" step="1" />
            </div>
            <div class="form-group">
                <label for="bcLabelHeight">ÿÊ· «·„·’ﬁ („„)</label>
                <input id="bcLabelHeight" type="number" min="10" step="1" />
            </div>
            <div class="form-group">
                <label for="bcLabelPerRow">⁄œœ «·„·’ﬁ«  ›Ì «·’›</label>
                <input id="bcLabelPerRow" type="number" min="1" step="1" />
            </div>
            <div class="form-group">
                <label for="bcLabelTotal">⁄œœ «·„·’ﬁ«  ›Ì «·’›Õ…</label>
                <input id="bcLabelTotal" type="number" min="1" step="1" />
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeSettings()">≈·€«¡</button>
            <button class="btn btn-primary" onclick="saveSettings()">Õ›Ÿ «·≈⁄œ«œ« </button>
        </div>
    </div>
</div>

<!-- ‰«›–… ÿ»«⁄… «·»«—ﬂÊœ -->
<div id="barcodeModalBackdrop" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h2>„⁄«Ì‰… »«—ﬂÊœ «·„‰ Ã</h2>
            <button class="btn btn-secondary" onclick="closeBarcodeModal()">≈€·«ﬁ ?</button>
        </div>
        <div class="modal-body" style="grid-template-columns: 1fr;">
            <div class="form-group">
                <label>»«—ﬂÊœ</label>
                <div id="barcodePreviewText" class="hint"></div>
            </div>
            <div id="barcodeCanvasWrapper" style="margin-top:10px; text-align:center;">
                <svg id="barcodeSvg"></svg>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="printBarcode()">ÿ»«⁄… «·»«—ﬂÊœ</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script>
    let products = [];
    let filteredProducts = [];
    let currentPage = 1;
    const pageSize = 50;
    let editingId = null;
    let barcodeProduct = null;

    window.addEventListener("load", () => {
        loadSettingsFromStorage();
        reloadProducts();
    });

    async function reloadProducts() {
        try {
            const res = await fetch("/api/products");
            if (!res.ok) {
                alert("ÕœÀ Œÿ√ ›Ì  Õ„Ì· «·„‰ Ã«  „‰ «·Œ«œ„.");
                return;
            }
            products = await res.json();
            applyFilters();
        } catch (e) {
            console.error(e);
            alert(" ⁄–— «·« ’«· »«·Œ«œ„.");
        }
    }

    function applyFilters() {
        const text = document.getElementById("searchText").value.trim().toLowerCase();
        const sup = document.getElementById("searchSupplier").value.trim().toLowerCase();
        const status = document.getElementById("filterStatus").value;
        const offer = document.getElementById("filterOffer").value;

        filteredProducts = products.filter(p => {
            const nameMatch = !text ||
                (p.name && p.name.toLowerCase().includes(text)) ||
                (p.barcode && p.barcode.toLowerCase().includes(text));
            const supMatch = !sup ||
                (p.supplierName && p.supplierName.toLowerCase().includes(sup));

            const remaining = (p.quantity || 0) - (p.soldQuantity || 0);
            const today = new Date();
            let statusMatch = true;
            if (status === "available") statusMatch = remaining > 0;
            if (status === "low") statusMatch = remaining > 0 && remaining <= (p.minQuantity || 0);
            if (status === "out") statusMatch = remaining <= 0;
            if (status === "expired") {
                if (!p.expiryDate) statusMatch = false;
                else statusMatch = new Date(p.expiryDate) < today;
            }

            let offerMatch = true;
            if (offer === "has") offerMatch = !!p.offerEnabled;
            if (offer === "none") offerMatch = !p.offerEnabled;

            return nameMatch && supMatch && statusMatch && offerMatch;
        });

        currentPage = 1;
        renderProducts();
    }

    function renderProducts() {
        const body = document.getElementById("productsBody");
        body.innerHTML = "";
        const total = filteredProducts.length;
        if (total === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 10;
            td.textContent = "·«  ÊÃœ „‰ Ã«  „ÿ«»ﬁ….";
            tr.appendChild(td);
            body.appendChild(tr);
        } else {
            const totalPages = Math.ceil(total / pageSize);
            if (currentPage > totalPages) currentPage = totalPages || 1;
            const start = (currentPage - 1) * pageSize;
            const end = Math.min(start + pageSize, total);
            const pageItems = filteredProducts.slice(start, end);

            for (const p of pageItems) {
                const tr = document.createElement("tr");
                const remaining = (p.quantity || 0) - (p.soldQuantity || 0);

                let statusText = "„ Ê›—";
                let statusClass = "badge-success";
                if (remaining <= 0) {
                    statusText = "‰«›œ";
                    statusClass = "badge-danger";
                } else if (remaining > 0 && remaining <= (p.minQuantity || 0)) {
                    statusText = "„‰Œ›÷";
                    statusClass = "badge-warning";
                }

                let offerBadge = "-";
                if (p.offerEnabled && p.offerPrice != null) {
                    offerBadge = "<span class=\"badge badge-offer\">⁄—÷: " + p.offerPrice + "</span>";
                }

                let expiryText = p.expiryDate ? p.expiryDate.toString().substring(0,10) : "";

                tr.innerHTML = `
                    <td>${p.barcode || ""}</td>
                    <td>${p.name || ""}</td>
                    <td>${p.supplierName || ""}</td>
                    <td>${p.category || ""}</td>
                    <td>${p.salePrice != null ? p.salePrice.toFixed(2) : ""}</td>
                    <td>${remaining}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${offerBadge}</td>
                    <td>${expiryText}</td>
                    <td></td>
                `;

                const actionsTd = tr.lastElementChild;
                const editBtn = document.createElement("button");
                editBtn.className = "btn btn-secondary";
                editBtn.textContent = " ⁄œÌ·";
                editBtn.onclick = () => openEditProduct(p.id);

                const delBtn = document.createElement("button");
                delBtn.className = "btn btn-danger";
                delBtn.style.marginRight = "4px";
                delBtn.textContent = "Õ–›";
                delBtn.onclick = () => deleteProduct(p.id);

                const bcBtn = document.createElement("button");
                bcBtn.className = "btn btn-outline";
                bcBtn.style.marginRight = "4px";
                bcBtn.textContent = "»«—ﬂÊœ";
                bcBtn.onclick = () => openBarcodeModal(p);

                actionsTd.appendChild(editBtn);
                actionsTd.appendChild(delBtn);
                actionsTd.appendChild(bcBtn);

                body.appendChild(tr);
            }

            const countsLabel = document.getElementById("countsLabel");
            countsLabel.textContent =
                "⁄œœ «·„‰ Ã«  «·ﬂ·Ì: " + products.length +
                " | «·„⁄—Ê÷: " + (start + 1) + "ñ" + end +
                " „‰ " + total + " Õ”» «·»ÕÀ";
        }
    }

    function nextPage() {
        const totalPages = Math.ceil(filteredProducts.length / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            renderProducts();
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderProducts();
        }
    }

    function firstPage() {
        currentPage = 1;
        renderProducts();
    }

    function lastPage() {
        const totalPages = Math.ceil(filteredProducts.length / pageSize);
        if (totalPages > 0) {
            currentPage = totalPages;
            renderProducts();
        }
    }

    function openNewProduct() {
        editingId = null;
        document.getElementById("productModalTitle").textContent = "≈÷«›… „‰ Ã ÃœÌœ";
        resetProductForm();
        openProductModal();
    }

    function openEditProduct(id) {
        const p = products.find(x => x.id === id);
        if (!p) return;
        editingId = id;
        document.getElementById("productModalTitle").textContent = " ⁄œÌ· „‰ Ã";

        document.getElementById("productId").value = p.id;
        document.getElementById("barcode").value = p.barcode || "";
        document.getElementById("name").value = p.name || "";
        document.getElementById("supplierName").value = p.supplierName || "";
        document.getElementById("category").value = p.category || "";
        document.getElementById("quantity").value = p.quantity != null ? p.quantity : "";
        document.getElementById("minQuantity").value = p.minQuantity != null ? p.minQuantity : "";
        document.getElementById("purchasePrice").value = p.purchasePrice != null ? p.purchasePrice : "";
        document.getElementById("salePrice").value = p.salePrice != null ? p.salePrice : "";
        document.getElementById("isVatIncluded").checked = !!p.isVatIncluded;
        document.getElementById("expiryDate").value = p.expiryDate ? p.expiryDate.toString().substring(0,10) : "";

        document.getElementById("offerEnabled").checked = !!p.offerEnabled;
        document.getElementById("offerName").value = p.offerName || "";
        document.getElementById("offerPrice").value = p.offerPrice != null ? p.offerPrice : "";
        document.getElementById("offerVatIncluded").checked = p.offerVatIncluded !== false;
        document.getElementById("offerStart").value = p.offerStart ? p.offerStart.toString().substring(0,10) : "";
        document.getElementById("offerEnd").value = p.offerEnd ? p.offerEnd.toString().substring(0,10) : "";

        updateOfferInfo();
        openProductModal();
    }

    function resetProductForm() {
        document.getElementById("productId").value = "";
        document.getElementById("barcode").value = "";
        document.getElementById("name").value = "";
        document.getElementById("supplierName").value = "";
        document.getElementById("category").value = "";
        document.getElementById("quantity").value = "";
        document.getElementById("minQuantity").value = "";
        document.getElementById("purchasePrice").value = "";
        document.getElementById("salePrice").value = "";
        document.getElementById("isVatIncluded").checked = true;
        document.getElementById("expiryDate").value = "";
        document.getElementById("offerEnabled").checked = false;
        document.getElementById("offerName").value = "";
        document.getElementById("offerPrice").value = "";
        document.getElementById("offerVatIncluded").checked = true;
        document.getElementById("offerStart").value = "";
        document.getElementById("offerEnd").value = "";
        document.getElementById("offerInfo").textContent = "«·⁄—÷ €Ì— „›⁄¯·.";
    }

    function openProductModal() {
        document.getElementById("productModalBackdrop").style.display = "flex";
    }

    function closeProductModal() {
        document.getElementById("productModalBackdrop").style.display = "none";
    }

    function updateOfferInfo() {
        const enabled = document.getElementById("offerEnabled").checked;
        const startVal = document.getElementById("offerStart").value;
        const endVal = document.getElementById("offerEnd").value;
        const info = document.getElementById("offerInfo");

        if (!enabled) {
            info.textContent = "«·⁄—÷ €Ì— „›⁄¯·.";
            return;
        }
        if (!startVal || !endVal) {
            info.textContent = "⁄‰œ  ›⁄Ì· «·⁄—÷ ÌÃ»  ÕœÌœ  «—ÌŒ »œ«Ì… Ê‰Â«Ì… «·⁄—÷ ﬁ»· «·Õ›Ÿ.";
            return;
        }
        const s = new Date(startVal);
        const e = new Date(endVal);
        if (isNaN(s) || isNaN(e) || e < s) {
            info.textContent = " √ﬂœ √‰  «—ÌŒ ‰Â«Ì… «·⁄—÷ »⁄œ √Ê Ì”«ÊÌ  «—ÌŒ «·»œ«Ì….";
            return;
        }
        const diffDays = Math.round((e - s) / (1000*60*60*24)) + 1;
        info.textContent = "„œ… «·⁄—÷ " + diffDays + " ÌÊ„° „‰ " + startVal + " ≈·Ï " + endVal + ".";
    }

    async function saveProduct() {
        const offerEnabled = document.getElementById("offerEnabled").checked;
        const offerStartVal = document.getElementById("offerStart").value;
        const offerEndVal = document.getElementById("offerEnd").value;

        if (offerEnabled) {
            if (!offerStartVal || !offerEndVal) {
                alert("⁄‰œ  ›⁄Ì· «·⁄—÷ ÌÃ»  ÕœÌœ  «—ÌŒ »œ«Ì… Ê‰Â«Ì… «·⁄—÷.");
                return;
            }
            const s = new Date(offerStartVal);
            const e = new Date(offerEndVal);
            if (isNaN(s) || isNaN(e) || e < s) {
                alert(" √ﬂœ √‰  «—ÌŒ ‰Â«Ì… «·⁄—÷ »⁄œ √Ê Ì”«ÊÌ  «—ÌŒ «·»œ«Ì….");
                return;
            }
        }

        const payload = {
            barcode: document.getElementById("barcode").value.trim(),
            name: document.getElementById("name").value.trim(),
            supplierName: document.getElementById("supplierName").value.trim(),
            category: document.getElementById("category").value.trim(),
            quantity: Number(document.getElementById("quantity").value || 0),
            minQuantity: Number(document.getElementById("minQuantity").value || 0),
            soldQuantity: 0,
            purchasePrice: Number(document.getElementById("purchasePrice").value || 0),
            salePrice: Number(document.getElementById("salePrice").value || 0),
            isVatIncluded: document.getElementById("isVatIncluded").checked,
            expiryDate: document.getElementById("expiryDate").value || null,
            offerEnabled: offerEnabled,
            offerName: offerEnabled ? document.getElementById("offerName").value.trim() : "",
            offerPrice: offerEnabled ? Number(document.getElementById("offerPrice").value || 0) : null,
            offerStart: offerEnabled ? offerStartVal : null,
            offerEnd: offerEnabled ? offerEndVal : null,
            offerVatIncluded: offerEnabled ? document.getElementById("offerVatIncluded").checked : true
        };

        try {
            // Â‰« ‰ Â—» „‰ PUT ‰Â«∆Ì« · ›«œÌ 500
            if (editingId) {
                await fetch("/api/products/" + editingId, { method: "DELETE" });
            }
            const res = await fetch("/api/products", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                console.error("Save error", await res.text());
                alert("ÕœÀ Œÿ√ √À‰«¡ Õ›Ÿ «·„‰ Ã.");
                return;
            }
            closeProductModal();
            await reloadProducts();
        } catch (e) {
            console.error(e);
            alert(" ⁄–— «·« ’«· »«·Œ«œ„ √À‰«¡ Õ›Ÿ «·„‰ Ã.");
        }
    }

    async function deleteProduct(id) {
        if (!confirm(" √ﬂÌœ Õ–› «·„‰ Ãø")) return;
        try {
            const res = await fetch("/api/products/" + id, { method: "DELETE" });
            if (!res.ok) {
                alert(" ⁄–— Õ–› «·„‰ Ã.");
                return;
            }
            await reloadProducts();
        } catch (e) {
            console.error(e);
            alert(" ⁄–— «·« ’«· »«·Œ«œ„ √À‰«¡ «·Õ–›.");
        }
    }

    function openSettings() {
        document.getElementById("settingsModalBackdrop").style.display = "flex";
    }

    function closeSettings() {
        document.getElementById("settingsModalBackdrop").style.display = "none";
    }

    function saveSettings() {
        const settings = {
            taxRate: Number(document.getElementById("taxRate").value || 0),
            bcShowStore: document.getElementById("bcShowStore").checked,
            bcShowProduct: document.getElementById("bcShowProduct").checked,
            bcShowPrice: document.getElementById("bcShowPrice").checked,
            bcLabelWidth: Number(document.getElementById("bcLabelWidth").value || 0),
            bcLabelHeight: Number(document.getElementById("bcLabelHeight").value || 0),
            bcLabelPerRow: Number(document.getElementById("bcLabelPerRow").value || 0),
            bcLabelTotal: Number(document.getElementById("bcLabelTotal").value || 0)
        };
        localStorage.setItem("productsScreenSettings", JSON.stringify(settings));
        alert(" „ Õ›Ÿ «·≈⁄œ«œ«  ›Ì «·‰Ÿ«„ («·„ ’›Õ).");
        closeSettings();
    }

    function loadSettingsFromStorage() {
        const s = localStorage.getItem("productsScreenSettings");
        if (!s) return;
        try {
            const settings = JSON.parse(s);
            document.getElementById("taxRate").value = settings.taxRate || "";
            document.getElementById("bcShowStore").checked = !!settings.bcShowStore;
            document.getElementById("bcShowProduct").checked = !!settings.bcShowProduct;
            document.getElementById("bcShowPrice").checked = !!settings.bcShowPrice;
            document.getElementById("bcLabelWidth").value = settings.bcLabelWidth || "";
            document.getElementById("bcLabelHeight").value = settings.bcLabelHeight || "";
            document.getElementById("bcLabelPerRow").value = settings.bcLabelPerRow || "";
            document.getElementById("bcLabelTotal").value = settings.bcLabelTotal || "";
        } catch {}
    }

    function openBarcodeModal(p) {
        barcodeProduct = p;
        document.getElementById("barcodePreviewText").textContent =
            "«·»«—ﬂÊœ: " + (p.barcode || "") + " | " + (p.name || "");
        document.getElementById("barcodeModalBackdrop").style.display = "flex";
        try {
            JsBarcode("#barcodeSvg", p.barcode || "", {
                format: "EAN13",
                displayValue: true
            });
        } catch (e) {
            console.error(e);
        }
    }

    function closeBarcodeModal() {
        document.getElementById("barcodeModalBackdrop").style.display = "none";
    }

    function printBarcode() {
        if (!barcodeProduct) return;
        const w = window.open("", "_blank");
        w.document.write("<html><head><meta charset='utf-8'><title>ÿ»«⁄… »«—ﬂÊœ</title></head><body style='text-align:center;'>");
        w.document.write("<svg id='bar'></svg>");
        w.document.write("<script src='https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js'><\/script>");
        w.document.write("<script>JsBarcode('#bar', '" + (barcodeProduct.barcode || "") + "', {format:'EAN13',displayValue:true});<\/script>");
        w.document.write("</body></html>");
        w.document.close();
        w.focus();
        w.print();
    }

    function printCurrentList() {
        window.print();
    }

    function importProducts() {
        alert("«” Ì—«œ «·„‰ Ã«  ”Ì „ —»ÿÂ ·«Õﬁ« (CSV/Excel).");
    }

    function exportProducts() {
        alert(" ’œÌ— «·„‰ Ã«  ”Ì „ —»ÿÂ ·«Õﬁ« (CSV/Excel).");
    }
</script>
</body>
</html>
