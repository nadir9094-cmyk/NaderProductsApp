<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>تقرير الفواتير - NaderPOS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg: #f3f4f6;
            --bg-soft: #e5e7eb;
            --card: #ffffff;
            --border: #d1d5db;
            --text: #111827;
            --text-muted: #6b7280;
            --accent: #f97316;
            --accent-soft: #ffedd5;
            --accent-strong: #ea580c;
            --danger: #dc2626;
            --danger-soft: #fee2e2;
            --success: #16a34a;
            --success-soft: #dcfce7;
            --shadow-sm: 0 1px 2px rgba(15,23,42,0.06);
            --shadow-md: 0 4px 6px rgba(15,23,42,0.12);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg);
            color: var(--text);
        }

        .page { min-height: 100vh; display: flex; flex-direction: column; }

        .topbar {
            background: #ffffff;
            border-bottom: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .topbar-title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-strong);
        }

        .topbar-title span.logo-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: var(--accent);
        }

        .topbar-sub {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 0.4rem 0.9rem;
            font-size: 0.8rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            white-space: nowrap;
            transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
        }

        .btn:active { transform: scale(0.98); }

        .btn-primary {
            background: var(--accent);
            color: #ffffff;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover { background: var(--accent-strong); }

        .btn-soft {
            background: var(--accent-soft);
            color: var(--accent-strong);
            border-color: #fed7aa;
        }

        .btn-ghost {
            background: transparent;
            border-color: var(--border);
            color: var(--text-muted);
        }

        .btn-danger {
            background: var(--danger);
            color: #ffffff;
        }

        .btn-danger-soft {
            background: var(--danger-soft);
            color: var(--danger);
            border-color: #fecaca;
        }

        .btn-success-soft {
            background: var(--success-soft);
            color: var(--success);
            border-color: #bbf7d0;
        }

        .main {
            flex: 1;
            display: grid;
            grid-template-columns: minmax(0, 3fr) minmax(320px, 380px);
            gap: 1rem;
            padding: 1rem 1.5rem 1.5rem;
        }

        @media (max-width: 1024px) {
            .main { grid-template-columns: minmax(0, 1fr); }
        }

        .card {
            background: var(--card);
            border-radius: 0.9rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            padding: 0.9rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .card-title { font-size: 0.95rem; font-weight: 600; }

        .card-subtitle { font-size: 0.75rem; color: var(--text-muted); }

        .filters {
            display: grid;
            grid-template-columns: repeat(6, minmax(0, 1fr));
            gap: 0.4rem;
            margin-bottom: 0.75rem;
        }

        @media (max-width: 1100px) {
            .filters { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }

        @media (max-width: 640px) {
            .filters { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        .field { display: flex; flex-direction: column; gap: 0.15rem; }

        .field-label { font-size: 0.7rem; color: var(--text-muted); }

        .field input,
        .field select {
            font-size: 0.8rem;
            padding: 0.25rem 0.45rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border);
            background: #ffffff;
            outline: none;
        }

        .field input:focus,
        .field select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px #fed7aa;
        }

        .filters-actions {
            display: flex;
            align-items: flex-end;
            gap: 0.25rem;
            grid-column: span 2;
        }

        .pill-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-bottom: 0.35rem;
        }

        .pill {
            font-size: 0.7rem;
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .pill-soft { background: var(--accent-soft); color: var(--accent-strong); }
        .pill-muted { background: var(--bg-soft); color: var(--text-muted); }

        .table-wrap {
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            overflow: hidden;
            background: #ffffff;
        }

        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        thead { background: var(--bg-soft); }

        th, td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: right;
        }

        th { font-weight: 600; color: var(--text-muted); white-space: nowrap; }

        tbody tr:hover { background: #f9fafb; }

        .table-empty {
            padding: 0.8rem;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .col-actions { white-space: nowrap; }

        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: 999px;
            padding: 0.1rem 0.45rem;
            font-size: 0.7rem;
            gap: 0.25rem;
            white-space: nowrap;
        }

        .badge-cash { background: #dcfce7; color: #166534; }
        .badge-network { background: #e0f2fe; color: #075985; }
        .badge-deferred { background: #fef3c7; color: #92400e; }
        .badge-paid { background: #dcfce7; color: #166534; }
        .badge-unpaid { background: #fee2e2; color: #b91c1c; }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        @media (max-width: 900px) {
            .summary-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        }

        .summary-card {
            background: #ffffff;
            border-radius: 0.75rem;
            border: 1px solid var(--border);
            padding: 0.55rem 0.6rem;
        }

        .summary-label { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.15rem; }
        .summary-value { font-size: 0.9rem; font-weight: 600; }
        .summary-note { font-size: 0.68rem; color: var(--text-muted); }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .sidebar-section {
            background: var(--card);
            border-radius: 0.9rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            padding: 0.8rem;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .sidebar-title { font-size: 0.9rem; font-weight: 600; }

        .sidebar-body { font-size: 0.78rem; }

        .items-list {
            max-height: 260px;
            overflow-y: auto;
            border-radius: 0.6rem;
            border: 1px solid var(--border);
            background: #ffffff;
        }

        .item-row {
            display: grid;
            grid-template-columns: 2.2fr 0.9fr 0.8fr 1fr;
            gap: 0.25rem;
            padding: 0.3rem 0.45rem;
            border-bottom: 1px solid #f3f4f6;
            align-items: center;
        }

        .item-row:nth-child(odd) { background-color: #f9fafb; }
        .item-header { font-weight: 600; font-size: 0.72rem; background: #f3f4f6; }
        .item-name { font-weight: 500; }
        .item-muted { color: var(--text-muted); }

        .badge-small { font-size: 0.68rem; padding-inline: 0.3rem; }

        .return-input {
            width: 100%;
            font-size: 0.75rem;
            padding: 0.2rem 0.35rem;
            border-radius: 0.4rem;
            border: 1px solid var(--border);
        }

        .return-input:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 1px #fed7aa;
        }

        .sidebar-footer { margin-top: 0.5rem; display: flex; flex-direction: column; gap: 0.35rem; }
        .sidebar-footer .field { margin-bottom: 0.2rem; }
        .sidebar-footer .btn-row { display: flex; flex-wrap: wrap; gap: 0.25rem; justify-content: flex-end; }

        .products-list {
            max-height: 220px;
            overflow-y: auto;
            border-radius: 0.6rem;
            border: 1px solid var(--border);
            background: #ffffff;
        }

        .product-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1.2fr;
            gap: 0.25rem;
            padding: 0.3rem 0.4rem;
            border-bottom: 1px solid #f3f4f6;
            align-items: center;
        }

        .product-row:nth-child(odd) { background: #f9fafb; }
        .products-header { font-weight: 600; font-size: 0.72rem; background: #f3f4f6; }
        .product-name { font-weight: 500; }

        .muted { color: var(--text-muted); }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.78rem; }
        .text-xs { font-size: 0.7rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-1 { margin-top: 0.25rem; }
        .mb-1 { margin-bottom: 0.25rem; }

        .alert {
            padding: 0.4rem 0.5rem;
            border-radius: 0.6rem;
            border: 1px solid #fee2e2;
            background: #fef2f2;
            color: #b91c1c;
            font-size: 0.75rem;
            margin-bottom: 0.3rem;
        }

        .toast {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: #111827;
            color: #f9fafb;
            padding: 0.5rem 0.9rem;
            font-size: 0.78rem;
            border-radius: 999px;
            box-shadow: var(--shadow-md);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease-out, transform 0.15s ease-out;
            z-index: 50;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-4px);
        }

        /* Receipt print (cashier size) */
        @media print {
            body {
                background: #ffffff !important;
            }
            .page, .topbar, .main {
                display: block !important;
                padding: 0;
                margin: 0;
            }
            .page, .main {
                width: 80mm;
            }
            .topbar, .card, .sidebar, .sidebar-section {
                box-shadow: none !important;
                border-radius: 0 !important;
            }
            /* نطبع فقط الفاتورة الخاصة بالمرتجع */
            body * {
                visibility: hidden;
            }
            #returnReceipt, #returnReceipt * {
                visibility: visible;
            }
            #returnReceipt {
                position: absolute;
                left: 0;
                top: 0;
                width: 80mm !important;
            }
        }
    </style>
</head>
<body>
<div class="page">
    <header class="topbar">
        <div>
            <div class="topbar-title">
                <span class="logo-dot"></span>
                شاشة تقرير الفواتير - NaderPOS
            </div>
            <div class="topbar-sub">بحث سريع، مرتجع، حذف مع استرجاع الكمية، وتقرير المنتجات الأكثر مبيعاً.</div>
        </div>
        <div class="topbar-actions">
            <button class="btn btn-ghost" type="button" onclick="window.location.href='cashier.html'">شاشة الكاشير</button>
            <button class="btn btn-soft" type="button" onclick="window.print()">🖨 طباعة التقرير</button>
        </div>
    </header>

    <main class="main">
        <!-- LEFT: invoices list -->
        <section class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">الفواتير</div>
                    <div class="card-subtitle">استخدم الحقول بالأسفل للبحث حسب رقم الفاتورة أو التاريخ أو طريقة الدفع.</div>
                </div>
                <div class="pill-row">
                    <div class="pill pill-muted">
                        <span id="pillCount">عدد الفواتير: 0</span>
                    </div>
                    <div class="pill pill-soft">
                        <span id="pillTotal">إجمالي المبالغ: 0.00 ريال</span>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="field">
                    <label class="field-label">رقم الفاتورة</label>
                    <input id="filterInvoiceId" type="number" inputmode="numeric" placeholder="مثال: 1203" />
                </div>
                <div class="field">
                    <label class="field-label">من تاريخ</label>
                    <input id="filterFrom" type="date" />
                </div>
                <div class="field">
                    <label class="field-label">إلى تاريخ</label>
                    <input id="filterTo" type="date" />
                </div>
                <div class="field">
                    <label class="field-label">طريقة الدفع</label>
                    <select id="filterPayment">
                        <option value="">الكل</option>
                        <option value="cash">نقدي</option>
                        <option value="network">شبكة</option>
                        <option value="deferred">مؤجل</option>
                    </select>
                </div>
                <div class="field">
                    <label class="field-label">حالة الفاتورة</label>
                    <select id="filterStatus">
                        <option value="">الكل</option>
                        <option value="paid">مسددة</option>
                        <option value="deferred">مؤجلة</option>
                    </select>
                </div>
                <div class="filters-actions">
                    <button class="btn btn-primary" type="button" onclick="loadInvoices()">🔍 بحث</button>
                    <button class="btn btn-ghost" type="button" onclick="resetFilters()">مسح</button>
                </div>
            </div>

            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>رقم</th>
                            <th>التاريخ</th>
                            <th>طريقة الدفع</th>
                            <th>الحالة</th>
                            <th>الإجمالي</th>
                            <th>ملاحظة</th>
                            <th class="text-center">التحكم</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesBody">
                        <tr><td colspan="7" class="table-empty">لا توجد بيانات بعد. قم بعمل بحث أو تأكد من وجود فواتير.</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">إجمالي نقدي</div>
                    <div class="summary-value" id="sumCash">0.00 ريال</div>
                    <div class="summary-note">من نتائج البحث الحالية.</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">إجمالي شبكة</div>
                    <div class="summary-value" id="sumNetwork">0.00 ريال</div>
                    <div class="summary-note">مدفوع عبر نقاط البيع.</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">إجمالي مؤجل</div>
                    <div class="summary-value" id="sumDeferred">0.00 ريال</div>
                    <div class="summary-note">فواتير عملاء الدفع المؤجل.</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">عدد الفواتير</div>
                    <div class="summary-value" id="sumCount">0</div>
                    <div class="summary-note">ضمن الفترة المحددة.</div>
                </div>
            </div>
        </section>

        <!-- RIGHT: details / returns / products -->
        <aside class="sidebar">
            <!-- Invoice items -->
            <section class="sidebar-section">
                <div class="sidebar-header">
                    <div class="sidebar-title">مواد الفاتورة</div>
                    <button class="btn btn-ghost text-xs" type="button" onclick="clearInvoiceItems()">مسح</button>
                </div>
                <div class="sidebar-body">
                    <div id="invoiceItemsInfo" class="text-xs muted mb-1">اختر فاتورة من الجدول واضغط "مواد" لعرض منتجاتها.</div>
                    <div class="items-list" id="invoiceItemsList">
                        <div class="item-row item-header">
                            <div>المنتج</div>
                            <div class="text-center">الكمية</div>
                            <div class="text-center">السعر</div>
                            <div class="text-center">الإجمالي</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Returns -->
            <section class="sidebar-section">
                <div class="sidebar-header">
                    <div class="sidebar-title">شاشة المرتجع</div>
                    <button class="btn btn-ghost text-xs" type="button" onclick="clearReturn()">مسح</button>
                </div>
                <div class="sidebar-body">
                    <div id="returnAlert" class="alert" style="display:none;"></div>
                    <div class="text-xs muted mb-1">اختر فاتورة واضغط "مرتجع" لتعبئة هذه الشاشة تلقائياً.</div>
                    <div class="items-list" id="returnItemsList">
                        <div class="item-row item-header">
                            <div>المنتج</div>
                            <div class="text-center">مباع</div>
                            <div class="text-center">مرتجع</div>
                            <div class="text-center">ملاحظة</div>
                        </div>
                    </div>
                    <div class="sidebar-footer">
                        <div class="field">
                            <label class="field-label">رقم فاتورة المرتجع</label>
                            <input id="returnInvoiceNumber" type="text" class="text-sm" placeholder="مثال: R-2025-001" />
                        </div>
                        <div class="field">
                            <label class="field-label">ملاحظة المرتجع</label>
                            <input id="returnNote" type="text" class="text-sm" placeholder="مثال: مرتجع من فاتورة رقم ..." />
                        </div>
                        <div class="btn-row">
                            <button class="btn btn-success-soft text-xs" type="button" onclick="submitReturn()">✅ حفظ المرتجع</button>
                            <button class="btn btn-soft text-xs" type="button" onclick="printReturnReceipt()">🖨 طباعة المرتجع</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Products report -->
            <section class="sidebar-section">
                <div class="sidebar-header">
                    <div class="sidebar-title">المنتجات الأكثر مبيعاً</div>
                    <button class="btn btn-ghost text-xs" type="button" onclick="loadProductsReport()">تحديث</button>
                </div>
                <div class="sidebar-body">
                    <div class="text-xs muted mb-1">يعتمد على نفس فترة البحث أعلاه (من تاريخ / إلى تاريخ).</div>
                    <div class="products-list" id="productsList">
                        <div class="products-header product-row">
                            <div>المنتج</div>
                            <div class="text-center">الكمية</div>
                            <div class="text-center">المبيعات</div>
                        </div>
                    </div>
                </div>
            </section>
        </aside>
    </main>
</div>

<!-- Receipt for return (80mm) -->
<div id="returnReceipt" style="
    width: 80mm;
    padding: 10px;
    background: white;
    font-family: 'Tahoma', sans-serif;
    font-size: 13px;
    color: #000;
    display: none;
">
    <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 10px;">
        <h3 style="margin: 0; font-size: 16px;">فاتورة مرتجع</h3>
        <div id="storeName" style="font-size: 12px;">NaderPOS Store</div>
        <div id="returnInvoiceNumberLabel">رقم فاتورة المرتجع: -</div>
        <div id="originalInvoiceNumberLabel">مرتجع من فاتورة: -</div>
        <div id="receiptDateLabel">التاريخ: --/--/----</div>
    </div>

    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
        <thead>
            <tr>
                <th style="text-align: right;">الصنف</th>
                <th style="text-align: center;">الكمية</th>
                <th style="text-align: center;">السعر</th>
                <th style="text-align: left;">الإجمالي</th>
            </tr>
        </thead>
        <tbody id="receiptItems"></tbody>
    </table>

    <div style="border-top: 1px dashed #000; margin-top: 10px; padding-top: 10px;">
        <div id="receiptSubtotalLabel">المجموع: 0 ريال</div>
        <div id="receiptVatLabel">الضريبة (15%): 0 ريال</div>
        <div id="receiptTotalLabel" style="font-weight: bold; font-size: 14px;">الإجمالي النهائي: 0 ريال</div>
    </div>

    <div style="text-align: center; margin-top: 15px; font-size: 12px;">
        شكراً لتسوقكم معنا
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    let currentInvoices = [];
    let currentInvoiceIdForReturn = null;
    let lastReturnPayload = null;

    function showToast(message, type) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.background = type === 'error' ? '#b91c1c' : '#111827';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2200);
    }

    function formatDateTime(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return iso;
        return d.toLocaleString('ar-SA');
    }

    function formatCurrency(value) {
        const n = Number(value || 0);
        return n.toLocaleString('ar-SA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ريال';
    }

    function getFilters() {
        return {
            invoiceId: document.getElementById('filterInvoiceId').value.trim(),
            from: document.getElementById('filterFrom').value,
            to: document.getElementById('filterTo').value,
            paymentMethod: document.getElementById('filterPayment').value,
            status: document.getElementById('filterStatus').value
        };
    }

    function buildInvoicesQuery() {
        const f = getFilters();
        const params = new URLSearchParams();
        if (f.invoiceId) params.set('invoiceId', f.invoiceId);
        if (f.from) params.set('from', f.from);
        if (f.to) params.set('to', f.to);
        if (f.paymentMethod) params.set('paymentMethod', f.paymentMethod);
        if (f.status) params.set('status', f.status);
        return '/api/invoices?' + params.toString();
    }

    async function loadInvoices() {
        try {
            const url = buildInvoicesQuery();
            const res = await fetch(url);
            if (!res.ok) throw new Error('فشل في تحميل قائمة الفواتير');
            const data = await res.json();
            currentInvoices = Array.isArray(data) ? data : [];
            renderInvoicesTable();
            updateSummary();
        } catch (err) {
            console.error(err);
            showToast(err.message || 'حدث خطأ أثناء تحميل الفواتير', 'error');
        }
    }

    function resetFilters() {
        document.getElementById('filterInvoiceId').value = '';
        document.getElementById('filterFrom').value = '';
        document.getElementById('filterTo').value = '';
        document.getElementById('filterPayment').value = '';
        document.getElementById('filterStatus').value = '';
        loadInvoices();
    }

    function renderInvoicesTable() {
        const body = document.getElementById('invoicesBody');
        body.innerHTML = '';

        if (!currentInvoices.length) {
            body.innerHTML = '<tr><td colspan="7" class="table-empty">لا توجد فواتير في نتائج البحث.</td></tr>';
            document.getElementById('pillCount').textContent = 'عدد الفواتير: 0';
            document.getElementById('pillTotal').textContent = 'إجمالي المبالغ: 0.00 ريال';
            return;
        }

        let total = 0;
        currentInvoices.forEach(inv => total += Number(inv.total || inv.Total || 0));

        document.getElementById('pillCount').textContent = 'عدد الفواتير: ' + currentInvoices.length;
        document.getElementById('pillTotal').textContent = 'إجمالي المبالغ: ' + formatCurrency(total);

        for (const inv of currentInvoices) {
            const tr = document.createElement('tr');

            const id = inv.id ?? inv.Id;
            const dt = inv.invoiceDate ?? inv.InvoiceDate;
            const pay = (inv.paymentMethod ?? inv.PaymentMethod ?? '').toLowerCase();
            const notes = inv.notes ?? inv.Notes ?? '';
            const totalVal = inv.total ?? inv.Total ?? 0;

            let status = 'paid';
            if (pay === 'deferred') status = 'deferred';

            tr.innerHTML = `
                <td>${id ?? ''}</td>
                <td>${formatDateTime(dt)}</td>
                <td>${renderPaymentBadge(pay)}</td>
                <td>${renderStatusBadge(status)}</td>
                <td>${formatCurrency(totalVal)}</td>
                <td>${notes ? escapeHtml(notes) : ''}</td>
                <td class="col-actions text-center">
                    <button class="btn btn-ghost text-xs" type="button" onclick="loadInvoiceItems(${id})">مواد</button>
                    <button class="btn btn-soft text-xs" type="button" onclick="prepareReturn(${id})">مرتجع</button>
                    <button class="btn btn-danger-soft text-xs" type="button" onclick="deleteInvoice(${id})">حذف</button>
                </td>
            `;
            body.appendChild(tr);
        }
    }

    function renderPaymentBadge(pay) {
        switch (pay) {
            case 'cash': return '<span class="badge badge-cash">نقدي</span>';
            case 'network': return '<span class="badge badge-network">شبكة</span>';
            case 'deferred': return '<span class="badge badge-deferred">مؤجل</span>';
            default: return '<span class="badge badge-deferred" style="opacity:0.7;">غير محدد</span>';
        }
    }

    function renderStatusBadge(status) {
        if (status === 'deferred') return '<span class="badge badge-unpaid">مؤجل</span>';
        return '<span class="badge badge-paid">مسددة</span>';
    }

    function updateSummary() {
        let sumCash = 0, sumNetwork = 0, sumDeferred = 0;
        for (const inv of currentInvoices) {
            const pay = (inv.paymentMethod ?? inv.PaymentMethod ?? '').toLowerCase();
            const totalVal = Number(inv.total ?? inv.Total ?? 0);
            if (pay === 'cash') sumCash += totalVal;
            else if (pay === 'network') sumNetwork += totalVal;
            else if (pay === 'deferred') sumDeferred += totalVal;
        }

        document.getElementById('sumCash').textContent = formatCurrency(sumCash);
        document.getElementById('sumNetwork').textContent = formatCurrency(sumNetwork);
        document.getElementById('sumDeferred').textContent = formatCurrency(sumDeferred);
        document.getElementById('sumCount').textContent = currentInvoices.length.toString();
    }

    async function loadInvoiceItems(invoiceId) {
        clearInvoiceItems();
        if (!invoiceId) return;
        try {
            const res = await fetch(`/api/cashier/invoices/${invoiceId}/items`);
            if (!res.ok) throw new Error('فشل في تحميل مواد الفاتورة');
            const items = await res.json();
            renderInvoiceItems(invoiceId, items);
        } catch (err) {
            console.error(err);
            showToast(err.message || 'حدث خطأ أثناء تحميل مواد الفاتورة', 'error');
        }
    }

    function clearInvoiceItems() {
        const list = document.getElementById('invoiceItemsList');
        list.innerHTML = `
            <div class="item-row item-header">
                <div>المنتج</div>
                <div class="text-center">الكمية</div>
                <div class="text-center">السعر</div>
                <div class="text-center">الإجمالي</div>
            </div>
        `;
        document.getElementById('invoiceItemsInfo').textContent = 'اختر فاتورة من الجدول واضغط "مواد" لعرض منتجاتها.';
    }

    function renderInvoiceItems(invoiceId, items) {
        const list = document.getElementById('invoiceItemsList');
        clearInvoiceItems();

        document.getElementById('invoiceItemsInfo').textContent = `مواد الفاتورة رقم ${invoiceId}`;

        if (!Array.isArray(items) || !items.length) {
            const empty = document.createElement('div');
            empty.className = 'text-xs muted mt-1';
            empty.textContent = 'لا توجد مواد مسجلة لهذه الفاتورة.';
            list.appendChild(empty);
            return;
        }

        for (const it of items) {
            const name = it.productName ?? it.ProductName ?? '';
            const qty = it.quantity ?? it.Quantity ?? 0;
            const price = it.price ?? it.Price ?? 0;
            const discount = it.discount ?? it.Discount ?? 0;
            const lineTotal = (Number(price) - Number(discount)) * Number(qty);

            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `
                <div class="item-name">${escapeHtml(name)}</div>
                <div class="text-center item-muted">${qty}</div>
                <div class="text-center item-muted">${price}</div>
                <div class="text-center"><span class="badge badge-small badge-cash">${lineTotal.toFixed(2)}</span></div>
            `;
            list.appendChild(row);
        }
    }

    async function deleteInvoice(invoiceId) {
        if (!invoiceId) return;
        const ok = confirm('هل أنت متأكد من حذف هذه الفاتورة؟ سيتم استرجاع كميات المنتجات المرتبطة بها.');
        if (!ok) return;
        try {
            const res = await fetch(`/api/invoices/${invoiceId}`, { method: 'DELETE' });
            if (!res.ok && res.status !== 204) {
                const msg = await res.text();
                throw new Error(msg || 'لم يتم حذف الفاتورة');
            }
            showToast('تم حذف الفاتورة واسترجاع الكمية (حسب إعدادات السيرفر).');
            await loadInvoices();
            clearInvoiceItems();
            if (currentInvoiceIdForReturn === invoiceId) clearReturn();
        } catch (err) {
            console.error(err);
            showToast(err.message || 'حدث خطأ أثناء حذف الفاتورة', 'error');
        }
    }

    async function prepareReturn(invoiceId) {
        clearReturn();
        currentInvoiceIdForReturn = invoiceId;
        if (!invoiceId) return;
        try {
            const res = await fetch(`/api/cashier/invoices/${invoiceId}/items`);
            if (!res.ok) throw new Error('فشل في تحميل مواد الفاتورة للمرتجع');
            const items = await res.json();
            renderReturnItems(invoiceId, items);
        } catch (err) {
            console.error(err);
            showToast(err.message || 'حدث خطأ أثناء تجهيز شاشة المرتجع', 'error');
        }
    }

    function clearReturn() {
        currentInvoiceIdForReturn = null;
        lastReturnPayload = null;
        document.getElementById('returnInvoiceNumber').value = '';
        document.getElementById('returnNote').value = '';
        document.getElementById('returnAlert').style.display = 'none';
        const list = document.getElementById('returnItemsList');
        list.innerHTML = `
            <div class="item-row item-header">
                <div>المنتج</div>
                <div class="text-center">مباع</div>
                <div class="text-center">مرتجع</div>
                <div class="text-center">ملاحظة</div>
            </div>
        `;
    }

    function renderReturnItems(invoiceId, items) {
        const list = document.getElementById('returnItemsList');
        clearReturn();
        currentInvoiceIdForReturn = invoiceId;

        if (!Array.isArray(items) || !items.length) {
            const empty = document.createElement('div');
            empty.className = 'text-xs muted mt-1';
            empty.textContent = 'لا توجد مواد مسجلة لهذه الفاتورة للمرتجع.';
            list.appendChild(empty);
            return;
        }

        for (const it of items) {
            const name = it.productName ?? it.ProductName ?? '';
            const qty = Number(it.quantity ?? it.Quantity ?? 0);

            const row = document.createElement('div');
            row.className = 'item-row';
            row.innerHTML = `
                <div class="item-name">${escapeHtml(name)}</div>
                <div class="text-center item-muted">${qty}</div>
                <div class="text-center">
                    <input class="return-input" type="number" min="0" max="${qty}" step="1"
                        data-product-name="${escapeHtmlAttr(name)}"
                        data-max="${qty}"
                        value="0" />
                </div>
                <div class="text-center item-muted text-xs">بحد أقصى ${qty}</div>
            `;
            list.appendChild(row);
        }
    }

    async function submitReturn() {
        const alertBox = document.getElementById('returnAlert');
        alertBox.style.display = 'none';
        alertBox.textContent = '';

        if (!currentInvoiceIdForReturn) {
            alertBox.textContent = 'الرجاء اختيار فاتورة أولاً (زر مرتجع).';
            alertBox.style.display = 'block';
            return;
        }

        const inputs = Array.from(document.querySelectorAll('#returnItemsList .return-input'));
        const items = [];
        for (const input of inputs) {
            const raw = input.value.trim();
            const q = Number(raw || 0);
            const max = Number(input.getAttribute('data-max') || 0);
            const name = input.getAttribute('data-product-name') || '';
            if (!name) continue;
            if (q < 0) {
                alertBox.textContent = 'كمية المرتجع لا يمكن أن تكون سالبة.';
                alertBox.style.display = 'block';
                return;
            }
            if (q > max) {
                alertBox.textContent = `كمية المرتجع للمنتج "${name}" أكبر من الكمية المباعة (${max}).`;
                alertBox.style.display = 'block';
                return;
            }
            if (q > 0) {
                items.push({ productName: name, quantity: q });
            }
        }

        if (!items.length) {
            alertBox.textContent = 'لم يتم إدخال أي كميات مرتجع.';
            alertBox.style.display = 'block';
            return;
        }

        const payload = {
            invoiceId: currentInvoiceIdForReturn,
            returnInvoiceNumber: document.getElementById('returnInvoiceNumber').value.trim() || null,
            note: document.getElementById('returnNote').value.trim() || null,
            items
        };

        try {
            const res = await fetch('/api/returns', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt || 'فشل في حفظ المرتجع');
            }
            const result = await res.json();
            lastReturnPayload = result;
            showToast('تم حفظ المرتجع بنجاح.');
            await loadInvoices();
            renderReturnReceipt(result);
        } catch (err) {
            console.error(err);
            alertBox.textContent = err.message || 'حدث خطأ أثناء حفظ المرتجع.';
            alertBox.style.display = 'block';
        }
    }

    async function loadProductsReport() {
        try {
            const f = getFilters();
            const params = new URLSearchParams();
            if (f.from) params.set('from', f.from);
            if (f.to) params.set('to', f.to);
            const url = '/api/reports/products?' + params.toString();
            const res = await fetch(url);
            if (!res.ok) throw new Error('فشل في تحميل تقرير المنتجات.');
            const data = await res.json();
            renderProductsReport(data);
        } catch (err) {
            console.error(err);
            showToast(err.message || 'حدث خطأ أثناء تحميل تقرير المنتجات', 'error');
        }
    }

    function renderProductsReport(data) {
        const list = document.getElementById('productsList');
        list.innerHTML = `
            <div class="products-header product-row">
                <div>المنتج</div>
                <div class="text-center">الكمية</div>
                <div class="text-center">المبيعات</div>
            </div>
        `;

        if (!Array.isArray(data) || !data.length) {
            const empty = document.createElement('div');
            empty.className = 'text-xs muted mt-1';
            empty.textContent = 'لا توجد بيانات للمنتجات ضمن الفترة المحددة.';
            list.appendChild(empty);
            return;
        }

        for (const p of data) {
            const name = p.productName ?? p.ProductName ?? '';
            const qty = Number(p.totalQuantity ?? p.TotalQuantity ?? 0);
            const amt = Number(p.totalAmount ?? p.TotalAmount ?? 0);

            const row = document.createElement('div');
            row.className = 'product-row';
            row.innerHTML = `
                <div class="product-name">${escapeHtml(name)}</div>
                <div class="text-center muted">${qty}</div>
                <div class="text-center muted">${formatCurrency(amt)}</div>
            `;
            list.appendChild(row);
        }
    }

    function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function escapeHtmlAttr(str) {
        return escapeHtml(str).replace(/"/g, '&quot;');
    }

    function renderReturnReceipt(data) {
        try {
            const invId = data.invoiceId ?? data.InvoiceId ?? currentInvoiceIdForReturn;
            const retNo = data.returnInvoiceNumber ?? data.ReturnInvoiceNumber ?? '';
            const items = Array.isArray(data.items) ? data.items : (data.Items || []);
            const storeNameEl = document.getElementById('storeName');
            const retLbl = document.getElementById('returnInvoiceNumberLabel');
            const orgLbl = document.getElementById('originalInvoiceNumberLabel');
            const dateLbl = document.getElementById('receiptDateLabel');
            const body = document.getElementById('receiptItems');

            storeNameEl.textContent = 'NaderPOS'; // تقدر تعدلها لاحقاً من السيرفر
            retLbl.textContent = 'رقم فاتورة المرتجع: ' + (retNo || '-');
            orgLbl.textContent = 'مرتجع من فاتورة: #' + (invId || '-');
            dateLbl.textContent = 'التاريخ: ' + new Date().toLocaleString('ar-SA');

            body.innerHTML = '';
            let subtotal = 0;

            for (const it of items) {
                const name = it.productName ?? it.ProductName ?? '';
                const qty = Number(it.quantity ?? it.Quantity ?? 0);
                const price = Number(it.price ?? it.Price ?? 0);
                const line = qty * price;
                subtotal += line;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align:right;">${escapeHtml(name)}</td>
                    <td style="text-align:center;">${qty}</td>
                    <td style="text-align:center;">${price.toFixed(2)}</td>
                    <td style="text-align:left;">${line.toFixed(2)}</td>
                `;
                body.appendChild(row);
            }

            const vat = subtotal * 0.15;
            const total = subtotal + vat;
            document.getElementById('receiptSubtotalLabel').textContent = 'المجموع: ' + subtotal.toFixed(2) + ' ريال';
            document.getElementById('receiptVatLabel').textContent = 'الضريبة (15%): ' + vat.toFixed(2) + ' ريال';
            document.getElementById('receiptTotalLabel').textContent = 'الإجمالي النهائي: ' + total.toFixed(2) + ' ريال';

            document.getElementById('returnReceipt').style.display = 'block';
        } catch (e) {
            console.error(e);
        }
    }

    function printReturnReceipt() {
        if (!document.getElementById('returnReceipt') || document.getElementById('returnReceipt').style.display === 'none') {
            showToast('لا توجد فاتورة مرتجع جاهزة للطباعة.', 'error');
            return;
        }
        window.print();
    }

    window.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().slice(0, 10);
        const from = document.getElementById('filterFrom');
        const to = document.getElementById('filterTo');
        if (from && to) {
            from.value = today;
            to.value = today;
        }
        loadInvoices();
    });
</script>
</body>
</html>
