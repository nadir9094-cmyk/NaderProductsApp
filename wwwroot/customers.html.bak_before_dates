<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¤Ø¬Ù„</title>

    <style>
        :root {
            --bg-body:#f5f7fb;
            --bg-card:#ffffff;
            --border:#e1e5f0;
            --primary:#246bce;
            --primary-soft:#e3efff;
            --warning:#ff9f1c;
            --success:#21a366;
            --danger:#e55353;
            --text:#1f2933;
            --muted:#76829a;
            --radius:18px;
            --shadow:0 6px 18px rgba(15,23,42,0.06);
        }
        *{box-sizing:border-box;}
        body{
            margin:0;
            padding:20px;
            background:var(--bg-body);
            font-family:"Tahoma","Segoe UI",sans-serif;
            color:var(--text);
        }
        .page{max-width:1400px;margin:0 auto;}

        .top-bar{
            display:flex;
            align-items:center;
            gap:10px;
            margin-bottom:14px;
            flex-wrap:wrap;
        }
        button,a.button-link{
            border:none;
            border-radius:999px;
            padding:8px 18px;
            font-size:14px;
            cursor:pointer;
            font-family:inherit;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            white-space:nowrap;
            text-decoration:none;
        }
        .btn-link{background:#fff;border:1px solid var(--border);color:var(--primary);text-decoration:none;}
        .btn-orange{background:var(--warning);color:#fff;}
        .btn-blue{background:var(--primary);color:#fff;}
        .btn-green{background:var(--success);color:#fff;}
        .btn-gray{background:#e5e7f0;color:var(--text);}
        .btn-outline{background:#fff;border:1px solid var(--border);color:var(--text);}

        .page-header{
            display:flex;
            justify-content:center;
            align-items:center;
            margin-bottom:16px;
            position:relative;
        }
        .page-header h1{
            margin:0;
            font-size:24px;
            font-weight:700;
        }
        .user-icon{
            position:absolute;
            left:0;
            width:44px;
            height:44px;
            border-radius:50%;
            background:#4b2f93;
            color:#fff;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:22px;
            box-shadow:var(--shadow);
        }

        .summary-row{
            display:grid;
            grid-template-columns:repeat(4,minmax(0,1fr));
            gap:12px;
            margin-bottom:14px;
        }
        .summary-card{
            background:var(--bg-card);
            border-radius:var(--radius);
            padding:14px 18px;
            box-shadow:var(--shadow);
        }
        .summary-title{
            font-size:14px;
            color:var(--muted);
            margin-bottom:6px;
        }
        .summary-value{
            font-size:20px;
            font-weight:700;
        }

        .filters-row{
            background:var(--bg-card);
            border-radius:var(--radius);
            padding:10px 16px;
            box-shadow:var(--shadow);
            margin-bottom:12px;
        }
        .filters-grid{
            display:grid;
            grid-template-columns:1.2fr 1.2fr 1fr 1fr 1fr auto;
            gap:8px;
            align-items:center;
        }
        .input-pill, select{
            width:100%;
            border-radius:999px;
            border:1px solid var(--border);
            padding:6px 12px;
            font-size:13px;
            background:#fff;
        }
        .filters-bottom{
            margin-top:8px;
            display:flex;
            gap:8px;
            flex-wrap:wrap;
            align-items:center;
            justify-content:flex-start;
        }

        .customers-toolbar{
            margin-top:10px;
            margin-bottom:10px;
            background:var(--bg-card);
            border-radius:var(--radius);
            padding:10px 16px;
            box-shadow:var(--shadow);
            display:flex;
            gap:10px;
            align-items:center;
        }
        .amount-label{font-size:14px;color:var(--muted);}
        .amount-value{font-size:17px;font-weight:700;}
        .counter-btn{
            width:26px;
            height:26px;
            border-radius:50%;
            border:1px solid var(--border);
            background:#fff;
            font-size:18px;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .client-selected{
            margin-right:auto;
            display:flex;
            align-items:center;
            gap:6px;
            font-size:13px;
        }
        .client-selected .label{color:var(--muted);}
        .client-selected .name{font-weight:600;}

        .table-card{
            background:var(--bg-card);
            border-radius:var(--radius);
            box-shadow:var(--shadow);
            overflow:hidden;
        }
        table{
            width:100%;
            border-collapse:collapse;
            font-size:14px;
        }
        thead{background:var(--primary-soft);}
        th,td{
            padding:10px 12px;
            text-align:center;
            border-bottom:1px solid var(--border);
        }
        th{font-weight:600;color:var(--text);}
        tbody tr:hover{background:#f3f6ff;}
        .badge{
            padding:3px 9px;
            border-radius:999px;
            font-size:12px;
        }
        .badge-ok{background:#e7f9f0;color:#0d8a4b;}
        .badge-late{background:#fff3cd;color:#b58900;}
        .badge-danger{background:#fde2e1;color:#b42318;}
        .badge-suspended{background:#f4e3ff;color:#6b21a8;}

        .action-btn{
            padding:4px 10px;
            border-radius:999px;
            border:1px solid var(--border);
            background:#fff;
            font-size:12px;
            cursor:pointer;
            margin:0 2px;
        }

        /* Modals */
        .modal-backdrop{
            position:fixed;
            inset:0;
            background:rgba(15,23,42,0.35);
            display:none;
            justify-content:center;
            align-items:center;
            z-index:50;
        }
        .modal{
            background:#fff;
            border-radius:18px;
            box-shadow:var(--shadow);
            padding:16px 18px;
            max-width:620px;
            width:95%;
            max-height:80vh;
            overflow-y:auto;
        }
        .modal-wide{max-width:900px;}
        .modal-header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:10px;
        }
        .modal-title{font-size:16px;font-weight:700;}
        .close-btn{
            width:26px;
            height:26px;
            border-radius:50%;
            border:none;
            background:#e5e7f0;
            cursor:pointer;
        }
        .modal-body{
            display:grid;
            gap:8px;
        }
        .field{
            display:flex;
            flex-direction:column;
            gap:3px;
        }
        .field label{
            font-size:13px;
            color:var(--muted);
        }
        .field input, .field textarea, .field select{
            border-radius:10px;
            border:1px solid var(--border);
            padding:6px 10px;
            font-size:13px;
            font-family:inherit;
        }
        .field textarea{min-height:60px;resize:vertical;}
        .modal-footer{
            margin-top:10px;
            display:flex;
            gap:8px;
            justify-content:flex-start;
            flex-wrap:wrap;
        }

        /* Payments modal (bottom sheet) */
        .payments-modal-backdrop{
            position:fixed;
            inset:0;
            pointer-events:none;
            z-index:60;
        }
        .payments-modal{
            position:fixed;
            bottom:20px;
            left:50%;
            transform:translateX(-50%);
            width:520px;
            max-width:95vw;
            background:#fff;
            border-radius:18px;
            box-shadow:0 10px 30px rgba(15,23,42,0.35);
            padding:14px 16px;
            display:none;
        }
        .payments-list{
            max-height:55vh;
            overflow-y:auto;
            margin-top:6px;
            border-top:1px solid var(--border);
            padding-top:6px;
        }
        .payment-row{
            display:grid;
            grid-template-columns:1fr 1.2fr auto;
            gap:6px;
            align-items:center;
            padding:4px 0;
            border-bottom:1px dashed #e5e7f0;
        }
        .payment-row:last-child{border-bottom:none;}

        /* Invoice items modal */
        .invoice-items-modal .modal{
            max-width:900px;
        }

        @media(max-width:900px){
            .summary-row{grid-template-columns:repeat(2,minmax(0,1fr));}
            .filters-grid{grid-template-columns:1fr 1fr;}
            .customers-toolbar{flex-direction:column;align-items:flex-start;}
        }
        @media(max-width:600px){
            .summary-row{grid-template-columns:1fr;}
            .filters-grid{grid-template-columns:1fr;}
        }
    </style>
</head>
<body>
<div class="page">

    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="top-bar">
        <a href="index.html" class="btn-link">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <button class="btn-blue" id="btnPrintReport">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø«)</button>
        <button class="btn-green" id="btnAddCustomer">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn-orange" id="btnShowAllCustomers">ğŸ‘¥ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
        <button class="btn-gray" id="btnShowPaidCustomers">âœ” Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯</button>
    </div>

    <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
    <div class="page-header">
        <h1>Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¤Ø¬Ù„</h1>
        <div class="user-icon">ğŸ‘¤</div>
    </div>

    <!-- Ù…Ù„Ø®Øµ -->
    <div class="summary-row">
        <div class="summary-card">
            <div class="summary-title">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø«)</div>
            <div class="summary-value" id="summaryCount">0</div>
        </div>
        <div class="summary-card">
            <div class="summary-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©</div>
            <div class="summary-value"><span id="summaryDeferred">0.00</span> Ø±.Ø³</div>
        </div>
        <div class="summary-card">
            <div class="summary-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</div>
            <div class="summary-value"><span id="summaryPaid">0.00</span> Ø±.Ø³</div>
        </div>
        <div class="summary-card">
            <div class="summary-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
            <div class="summary-value"><span id="summaryRemaining">0.00</span> Ø±.Ø³</div>
        </div>
    </div>

    <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« -->
    <div class="filters-row">
        <div class="filters-grid">
            <input class="input-pill" id="filterName" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
            <input class="input-pill" id="filterPhone" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <input type="date" class="input-pill" id="filterFromDate">
            <input type="date" class="input-pill" id="filterToDate">
            <select id="filterStatus" class="input-pill">
                <option value="all">Ø§Ù„Ø­Ø§Ù„Ø© (Ø§Ù„ÙƒÙ„)</option>
                <option value="has_debt">Ø¹Ù„ÙŠÙ‡ Ù…Ø¨Ø§Ù„Øº</option>
                <option value="late">Ù…ØªØ¹Ø«Ø±</option>
                <option value="paid">Ù…Ø³Ø¯Ø¯ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
            </select>
            <button class="btn-gray" id="btnResetFilters">ØªØµÙÙŠØ© / Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«</button>
        </div>
        <div class="filters-bottom">
            <span style="font-size:12px;color:var(--muted);">
                Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø¯Ù†Ø§Ù‡ ÙŠØ¹Ø±Ø¶ ÙÙ‚Ø· Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ø¹Ù„ÙŠÙ‡Ù… Ù…Ø¨Ø§Ù„Øº Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ±.
            </span>
        </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø± -->
    <div class="customers-toolbar">
        <span class="amount-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±:</span>
        <span class="amount-value"><span id="selectedRemaining">0.00</span> Ø±.Ø³</span>

        <button class="counter-btn" id="btnQuickPay">+</button>

        <div class="client-selected">
            <span>ğŸ“‹</span>
            <span class="label">Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„ÙƒØ§Ø´ÙŠØ±:</span>
            <span class="name" id="selectedCustomerName">â€”</span>
        </div>

        <button class="btn-outline" id="btnFromCashier">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ± (Ù„Ø§Ø­Ù‚Ø§Ù‹)</button>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ø¹Ù„ÙŠÙ‡Ù… Ù…Ø¨Ø§Ù„Øº -->
    <div class="table-card">
        <table>
            <thead>
            <tr>
                <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                <th>Ø¢Ø®Ø± Ø­Ø±ÙƒØ©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
            </thead>
            <tbody id="customersTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…ÙŠÙ„ -->
<div class="modal-backdrop" id="customerModalBackdrop">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="customerModalTitle">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</div>
            <button class="close-btn" data-close="customerModalBackdrop">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="field">
                <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                <input id="custName">
            </div>
            <div class="field">
                <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                <input id="custPhone">
            </div>
            <div class="field">
                <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                <input id="custAddress">
            </div>
            <div class="field">
                <label>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ (Ù…Ø¨Ù„Øº Ù…Ø¤Ø¬Ù„ ÙŠØ¨Ø¯Ø£ Ø¨Ù‡ Ø§Ù„Ø¹Ù…ÙŠÙ„)</label>
                <input id="custOpeningBalance" type="number" step="0.01" value="0">
            </div>
            <div class="field">
                <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                <select id="custStatus">
                    <option value="active">Ù†Ø´Ø·</option>
                    <option value="suspended_temp">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</option>
                    <option value="suspended_perm">Ø¥ÙŠÙ‚Ø§Ù Ø¯Ø§Ø¦Ù…</option>
                </select>
            </div>
            <div class="field">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <textarea id="custNotes"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-green" id="btnSaveCustomer">Ø­ÙØ¸</button>
            <button class="btn-gray" data-close="customerModalBackdrop">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
<div class="modal-backdrop" id="allCustomersModalBackdrop">
    <div class="modal modal-wide">
        <div class="modal-header">
            <div class="modal-title">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (ØªØ¹Ø¯ÙŠÙ„ / Ù…Ø¨Ø§Ù„Øº / Ø¥ÙŠÙ‚Ø§Ù / ØªÙØ¹ÙŠÙ„ / Ø­Ø°Ù)</div>
            <button class="close-btn" data-close="allCustomersModalBackdrop">âœ•</button>
        </div>
        <div class="modal-body" style="padding-top:4px;">
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
                <input id="allCustFilterName" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" style="flex:1 1 180px;border-radius:999px;border:1px solid #e5e7eb;padding:6px 10px;font-size:13px;">
                <input id="allCustFilterPhone" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" style="flex:1 1 180px;border-radius:999px;border:1px solid #e5e7eb;padding:6px 10px;font-size:13px;">
                <button class="btn-gray" id="btnResetAllCustomersFilter">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</button>
            </div>
            <table style="width:100%;border-collapse:collapse;font-size:13px;">
                <thead>
                <tr style="background:#f3f4f6;">
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
                </thead>
                <tbody id="allCustomersTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯ -->
<div class="modal-backdrop" id="paidCustomersModalBackdrop">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØªÙ… Ø³Ø¯Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div>
            <button class="close-btn" data-close="paidCustomersModalBackdrop">âœ•</button>
        </div>
        <div class="modal-body">
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
                <input id="paidCustFilterName" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" style="flex:1 1 160px;border-radius:999px;border:1px solid #e5e7eb;padding:6px 10px;font-size:13px;">
                <input id="paidCustFilterPhone" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" style="flex:1 1 160px;border-radius:999px;border:1px solid #e5e7eb;padding:6px 10px;font-size:13px;">
                <button class="btn-gray" id="btnResetPaidCustomersFilter">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«</button>
            </div>
            <table style="width:100%;border-collapse:collapse;font-size:13px;">
                <thead>
                <tr style="background:#f3f4f6;">
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø¢Ø®Ø± Ø­Ø±ÙƒØ©</th>
                </tr>
                </thead>
                <tbody id="paidCustomersTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© ÙÙˆØ§ØªÙŠØ± Ø¹Ù…ÙŠÙ„ -->
<div class="modal-backdrop" id="invoicesModalBackdrop">
    <div class="modal modal-wide">
        <div class="modal-header">
            <div class="modal-title" id="invoicesModalTitle">ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
            <button class="close-btn" data-close="invoicesModalBackdrop">âœ•</button>
        </div>
        <div class="modal-body">
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px;align-items:center;">
                <input type="date" id="invFilterFrom" class="input-pill" style="max-width:180px;">
                <input type="date" id="invFilterTo" class="input-pill" style="max-width:180px;">
                <button class="btn-gray" id="btnFilterInvoices">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØªØ±Ø©</button>
                <button class="btn-blue" id="btnPrintInvoices">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ (ÙˆØ±Ù‚Ø© ÙƒØ§Ø´ÙŠØ±)</button>
                <button class="btn-orange" id="btnPrintInvoiceItemsReport">ğŸ§¾ Ø·Ø¨Ø§Ø¹Ø© Ù…ÙˆØ§Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
            </div>
            <table style="width:100%;border-collapse:collapse;font-size:13px;">
                <thead>
                <tr style="background:#f3f4f6;">
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„ÙˆÙ‚Øª</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„ÙˆØµÙ</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø¹Ø±Ø¶ Ù…ÙˆØ§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                </tr>
                </thead>
                <tbody id="invoicesTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯ÙØ¹Ø§Øª (Ø£Ø³ÙÙ„ Ø§Ù„Ø´Ø§Ø´Ø©) -->
<div class="payments-modal-backdrop" id="paymentsBackdrop">
    <div class="payments-modal" id="paymentsModal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
            <div style="font-weight:700;font-size:14px;">
                Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù„Ù„Ø¹Ù…ÙŠÙ„: <span id="paymentsCustomerName"></span>
            </div>
            <button class="close-btn" id="btnClosePayments">âœ•</button>
        </div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:4px;">
            Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="paymentsRemaining">0.00</span> Ø±.Ø³
        </div>

        <div style="display:flex;gap:6px;margin-bottom:6px;flex-wrap:wrap;align-items:center;">
            <input type="date" id="paymentFilterFrom" style="flex:1 1 120px;border-radius:10px;border:1px solid var(--border);padding:5px 8px;font-size:13px;">
            <input type="date" id="paymentFilterTo" style="flex:1 1 120px;border-radius:10px;border:1px solid var(--border);padding:5px 8px;font-size:13px;">
            <button class="btn-gray" id="btnApplyPaymentFilter">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØªØ±Ø©</button>
            <button class="btn-blue" id="btnPrintPaymentsReport">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙØ¹Ø§Øª</button>
        </div>

        <div style="display:flex;gap:6px;margin-bottom:6px;flex-wrap:wrap;">
            <input type="number" step="0.01" id="paymentAmount" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹" style="flex:1 1 80px;border-radius:10px;border:1px solid var(--border);padding:5px 8px;font-size:13px;">
            <select id="paymentMethod" style="flex:0 0 110px;border-radius:10px;border:1px solid var(--border);padding:5px 8px;font-size:13px;">
                <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
                <option value="Ø´Ø¨ÙƒØ©">Ø´Ø¨ÙƒØ©</option>
            </select>
            <input type="text" id="paymentNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="flex:1 1 120px;border-radius:10px;border:1px solid var(--border);padding:5px 8px;font-size:13px;">
            <button class="btn-green" id="btnAddPaymentQuick">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
        <div class="payments-list" id="paymentsList"></div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ù…ÙˆØ§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div class="modal-backdrop invoice-items-modal" id="invoiceItemsModalBackdrop">
    <div class="modal modal-wide">
        <div class="modal-header">
            <div class="modal-title" id="invoiceItemsModalTitle">Ù…ÙˆØ§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</div>
            <button class="close-btn" data-close="invoiceItemsModalBackdrop">âœ•</button>
        </div>
        <div class="modal-body">
            <table style="width:100%;border-collapse:collapse;font-size:13px;text-align:center;">
                <thead>
                <tr style="background:#f3f4f6;">
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„Ø³Ø¹Ø± Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                    <th style="padding:6px 8px;border-bottom:1px solid #e5e7eb;">Ø§Ù„Ø®ØµÙ…</th>
                </tr>
                </thead>
                <tbody id="invoiceItemsTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// =================== Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø§Ù…Ø© Ù…Ù† Ø§Ù„Ù€ API ===================
let customersData = [];
let selectedCustomerId = null;
let currentInvoicesCustomerId = null;
let currentPaymentsCustomerId = null;
let editingCustomerId = null;

// --------- API Helpers ----------
async function apiJson(url, options = {}) {
    const opts = {
        headers: { "Content-Type": "application/json" },
        ...options
    };
    const res = await fetch(url, opts);
    if (!res.ok) {
        let msg = "";
        try { msg = await res.text(); } catch {}
        throw new Error(msg || ("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + res.status));
    }
    try {
        return await res.json();
    } catch {
        return null;
    }
}

async function loadCustomersFromApi() {
    try {
        const res = await fetch("/api/customers/full");
        if (!res.ok) throw new Error();
        customersData = await res.json();
        renderMainTable();
        renderAllCustomersModal();
        if (currentPaymentsCustomerId) renderPaymentsList();
    } catch (e) {
        console.error(e);
        alert("ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.\\nØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
    }
}

// =================== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ===================
function formatAmount(v){ return (v || 0).toFixed(2); }

function parseDate(value){
    return value ? new Date(value) : null;
}

function getCustomerById(id){
    return customersData.find(c=>c.id===id) || null;
}

function getCustomerInvoices(id){
    const c = getCustomerById(id);
    return c && Array.isArray(c.invoices) ? c.invoices : [];
}

function getCustomerPayments(id){
    const c = getCustomerById(id);
    return c && Array.isArray(c.payments) ? c.payments : [];
}

function getCustomerTotals(cOrId){
    let c = typeof cOrId === "number" ? getCustomerById(cOrId) : cOrId;
    if (!c) return { invoicesTotal:0, paymentsTotal:0, remaining:0 };
    if (typeof c.invoicesTotal === "number" && typeof c.paymentsTotal === "number" && typeof c.remaining === "number") {
        return {
            invoicesTotal: c.invoicesTotal,
            paymentsTotal: c.paymentsTotal,
            remaining: c.remaining
        };
    }
    const invList = getCustomerInvoices(c.id);
    const payList = getCustomerPayments(c.id);
    const invoicesTotal = invList.reduce((s,x)=>s+(x.amount||0),0);
    const paymentsTotal = payList.reduce((s,x)=>s+(x.amount||0),0);
    return {
        invoicesTotal,
        paymentsTotal,
        remaining: invoicesTotal - paymentsTotal
    };
}

function getCustomerStatusType(c){
    const totals = getCustomerTotals(c);
    if (totals.remaining <= 0.001) return "paid";
    const inv = getCustomerInvoices(c.id);
    if (!inv.length) return "has_debt";
    const lastDate = inv.reduce((max,x)=>{
        const d = new Date(x.date);
        return d>max?d:max;
    }, new Date(0));
    const diffDays = (Date.now() - lastDate.getTime()) / (1000*60*60*24);
    if (diffDays > 30) return "late";
    return "has_debt";
}

// =================== Ù…Ù„Ø®Øµ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø« ===================
function updateSummary(filteredCustomers){
    let totalInv=0,totalPay=0,remaining=0,count=0;
    filteredCustomers.forEach(c=>{
        const t = getCustomerTotals(c);
        totalInv += t.invoicesTotal;
        totalPay += t.paymentsTotal;
        remaining += t.remaining;
        count++;
    });
    document.getElementById("summaryCount").textContent = count;
    document.getElementById("summaryDeferred").textContent = formatAmount(totalInv);
    document.getElementById("summaryPaid").textContent = formatAmount(totalPay);
    document.getElementById("summaryRemaining").textContent = formatAmount(remaining);
}

// =================== ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ± ===================
function applyFilters(includePaid=false){
    const name = document.getElementById("filterName").value.trim();
    const phone = document.getElementById("filterPhone").value.trim();
    const fromDate = parseDate(document.getElementById("filterFromDate").value);
    const toDate   = parseDate(document.getElementById("filterToDate").value);
    const status   = document.getElementById("filterStatus").value;

    let result = customersData.slice();

    if (name){
        result = result.filter(c=>c.name && c.name.includes(name));
    }
    if (phone){
        result = result.filter(c=>c.phone && c.phone.includes(phone));
    }

    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù…Ù† Ø§Ù„ÙÙˆØ§ØªÙŠØ±
    result = result.filter(c=>{
        const invList = getCustomerInvoices(c.id);
        if (!invList.length) return false;
        let hasInRange = false;
        invList.forEach(i=>{
            const d = new Date(i.date);
            if (fromDate && d < fromDate) return;
            if (toDate && d > toDate) return;
            hasInRange = true;
        });
        return hasInRange;
    });

    if (status !== "all"){
        result = result.filter(c=>getCustomerStatusType(c)===status);
    }

    if (!includePaid){
        result = result.filter(c=>getCustomerTotals(c).remaining > 0.001);
    }

    return result;
}

// =================== Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ===================
function renderMainTable(){
    const tbody = document.getElementById("customersTableBody");
    tbody.innerHTML = "";
    const filtered = applyFilters(false);

    if (!filtered.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 8;
        td.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ø¹Ù„ÙŠÙ‡Ù… Ù…Ø¨Ø§Ù„Øº Ø­Ø³Ø¨ Ø´Ø±ÙˆØ· Ø§Ù„Ø¨Ø­Ø«.";
        td.style.padding = "40px";
        td.style.color = "#6b7280";
        tr.appendChild(td);
        tbody.appendChild(tr);
        updateSummary(filtered);
        updateSelectedSummary();
        return;
    }

    filtered.forEach(c=>{
        const totals = getCustomerTotals(c);
        const statusType = getCustomerStatusType(c);

        const tr = document.createElement("tr");
        if (c.id === selectedCustomerId){
            tr.style.backgroundColor = "#eef2ff";
        }

        function addTd(text){
            const td = document.createElement("td");
            td.textContent = text;
            tr.appendChild(td);
        }

        addTd(c.name || "");
        addTd(c.phone || "-");

        const statusTd = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = "badge";
        if (c.status === "suspended_perm"){
            badge.classList.add("badge-suspended");
            badge.textContent = "Ù…ÙˆÙ‚ÙˆÙ Ø¯Ø§Ø¦Ù…Ù‹Ø§";
        }else if (c.status === "suspended_temp"){
            badge.classList.add("badge-suspended");
            badge.textContent = "Ù…ÙˆÙ‚ÙˆÙ Ù…Ø¤Ù‚ØªÙ‹Ø§";
        }else if (statusType === "late"){
            badge.classList.add("badge-danger");
            badge.textContent = "Ù…ØªØ¹Ø«Ø±";
        }else{
            badge.classList.add("badge-late");
            badge.textContent = "Ø¹Ù„ÙŠÙ‡ Ù…Ø¨Ø§Ù„Øº";
        }
        statusTd.appendChild(badge);
        tr.appendChild(statusTd);

        addTd(formatAmount(totals.invoicesTotal));
        addTd(formatAmount(totals.paymentsTotal));
        addTd(formatAmount(totals.remaining));

        const invList = getCustomerInvoices(c.id);
        let lastMove = "-";
        if (invList.length){
            const last = invList.reduce((max,x)=>{
                const d = new Date(x.date);
                return d>max?d:max;
            }, new Date(0));
            lastMove = last.toLocaleDateString("ar-SA") + " " +
                       last.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"});
        }
        addTd(lastMove);

        const actionsTd = document.createElement("td");
        const btnSelect = document.createElement("button");
        btnSelect.className = "action-btn";
        btnSelect.textContent = "Ø§Ø®ØªÙŠØ§Ø±";
        btnSelect.onclick = ()=>{ selectedCustomerId = c.id; updateSelectedSummary(); renderMainTable(); };

        const btnInvoices = document.createElement("button");
        btnInvoices.className = "action-btn";
        btnInvoices.textContent = "Ø§Ù„ÙÙˆØ§ØªÙŠØ±";
        btnInvoices.onclick = ()=>openInvoicesModal(c.id);

        const btnPayments = document.createElement("button");
        btnPayments.className = "action-btn";
        btnPayments.textContent = "Ø§Ù„Ø³Ø¯Ø§Ø¯";
        btnPayments.onclick = ()=>openPaymentsModal(c.id);

        actionsTd.appendChild(btnSelect);
        actionsTd.appendChild(btnInvoices);
        actionsTd.appendChild(btnPayments);

        tr.appendChild(actionsTd);
        tbody.appendChild(tr);
    });

    updateSummary(filtered);
    updateSelectedSummary();
}

function updateSelectedSummary(){
    const nameEl = document.getElementById("selectedCustomerName");
    const remEl  = document.getElementById("selectedRemaining");
    if (!selectedCustomerId){
        nameEl.textContent = "â€”";
        remEl.textContent = "0.00";
        return;
    }
    const c = getCustomerById(selectedCustomerId);
    if (!c){
        nameEl.textContent = "â€”";
        remEl.textContent = "0.00";
        return;
    }
    const totals = getCustomerTotals(c);
    nameEl.textContent = c.name || "";
    remEl.textContent = formatAmount(totals.remaining);
}

// =================== Ù†Ø§ÙØ°Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ===================
function renderAllCustomersModal(){
    const tbody = document.getElementById("allCustomersTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    const nameFilter = (document.getElementById("allCustFilterName")?.value || "").trim();
    const phoneFilter = (document.getElementById("allCustFilterPhone")?.value || "").trim();

    let list = customersData.slice();
    if (nameFilter){
        list = list.filter(c=>c.name && c.name.includes(nameFilter));
    }
    if (phoneFilter){
        list = list.filter(c=>c.phone && c.phone.includes(phoneFilter));
    }

    list.forEach(c=>{
        const totals = getCustomerTotals(c);
        const tr = document.createElement("tr");
        function td(text){
            const cell = document.createElement("td");
            cell.style.padding = "6px 8px";
            cell.style.borderBottom = "1px solid #e5e7eb";
            cell.textContent = text;
            return cell;
        }
        tr.appendChild(td(c.name || ""));
        tr.appendChild(td(c.phone || "-"));

        const statusCell = td("");
        const statusType = getCustomerStatusType(c);
        let statusText = "Ù†Ø´Ø·";
        if (c.status === "suspended_perm") statusText = "Ù…ÙˆÙ‚ÙˆÙ Ø¯Ø§Ø¦Ù…Ù‹Ø§";
        else if (c.status === "suspended_temp") statusText = "Ù…ÙˆÙ‚ÙˆÙ Ù…Ø¤Ù‚ØªÙ‹Ø§";
        else if (statusType === "late") statusText = "Ù…ØªØ¹Ø«Ø±";
        else if (statusType === "paid") statusText = "Ù…Ø³Ø¯Ø¯";
        else statusText = "Ø¹Ù„ÙŠÙ‡ Ù…Ø¨Ø§Ù„Øº";
        statusCell.textContent = statusText;
        tr.appendChild(statusCell);

        tr.appendChild(td(formatAmount(totals.invoicesTotal)));
        tr.appendChild(td(formatAmount(totals.paymentsTotal)));
        tr.appendChild(td(formatAmount(totals.remaining)));

        const actionsCell = td("");
        const mkBtn = (txt,handler,color)=>{
            const b = document.createElement("button");
            b.textContent = txt;
            b.className = "action-btn";
            if (color) b.style.color = color;
            b.onclick = handler;
            return b;
        };
        actionsCell.appendChild(mkBtn("ØªØ¹Ø¯ÙŠÙ„", ()=>openCustomerModal(c.id)));
        actionsCell.appendChild(mkBtn("Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº", ()=>addAmountToCustomer(c.id)));
        actionsCell.appendChild(mkBtn("Ø®ØµÙ… Ù…Ø¨Ù„Øº", ()=>addPaymentToCustomerQuick(c.id)));
        actionsCell.appendChild(mkBtn(c.status==="active"?"Ø¥ÙŠÙ‚Ø§Ù":"ØªÙØ¹ÙŠÙ„", ()=>toggleCustomerStatus(c.id)));
        actionsCell.appendChild(mkBtn("Ø­Ø°Ù", ()=>deleteCustomer(c.id),"#b91c1c"));
        tr.appendChild(actionsCell);

        tbody.appendChild(tr);
    });
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº (ÙØ§ØªÙˆØ±Ø© ÙŠØ¯ÙˆÙŠØ©) Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„
async function addAmountToCustomer(id){
    const c = getCustomerById(id);
    if (!c) return;
    const val = prompt("Ù…Ø¨Ù„Øº Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ (ÙŠØ²ÙŠØ¯ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø¤Ø¬Ù„Ø©):","0");
    const amount = parseFloat(val || "0");
    if (isNaN(amount) || amount<=0) return;
    const desc = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ / ÙˆØµÙ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:","ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ ÙŠØ¯ÙˆÙŠ") || "ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ ÙŠØ¯ÙˆÙŠ";

    try{
        await apiJson(`/api/customers/${id}/invoices`, {
            method:"POST",
            body: JSON.stringify({
                amount,
                description: desc,
                invoiceDate: null
            })
        });
        await loadCustomersFromApi();
    }catch(e){
        alert(e.message);
    }
}

// Ø®ØµÙ… Ù…Ø¨Ù„Øº (ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø³Ø±ÙŠØ¹Ø© Ù…Ù† Ø¥Ø·Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡)
async function addPaymentToCustomerQuick(id){
    const c = getCustomerById(id);
    if (!c) return;
    const totals = getCustomerTotals(c);
    const val = prompt("Ù…Ø¨Ù„Øº Ø³ÙŠØªÙ… Ø®ØµÙ…Ù‡ (ÙƒØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„)ØŒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ "+formatAmount(totals.remaining)+" Ø±.Ø³:","0");
    const amount = parseFloat(val || "0");
    if (isNaN(amount) || amount<=0) return;
    const method = prompt("Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ (ÙƒØ§Ø´ / Ø´Ø¨ÙƒØ©):","ÙƒØ§Ø´") || "ÙƒØ§Ø´";
    const note = prompt("Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¯ÙØ¹:","Ø¯ÙØ¹Ø© Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡") || "";

    try{
        await apiJson(`/api/customers/${id}/payments`, {
            method:"POST",
            body: JSON.stringify({
                amount,
                method,
                note,
                paymentDate: null
            })
        });
        await loadCustomersFromApi();
    }catch(e){
        alert(e.message);
    }
}

// ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
async function toggleCustomerStatus(id){
    const c = getCustomerById(id);
    if (!c) return;
    let newStatus = "active";
    if (c.status === "active"){
        const type = prompt("Ù†ÙˆØ¹ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù: 1=Ù…Ø¤Ù‚Øª, 2=Ø¯Ø§Ø¦Ù…","1");
        newStatus = (type === "2") ? "suspended_perm" : "suspended_temp";
    }else{
        newStatus = "active";
    }
    try{
        await fetch(`/api/customers/${id}/status?status=${encodeURIComponent(newStatus)}`, { method:"POST" });
        await loadCustomersFromApi();
    }catch(e){
        alert("ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„.");
    }
}

// Ø­Ø°Ù Ø¹Ù…ÙŠÙ„
async function deleteCustomer(id){
    const c = getCustomerById(id);
    if (!c) return;
    if (!confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§ØªÙ‡ (Ø¥Ù† ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø­Ø°Ù)ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;

    try{
        const res = await fetch(`/api/customers/${id}`, { method:"DELETE" });
        if (!res.ok){
            let msg = "";
            try { msg = await res.text(); } catch {}
            alert(msg || "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„.");
            return;
        }
        if (selectedCustomerId === id) selectedCustomerId = null;
        await loadCustomersFromApi();
    }catch(e){
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„.");
    }
}

// =================== Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¹Ø§Ù…Ø© ===================
function openModal(id){ document.getElementById(id).style.display="flex"; }
function closeModal(id){ document.getElementById(id).style.display="none"; }

// Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„)
function openCustomerModal(id){
    editingCustomerId = id || null;
    const title = document.getElementById("customerModalTitle");
    const name = document.getElementById("custName");
    const phone = document.getElementById("custPhone");
    const address = document.getElementById("custAddress");
    const opening = document.getElementById("custOpeningBalance");
    const notes = document.getElementById("custNotes");
    const status = document.getElementById("custStatus");

    if (editingCustomerId){
        const c = getCustomerById(editingCustomerId);
        if (!c) return;
        title.textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„";
        name.value = c.name || "";
        phone.value = c.phone || "";
        address.value = c.address || "";
        notes.value = c.notes || "";
        status.value = c.status || "active";
        opening.value = "0";
    }else{
        title.textContent = "Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯";
        name.value = "";
        phone.value = "";
        address.value = "";
        notes.value = "";
        status.value = "active";
        opening.value = "0";
    }

    openModal("customerModalBackdrop");
}

async function saveCustomerFromModal(){
    const name = document.getElementById("custName").value.trim();
    const phone = document.getElementById("custPhone").value.trim();
    const address = document.getElementById("custAddress").value.trim();
    const opening = parseFloat(document.getElementById("custOpeningBalance").value || "0");
    const notes = document.getElementById("custNotes").value.trim();
    const status = document.getElementById("custStatus").value;

    if (!name){
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„");
        return;
    }

    const payload = {
        name,
        phone: phone || null,
        address: address || null,
        notes: notes || null,
        status,
        openingBalance: isNaN(opening) ? 0 : opening
    };

    try{
        if (editingCustomerId){
            await apiJson(`/api/customers/${editingCustomerId}`, {
                method:"PUT",
                body: JSON.stringify(payload)
            });
        }else{
            await apiJson("/api/customers", {
                method:"POST",
                body: JSON.stringify(payload)
            });
        }
        closeModal("customerModalBackdrop");
        await loadCustomersFromApi();
    }catch(e){
        alert(e.message);
    }
}

// =================== Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯ ===================
function renderPaidCustomersModal(){
    const tbody = document.getElementById("paidCustomersTableBody");
    tbody.innerHTML = "";

    const nameFilter = (document.getElementById("paidCustFilterName")?.value || "").trim();
    const phoneFilter = (document.getElementById("paidCustFilterPhone")?.value || "").trim();

    const list = customersData.filter(c=>getCustomerTotals(c).remaining<=0.001);
    let filtered = list;
    if (nameFilter){
        filtered = filtered.filter(c=>c.name && c.name.includes(nameFilter));
    }
    if (phoneFilter){
        filtered = filtered.filter(c=>c.phone && c.phone.includes(phoneFilter));
    }

    if (!filtered.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³Ø¯Ø¯ÙŠÙ† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø«.";
        td.style.padding = "20px";
        td.style.color = "#6b7280";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
    }

    filtered.forEach(c=>{
        const tr = document.createElement("tr");
        function td(text){
            const cell=document.createElement("td");
            cell.style.padding="6px 8px";
            cell.style.borderBottom="1px solid #e5e7eb";
            cell.textContent=text;
            return cell;
        }
        tr.appendChild(td(c.name || ""));
        tr.appendChild(td(c.phone || "-"));
        const invList = getCustomerInvoices(c.id);
        let lastMove="-";
        if (invList.length){
            const last = invList.reduce((max,x)=>{
                const d=new Date(x.date);
                return d>max?d:max;
            }, new Date(0));
            lastMove = last.toLocaleDateString("ar-SA")+" "+last.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"});
        }
        tr.appendChild(td(lastMove));
        tbody.appendChild(tr);
    });
}

function openPaidCustomersModal(){
    renderPaidCustomersModal();
    openModal("paidCustomersModalBackdrop");
}

// =================== ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ ===================
function openInvoicesModal(customerId){
    currentInvoicesCustomerId = customerId;
    const c = getCustomerById(customerId);
    document.getElementById("invoicesModalTitle").textContent = "ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„: " + (c?c.name:"");
    document.getElementById("invFilterFrom").value = "";
    document.getElementById("invFilterTo").value = "";
    renderInvoicesTable();
    openModal("invoicesModalBackdrop");
}

function getFilteredInvoicesForCurrent(){
    if (!currentInvoicesCustomerId) return [];
    const from = parseDate(document.getElementById("invFilterFrom").value);
    const to   = parseDate(document.getElementById("invFilterTo").value);
    let list = getCustomerInvoices(currentInvoicesCustomerId);
    list = list.filter(i=>{
        const d=new Date(i.date);
        if (from && d<from) return false;
        if (to && d>to) return false;
        return true;
    });
    return list;
}

// Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„Ù†ØµØŒ Ù…Ø«Ù„: "ÙØ§ØªÙˆØ±Ø© Ù…Ø¤Ø¬Ù„Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ± Ø±Ù‚Ù… 27"
function parseInvoiceNumberFromText(text){
    if (!text) return null;
    const m = text.match(/Ø±Ù‚Ù…\\s+(\\d+)/);
    return m ? parseInt(m[1],10) : null;
}

function renderInvoicesTable(){
    const tbody = document.getElementById("invoicesTableBody");
    tbody.innerHTML = "";
    if (!currentInvoicesCustomerId) return;

    const list = getFilteredInvoicesForCurrent();

    if (!list.length){
        const tr=document.createElement("tr");
        const td=document.createElement("td");
        td.colSpan=6;
        td.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.";
        td.style.padding="20px";
        td.style.color="#6b7280";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
    }

    list.forEach(i=>{
        const tr=document.createElement("tr");
        const d=new Date(i.date);
        const dateStr=d.toLocaleDateString("ar-SA");
        const timeStr=d.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"});

        const invoiceNumber = i.invoiceNumber || i.cashierInvoiceId || parseInvoiceNumberFromText(i.description) || "-";
        const numericInvoiceId = typeof invoiceNumber === "number" ? invoiceNumber : parseInvoiceNumberFromText(String(invoiceNumber)) || null;

        function cell(text){
            const td=document.createElement("td");
            td.style.padding="6px 8px";
            td.style.borderBottom="1px solid #e5e7eb";
            td.textContent=text;
            return td;
        }

        tr.appendChild(cell(dateStr));
        tr.appendChild(cell(timeStr));
        tr.appendChild(cell(invoiceNumber === "-" ? "-" : String(invoiceNumber)));
        tr.appendChild(cell(i.description || ""));

        // Ø²Ø± Ù…ÙˆØ§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
        const itemsTd = document.createElement("td");
        if (numericInvoiceId){
            const btn = document.createElement("button");
            btn.className = "action-btn";
            btn.textContent = "Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯";
            btn.onclick = ()=>openInvoiceItemsModal(numericInvoiceId, dateStr, String(invoiceNumber));
            itemsTd.appendChild(btn);
        }else{
            itemsTd.textContent = "-";
        }
        tr.appendChild(itemsTd);

        tr.appendChild(cell(formatAmount(i.amount)));
        tbody.appendChild(tr);
    });
}

// Ø·Ø¨Ø§Ø¹Ø© ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø­Ø¬Ù… ÙˆØ±Ù‚Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ±
function printInvoicesForCustomer(){
    if (!currentInvoicesCustomerId) return;
    const c = getCustomerById(currentInvoicesCustomerId);
    const list = getFilteredInvoicesForCurrent();

    let html = `
    <html lang="ar" dir="rtl">
    <head><meta charset="utf-8"><title>ØªÙ‚Ø±ÙŠØ± ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</title>
    <style>
        body{font-family:"Tahoma";width:80mm;margin:0 auto;font-size:12px;}
        h2,h3{text-align:center;margin:4px 0;}
        .line{border-top:1px dashed #555;margin:4px 0;}
        .row{display:flex;justify-content:space-between;font-size:12px;margin:2px 0;}
        .label{color:#555;}
    </style>
    </head>
    <body>
        <h2>ØªÙ‚Ø±ÙŠØ± ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
        <h3>${c?c.name:""}</h3>
        <div class="line"></div>
    `;

    if (!list.length){
        html += `<div style="text-align:center;margin-top:10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</div>`;
    }else{
        list.forEach(i=>{
            const d=new Date(i.date);
            const dateStr=d.toLocaleDateString("ar-SA");
            const timeStr=d.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"});
            html += `
                <div class="row"><span class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span><span>${dateStr} ${timeStr}</span></div>
                <div class="row"><span class="label">Ø§Ù„ÙˆØµÙ:</span><span>${i.description || ""}</span></div>
                <div class="row"><span class="label">Ø§Ù„Ù…Ø¨Ù„Øº:</span><span>${formatAmount(i.amount)} Ø±.Ø³</span></div>
                <div class="line"></div>
            `;
        });
    }

    html += `<script>window.print();<\/script></body></html>`;

    const w = window.open("","_blank","width=400,height=600");
    w.document.write(html);
    w.document.close();
}

// ØªÙ‚Ø±ÙŠØ± Ù…ÙˆØ§Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù„ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ø§Ù„ÙØªØ±Ø©)
async function printInvoiceItemsReportForCustomer(){
    if (!currentInvoicesCustomerId) return;
    const c = getCustomerById(currentInvoicesCustomerId);
    const invoices = getFilteredInvoicesForCurrent();

    const rows = [];

    for (const inv of invoices){
        const baseNumber = inv.invoiceNumber || inv.cashierInvoiceId || parseInvoiceNumberFromText(inv.description);
        const invoiceId = baseNumber ? parseInt(baseNumber,10) : null;
        if (!invoiceId) continue;

        try{
            const res = await fetch(`/api/cashier/invoices/${invoiceId}/items`);
            if (!res.ok) continue;
            const items = await res.json();
            const d = new Date(inv.date);
            const dateStr = d.toLocaleDateString("ar-SA");
            const timeStr = d.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"});

            (items || []).forEach(it=>{
                rows.push({
                    invoiceId,
                    date: dateStr+" "+timeStr,
                    productName: it.productName || "",
                    qty: (it.qty ?? 0),
                    price: (it.price ?? 0),
                    discount: (it.discount ?? 0)
                });
            });
        }catch(e){
            console.error(e);
        }
    }

    let html = `
    <html lang="ar" dir="rtl">
    <head><meta charset="utf-8"><title>ØªÙ‚Ø±ÙŠØ± Ù…ÙˆØ§Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</title>
    <style>
        body{font-family:"Tahoma";margin:10px;font-size:12px;}
        h2,h3{text-align:center;margin:4px 0;}
        table{width:100%;border-collapse:collapse;font-size:12px;}
        th,td{border:1px solid #ccc;padding:4px 6px;text-align:center;}
        th{background:#f3f4f6;}
    </style>
    </head>
    <body>
        <h2>ØªÙ‚Ø±ÙŠØ± Ù…ÙˆØ§Ø¯ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
        <h3>${c?c.name:""}</h3>
        <p style="text-align:center;font-size:11px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ${new Date().toLocaleString("ar-SA")}</p>
        <table>
            <thead>
                <tr>
                    <th>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th>Ø§Ù„Ø³Ø¹Ø± Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©</th>
                    <th>Ø§Ù„Ø®ØµÙ…</th>
                </tr>
            </thead>
            <tbody>
    `;

    if (!rows.length){
        html += `<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</td></tr>`;
    }else{
        rows.forEach(r=>{
            html += `
                <tr>
                    <td>${r.invoiceId}</td>
                    <td>${r.date}</td>
                    <td>${r.productName}</td>
                    <td>${r.qty.toFixed(2)}</td>
                    <td>${r.price.toFixed(2)}</td>
                    <td>${r.discount.toFixed(2)}</td>
                </tr>
            `;
        });
    }

    html += `</tbody></table><script>window.print();<\/script></body></html>`;

    const w = window.open("","_blank","width=900,height=700");
    w.document.write(html);
    w.document.close();
}

// ======== Ù†Ø§ÙØ°Ø© Ù…ÙˆØ§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ù…Ù† Ø²Ø± "Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯") =========
async function openInvoiceItemsModal(invoiceId, invoiceDateText, invoiceNumberText){
    if (!invoiceId){
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© ØµØ§Ù„Ø­ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯.");
        return;
    }
    try{
        const res = await fetch(`/api/cashier/invoices/${invoiceId}/items`);
        if (!res.ok){
            alert("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…");
            return;
        }
        const items = await res.json();
        const tbody = document.getElementById("invoiceItemsTableBody");
        tbody.innerHTML = "";
        document.getElementById("invoiceItemsModalTitle").textContent =
            "Ù…ÙˆØ§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… " + invoiceId + (invoiceDateText ? " - "+invoiceDateText : "");

        if (!items || !items.length){
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 4;
            td.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.";
            tr.appendChild(td);
            tbody.appendChild(tr);
        }else{
            items.forEach(it=>{
                const tr = document.createElement("tr");

                const tdName = document.createElement("td");
                tdName.textContent = it.productName || "";
                tr.appendChild(tdName);

                const tdQty = document.createElement("td");
                tdQty.textContent = (it.qty ?? 0).toFixed(2);
                tr.appendChild(tdQty);

                const tdPrice = document.createElement("td");
                tdPrice.textContent = (it.price ?? 0).toFixed(2);
                tr.appendChild(tdPrice);

                const tdDisc = document.createElement("td");
                tdDisc.textContent = (it.discount ?? 0).toFixed(2);
                tr.appendChild(tdDisc);

                tbody.appendChild(tr);
            });
        }

        openModal("invoiceItemsModalBackdrop");
    }catch(err){
        console.error(err);
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù…ÙˆØ§Ø¯ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
    }
}

function closeInvoiceItemsModal(){
    closeModal("invoiceItemsModalBackdrop");
}

// =================== Ø§Ù„Ø¯ÙØ¹Ø§Øª ===================
function getFilteredPaymentsForCurrent(){
    if (!currentPaymentsCustomerId) return [];
    const from = parseDate(document.getElementById("paymentFilterFrom").value);
    const to   = parseDate(document.getElementById("paymentFilterTo").value);
    let list = getCustomerPayments(currentPaymentsCustomerId);
    list = list.filter(p=>{
        const d = new Date(p.date);
        if (from && d < from) return false;
        if (to && d > to) return false;
        return true;
    });
    return list;
}

function openPaymentsModal(customerId){
    currentPaymentsCustomerId = customerId;
    const c = getCustomerById(customerId);
    if (!c) return;
    document.getElementById("paymentsCustomerName").textContent = c.name || "";
    document.getElementById("paymentAmount").value = "";
    document.getElementById("paymentNote").value = "";
    document.getElementById("paymentMethod").value = "ÙƒØ§Ø´";
    document.getElementById("paymentFilterFrom").value = "";
    document.getElementById("paymentFilterTo").value = "";
    renderPaymentsList();
    document.getElementById("paymentsModal").style.display="block";
    document.getElementById("paymentsBackdrop").style.pointerEvents="auto";
}

function closePaymentsModal(){
    currentPaymentsCustomerId = null;
    document.getElementById("paymentsModal").style.display="none";
    document.getElementById("paymentsBackdrop").style.pointerEvents="none";
}

function renderPaymentsList(){
    const listContainer = document.getElementById("paymentsList");
    listContainer.innerHTML = "";
    if (!currentPaymentsCustomerId) return;
    const list = getFilteredPaymentsForCurrent();
    const totals = getCustomerTotals(currentPaymentsCustomerId);
    document.getElementById("paymentsRemaining").textContent = formatAmount(totals.remaining);

    if (!list.length){
        const div=document.createElement("div");
        div.textContent="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.";
        div.style.fontSize="13px";
        div.style.color="#6b7280";
        div.style.padding="6px 0";
        listContainer.appendChild(div);
        return;
    }

    list.forEach(p=>{
        const row=document.createElement("div");
        row.className="payment-row";
        const date=new Date(p.date);
        const info=date.toLocaleDateString("ar-SA")+" "+date.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"});
        const col1=document.createElement("div");
        col1.textContent=formatAmount(p.amount)+" Ø±.Ø³ ("+(p.method||"ÙƒØ§Ø´")+")";
        const col2=document.createElement("div");
        col2.textContent=p.note || "";
        const dateDiv=document.createElement("div");
        dateDiv.style.fontSize="11px";
        dateDiv.style.color="#6b7280";
        dateDiv.textContent=info;
        col2.appendChild(document.createElement("br"));
        col2.appendChild(dateDiv);

        const col3=document.createElement("div");
        const editBtn=document.createElement("button");
        editBtn.className="action-btn";
        editBtn.style.fontSize="11px";
        editBtn.textContent="ØªØ¹Ø¯ÙŠÙ„";
        editBtn.onclick=()=>editPayment(p.id);
        const delBtn=document.createElement("button");
        delBtn.className="action-btn";
        delBtn.style.fontSize="11px";
        delBtn.textContent="Ø­Ø°Ù";
        delBtn.onclick=()=>deletePayment(p.id);
        const printBtn=document.createElement("button");
        printBtn.className="action-btn";
        printBtn.style.fontSize="11px";
        printBtn.textContent="Ø·Ø¨Ø§Ø¹Ø© Ø¥ÙŠØµØ§Ù„";
        printBtn.onclick=()=>printPaymentReceipt(p.id);
        col3.appendChild(editBtn);
        col3.appendChild(delBtn);
        col3.appendChild(printBtn);

        row.appendChild(col1);
        row.appendChild(col2);
        row.appendChild(col3);
        listContainer.appendChild(row);
    });
}

async function addQuickPayment(){
    if (!currentPaymentsCustomerId) return;
    const amountVal=document.getElementById("paymentAmount").value;
    const note=document.getElementById("paymentNote").value;
    const method=document.getElementById("paymentMethod").value;
    const amount=parseFloat(amountVal || "0");
    if (isNaN(amount) || amount<=0){
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.");
        return;
    }
    try{
        await apiJson(`/api/customers/${currentPaymentsCustomerId}/payments`, {
            method:"POST",
            body: JSON.stringify({
                amount,
                method,
                note,
                paymentDate: null
            })
        });
        document.getElementById("paymentAmount").value = "";
        document.getElementById("paymentNote").value = "";
        await loadCustomersFromApi();
        if (currentPaymentsCustomerId) renderPaymentsList();
    }catch(e){
        alert(e.message);
    }
}

async function editPayment(id){
    const cId = currentPaymentsCustomerId;
    const list = getCustomerPayments(cId);
    const p = list.find(x=>x.id===id);
    if (!p) return;
    const val = prompt("ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø©:", formatAmount(p.amount));
    if (val===null) return;
    const amount=parseFloat(val || "0");
    if (isNaN(amount) || amount<=0) return;
    const method=prompt("ØªØ¹Ø¯ÙŠÙ„ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ (ÙƒØ§Ø´ / Ø´Ø¨ÙƒØ©):", p.method || "ÙƒØ§Ø´") || "ÙƒØ§Ø´";
    const note=prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:", p.note || "") || "";
    try{
        await apiJson(`/api/customer-payments/${id}`, {
            method:"PUT",
            body: JSON.stringify({
                amount,
                method,
                note,
                paymentDate: null
            })
        });
        await loadCustomersFromApi();
        if (currentPaymentsCustomerId) renderPaymentsList();
    }catch(e){
        alert(e.message);
    }
}

async function deletePayment(id){
    if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø©ØŸ")) return;
    try{
        await fetch(`/api/customer-payments/${id}`, { method:"DELETE" });
        await loadCustomersFromApi();
        if (currentPaymentsCustomerId) renderPaymentsList();
    }catch(e){
        alert("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©.");
    }
}

// Ø¥ÙŠØµØ§Ù„ Ø¯ÙØ¹ Ø¨Ø­Ø¬Ù… ÙˆØ±Ù‚Ø© Ø§Ù„ÙƒØ§Ø´ÙŠØ±
function printPaymentReceipt(id){
    if (!currentPaymentsCustomerId) return;
    const c = getCustomerById(currentPaymentsCustomerId);
    const list = getCustomerPayments(currentPaymentsCustomerId);
    const p = list.find(x=>x.id===id);
    if (!p) return;
    const w = window.open("", "_blank", "width=380,height=600");
    const d = new Date(p.date);
    const dateStr=d.toLocaleDateString("ar-SA");
    const timeStr=d.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"});
    w.document.write(`
        <html lang="ar" dir="rtl">
        <head><meta charset="utf-8"><title>Ø¥ÙŠØµØ§Ù„ Ø¯ÙØ¹</title>
        <style>
            body{font-family:"Tahoma";width:80mm;margin:0 auto;padding:10px;font-size:12px;}
            h2{text-align:center;margin:4px 0;}
            .row{margin-bottom:4px;font-size:12px;}
            .label{color:#6b7280;}
            .line{border-top:1px dashed #555;margin:6px 0;}
        </style>
        </head>
        <body>
            <h2>Ø¥ÙŠØµØ§Ù„ Ø¯ÙØ¹</h2>
            <div class="line"></div>
            <div class="row"><span class="label">Ø§Ù„Ø¹Ù…ÙŠÙ„:</span> ${c?c.name:""}</div>
            <div class="row"><span class="label">Ø§Ù„Ù…Ø¨Ù„Øº:</span> ${formatAmount(p.amount)} Ø±.Ø³</div>
            <div class="row"><span class="label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</span> ${p.method || "ÙƒØ§Ø´"}</div>
            <div class="row"><span class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> ${dateStr} ${timeStr}</div>
            <div class="row"><span class="label">Ù…Ù„Ø§Ø­Ø¸Ø©:</span> ${p.note || ""}</div>
            <div class="line"></div>
            <div class="row" style="text-align:center;">Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</div>
            <script>window.print();<\/script>
        </body>
        </html>
    `);
    w.document.close();
}

// ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø© (ÙˆØ±Ù‚ ÙƒØ§Ø´ÙŠØ±)
function printPaymentsReport(){
    if (!currentPaymentsCustomerId) return;
    const c = getCustomerById(currentPaymentsCustomerId);
    const list = getFilteredPaymentsForCurrent();

    let html = `
        <html lang="ar" dir="rtl">
        <head><meta charset="utf-8"><title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙØ¹Ø§Øª</title>
        <style>
            body{font-family:"Tahoma";width:80mm;margin:0 auto;padding:10px;font-size:12px;}
            h2,h3{text-align:center;margin:4px 0;}
            .line{border-top:1px dashed #555;margin:4px 0;}
            .row{display:flex;justify-content:space-between;font-size:12px;margin:2px 0;}
            .label{color:#555;}
        </style>
        </head>
        <body>
            <h2>ØªÙ‚Ø±ÙŠØ± Ø¯ÙØ¹Ø§Øª Ø¹Ù…ÙŠÙ„</h2>
            <h3>${c?c.name:""}</h3>
            <div class="line"></div>
    `;

    if (!list.length){
        html += `<div style="text-align:center;margin-top:10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.</div>`;
    }else{
        list.forEach(p=>{
            const d=new Date(p.date);
            const dateStr=d.toLocaleDateString("ar-SA");
            const timeStr=d.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"});
            html += `
                <div class="row"><span class="label">Ø§Ù„Ù…Ø¨Ù„Øº:</span><span>${formatAmount(p.amount)} Ø±.Ø³</span></div>
                <div class="row"><span class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span><span>${dateStr} ${timeStr}</span></div>
                <div class="line"></div>
            `;
        });
    }

    html += `<script>window.print();<\/script></body></html>`;

    const w = window.open("","_blank","width=400,height=600");
    w.document.write(html);
    w.document.close();
}

// =================== Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø« ===================
function printCurrentReport(){
    const filtered = applyFilters(false);
    let html = `
        <html lang="ar" dir="rtl">
        <head><meta charset="utf-8"><title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¤Ø¬Ù„</title>
        <style>
            body{font-family:"Tahoma";width:80mm;margin:0 auto;font-size:12px;}
            h2{text-align:center;margin:4px 0;}
            .line{border-top:1px dashed #555;margin:4px 0;}
            .row{display:flex;justify-content:space-between;font-size:12px;margin:2px 0;}
            .label{color:#555;}
        </style>
        </head>
        <body>
        <h2>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø«)</h2>
        <div class="line"></div>
    `;
    filtered.forEach(c=>{
        const t=getCustomerTotals(c);
        html += `
            <div class="row"><span class="label">Ø§Ù„Ø¹Ù…ÙŠÙ„:</span><span>${c.name || ""}</span></div>
            <div class="row"><span class="label">Ø§Ù„Ù‡Ø§ØªÙ:</span><span>${c.phone || "-"}</span></div>
            <div class="row"><span class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:</span><span>${formatAmount(t.invoicesTotal)}</span></div>
            <div class="row"><span class="label">Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span><span>${formatAmount(t.paymentsTotal)}</span></div>
            <div class="row"><span class="label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span><span>${formatAmount(t.remaining)}</span></div>
            <div class="line"></div>
        `;
    });
    html += `<script>window.print();<\/script></body></html>`;
    const w=window.open("","_blank","width=400,height=600");
    w.document.write(html);
    w.document.close();
}

// =================== Ø£Ø­Ø¯Ø§Ø« Ø£ÙˆÙ„ÙŠØ© ===================
document.addEventListener("DOMContentLoaded",function(){
    // ÙÙ„Ø§ØªØ± Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    ["filterName","filterPhone","filterFromDate","filterToDate","filterStatus"].forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener("input",renderMainTable);
        el.addEventListener("change",renderMainTable);
    });
    document.getElementById("btnResetFilters").addEventListener("click",()=>{
        document.getElementById("filterName").value="";
        document.getElementById("filterPhone").value="";
        document.getElementById("filterFromDate").value="";
        document.getElementById("filterToDate").value="";
        document.getElementById("filterStatus").value="all";
        renderMainTable();
    });

    // Ø£Ø²Ø±Ø§Ø± Ø¹Ù„ÙŠØ§
    document.getElementById("btnAddCustomer").addEventListener("click",()=>openCustomerModal(null));
    document.getElementById("btnSaveCustomer").addEventListener("click",saveCustomerFromModal);
    document.getElementById("btnShowAllCustomers").addEventListener("click",()=>{renderAllCustomersModal();openModal("allCustomersModalBackdrop");});
    document.getElementById("btnShowPaidCustomers").addEventListener("click",openPaidCustomersModal);
    document.getElementById("btnPrintReport").addEventListener("click",printCurrentReport);
    document.getElementById("btnFilterInvoices").addEventListener("click",renderInvoicesTable);
    document.getElementById("btnPrintInvoices").addEventListener("click",printInvoicesForCustomer);
    document.getElementById("btnPrintInvoiceItemsReport").addEventListener("click",printInvoiceItemsReportForCustomer);

    // Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø¥Ø·Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    document.getElementById("allCustFilterName").addEventListener("input",renderAllCustomersModal);
    document.getElementById("allCustFilterPhone").addEventListener("input",renderAllCustomersModal);
    document.getElementById("btnResetAllCustomersFilter").addEventListener("click",()=>{
        document.getElementById("allCustFilterName").value="";
        document.getElementById("allCustFilterPhone").value="";
        renderAllCustomersModal();
    });

    // Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø¥Ø·Ø§Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ØªÙ… Ø§Ù„Ø³Ø¯Ø§Ø¯
    document.getElementById("paidCustFilterName").addEventListener("input",renderPaidCustomersModal);
    document.getElementById("paidCustFilterPhone").addEventListener("input",renderPaidCustomersModal);
    document.getElementById("btnResetPaidCustomersFilter").addEventListener("click",()=>{
        document.getElementById("paidCustFilterName").value="";
        document.getElementById("paidCustFilterPhone").value="";
        renderPaidCustomersModal();
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª
    document.querySelectorAll("[data-close]").forEach(btn=>{
        const id=btn.getAttribute("data-close");
        btn.addEventListener("click",()=>closeModal(id));
    });

    // Ø§Ù„Ø¯ÙØ¹Ø§Øª
    document.getElementById("btnAddPaymentQuick").addEventListener("click",addQuickPayment);
    document.getElementById("btnClosePayments").addEventListener("click",closePaymentsModal);
    document.getElementById("btnQuickPay").addEventListener("click",()=>{
        if (!selectedCustomerId){alert("Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„.");return;}
        openPaymentsModal(selectedCustomerId);
    });
    document.getElementById("btnApplyPaymentFilter").addEventListener("click",renderPaymentsList);
    document.getElementById("btnPrintPaymentsReport").addEventListener("click",printPaymentsReport);
    document.getElementById("paymentFilterFrom").addEventListener("change",renderPaymentsList);
    document.getElementById("paymentFilterTo").addEventListener("change",renderPaymentsList);

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ API Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    loadCustomersFromApi();
});
</script>
</body>
</html>
