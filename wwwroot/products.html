<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>شاشة المنتجات</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        body { background-color: #f5f7fb; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
        .page-wrapper { padding: 20px; }
        .card-main { border-radius: 16px; box-shadow: 0 4px 20px rgba(15, 23, 42, 0.08); }
        .table thead th { background: #f1f5f9; position: sticky; top: 0; z-index: 1; }
        .badge-status { min-width: 70px; }
        .btn-primary { background: #2563eb; border-color: #2563eb; }
        .btn-primary:hover { background: #1d4ed8; border-color: #1d4ed8; }
        .offer-pill { font-size: 0.75rem; }
        .navbar-top { border-radius: 12px; background: #0f172a; color: #e2e8f0; padding: 10px 16px; margin-bottom: 16px; }
        .navbar-top a { color: #e5e7eb; text-decoration: none; }
        .navbar-top a:hover { text-decoration: underline; }
        .time-label { font-size: 0.9rem; color: #cbd5f5; }
        .pagination-summary { font-size: 0.85rem; color: #64748b; }
    </style>
</head>
<body>
<div class="container-fluid page-wrapper">

    <!-- شريط علوي -->
    <div class="navbar-top d-flex justify-content-between align-items-center mb-3">
        <div>
            <strong>نظام إدارة المتجر</strong> – شاشة المنتجات
        </div>
        <div class="d-flex align-items-center gap-3">
            <a href="/index.html" class="me-3">العودة للرئيسية</a>
            <span class="time-label" id="clockLabel"></span>
        </div>
    </div>

    <!-- الكارد الرئيسي -->
    <div class="card card-main">
        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="d-flex flex-wrap gap-2">
                <button class="btn btn-primary" onclick="openNewProduct()">
                    منتج جديد +
                </button>
                <button class="btn btn-outline-secondary" onclick="reloadProducts()">
                    إعادة تحميل
                </button>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <input id="searchInput" class="form-control form-control-sm" style="min-width: 220px;" placeholder="بحث بالاسم أو الباركود..." oninput="applyFilters()" />
                <select id="statusFilter" class="form-select form-select-sm" onchange="applyFilters()">
                    <option value="">كل الحالات</option>
                    <option value="available">متوفر</option>
                    <option value="low">منخفض</option>
                    <option value="out">نافد</option>
                </select>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 480px;">
                <table class="table table-hover mb-0 align-middle" id="productsTable">
                    <thead>
                        <tr>
                            <th style="width: 90px;">الإجراءات</th>
                            <th>الحالة</th>
                            <th>الكمية المتبقية</th>
                            <th>السعر</th>
                            <th>المورد</th>
                            <th>التصنيف</th>
                            <th>اسم المنتج</th>
                            <th>الباركود</th>
                        </tr>
                    </thead>
                    <tbody id="productsBody">
                        <!-- الصفوف تُحقن برمجياً -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="pagination-summary" id="summaryLabel">
                <!-- مثال: المعروض 1–50 من 160 منتج -->
            </div>
            <div class="btn-group btn-group-sm" role="group">
                <button class="btn btn-outline-secondary" onclick="firstPage()">الأول</button>
                <button class="btn btn-outline-secondary" onclick="prevPage()">السابق</button>
                <button class="btn btn-outline-secondary" onclick="nextPage()">التالي</button>
            </div>
        </div>
    </div>
</div>

<!-- نافذة المنتج -->
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="productForm" onsubmit="saveProduct(event)">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">منتج جديد</h5>
          <button type="button" class="btn-close ms-0" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <input type="hidden" id="productId" />

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">الباركود</label>
              <input type="text" id="barcode" class="form-control" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">اسم المنتج</label>
              <input type="text" id="name" class="form-control" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">المورد</label>
              <input type="text" id="supplierName" class="form-control" />
            </div>

            <div class="col-md-4">
              <label class="form-label">التصنيف</label>
              <input type="text" id="category" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">الكمية</label>
              <input type="number" id="quantity" class="form-control" min="0" />
            </div>
            <div class="col-md-4">
              <label class="form-label">حد أدنى للمخزون</label>
              <input type="number" id="minQuantity" class="form-control" min="0" />
            </div>

            <div class="col-md-4">
              <label class="form-label">سعر الشراء</label>
              <input type="number" step="0.01" id="purchasePrice" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">سعر البيع</label>
              <input type="number" step="0.01" id="salePrice" class="form-control" />
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="isVatIncluded" checked />
                <label class="form-check-label" for="isVatIncluded">
                  السعر شامل الضريبة
                </label>
              </div>
            </div>

            <div class="col-md-4">
              <label class="form-label">تاريخ الصلاحية</label>
              <input type="date" id="expiryDate" class="form-control" />
            </div>

            <hr class="mt-3" />

            <div class="col-12 d-flex justify-content-between align-items-center">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="offerEnabled" onchange="toggleOfferSection()" />
                    <label class="form-check-label fw-bold" for="offerEnabled">
                        تفعيل العرض
                    </label>
                </div>
                <span class="text-muted small" id="offerInfoLabel"></span>
            </div>

            <div id="offerSection" class="row g-3 mt-1" style="display:none;">
              <div class="col-md-4">
                <label class="form-label">اسم العرض</label>
                <input type="text" id="offerName" class="form-control" />
              </div>
              <div class="col-md-4">
                <label class="form-label">سعر العرض</label>
                <input type="number" step="0.01" id="offerPrice" class="form-control" />
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="offerVatIncluded" checked />
                  <label class="form-check-label" for="offerVatIncluded">
                    سعر العرض شامل الضريبة
                  </label>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">تاريخ بداية العرض</label>
                <input type="date" id="offerStart" class="form-control" />
              </div>
              <div class="col-md-6">
                <label class="form-label">تاريخ نهاية العرض</label>
                <input type="date" id="offerEnd" class="form-control" />
              </div>
            </div>

          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button type="submit" class="btn btn-primary">حفظ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let products = [];
    let filteredProducts = [];
    let currentPage = 1;
    const pageSize = 50;
    let productModal;

    document.addEventListener("DOMContentLoaded", () => {
        productModal = new bootstrap.Modal(document.getElementById("productModal"));
        initClock();
        loadProducts();
    });

    function initClock() {
        const lbl = document.getElementById("clockLabel");
        function tick() {
            const now = new Date();
            const days = ["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
            const d = days[now.getDay()];
            const date = now.toLocaleDateString("ar-SA");
            const time = now.toLocaleTimeString("ar-SA", { hour12: false });
            lbl.textContent = d + " - " + date + " - " + time;
        }
        tick();
        setInterval(tick, 1000);
    }

    async function loadProducts() {
        try {
            const res = await fetch("/api/products");
            if (!res.ok) throw new Error("فشل تحميل المنتجات");
            products = await res.json();
            filteredProducts = [...products];
            currentPage = 1;
            renderProducts();
        } catch (err) {
            console.error(err);
            alert("تعذر تحميل المنتجات من الخادم");
        }
    }

    function reloadProducts() {
        loadProducts();
    }

    function applyFilters() {
        const term = document.getElementById("searchInput").value.trim().toLowerCase();
        const status = document.getElementById("statusFilter").value;

        filteredProducts = products.filter(p => {
            const textMatch =
                !term ||
                (p.name && p.name.toLowerCase().includes(term)) ||
                (p.barcode && p.barcode.toLowerCase().includes(term));

            let statusMatch = true;
            const remaining = (p.quantity || 0) - (p.soldQuantity || 0);

            if (status === "available") statusMatch = remaining > 0;
            if (status === "low") statusMatch = remaining > 0 && remaining <= (p.minQuantity || 0);
            if (status === "out") statusMatch = remaining <= 0;

            return textMatch && statusMatch;
        });

        currentPage = 1;
        renderProducts();
    }

    function renderProducts() {
        const tbody = document.getElementById("productsBody");
        tbody.innerHTML = "";

        const total = filteredProducts.length;
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, total);
        const pageItems = filteredProducts.slice(startIndex, endIndex);

        for (const p of pageItems) {
            const remaining = (p.quantity || 0) - (p.soldQuantity || 0);
            let statusText = "متوفر";
            let statusClass = "bg-success";

            if (remaining <= 0) {
                statusText = "نافد";
                statusClass = "bg-danger";
            } else if (remaining > 0 && remaining <= (p.minQuantity || 0)) {
                statusText = "منخفض";
                statusClass = "bg-warning text-dark";
            }

            const tr = document.createElement("tr");

            const actionsTd = document.createElement("td");
            actionsTd.innerHTML = 
                <button class="btn btn-sm btn-outline-primary me-1" onclick="editProduct()">تعديل</button>
            ;

            const statusTd = document.createElement("td");
            statusTd.innerHTML = <span class="badge badge-status "></span> +
                (p.offerEnabled ? <div><span class="badge rounded-pill text-bg-info offer-pill">عرض ساري</span></div> : "");

            const remainingTd = document.createElement("td");
            remainingTd.textContent = remaining;

            const priceTd = document.createElement("td");
            if (p.offerEnabled && p.offerPrice != null) {
                priceTd.innerHTML = 
                    <div><s class="text-muted small"></s></div>
                    <div class="text-success fw-bold"></div>
                ;
            } else {
                priceTd.textContent = p.salePrice ?? "";
            }

            const supplierTd = document.createElement("td");
            supplierTd.textContent = p.supplierName ?? "";

            const categoryTd = document.createElement("td");
            categoryTd.textContent = p.category ?? "";

            const nameTd = document.createElement("td");
            nameTd.textContent = p.name ?? "";

            const barcodeTd = document.createElement("td");
            barcodeTd.textContent = p.barcode ?? "";

            tr.appendChild(actionsTd);
            tr.appendChild(statusTd);
            tr.appendChild(remainingTd);
            tr.appendChild(priceTd);
            tr.appendChild(supplierTd);
            tr.appendChild(categoryTd);
            tr.appendChild(nameTd);
            tr.appendChild(barcodeTd);

            tbody.appendChild(tr);
        }

        const summaryLabel = document.getElementById("summaryLabel");
        if (total === 0) {
            summaryLabel.textContent = "لا توجد منتجات مطابقة.";
        } else {
            summaryLabel.textContent =
                المعروض – من  منتج;
        }
    }

    function nextPage() {
        const totalPages = Math.ceil(filteredProducts.length / pageSize);
        if (currentPage < totalPages) {
            currentPage++;
            renderProducts();
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderProducts();
        }
    }

    function firstPage() {
        currentPage = 1;
        renderProducts();
    }

    function openNewProduct() {
        clearForm();
        document.getElementById("modalTitle").textContent = "منتج جديد";
        productModal.show();
    }

    function toggleOfferSection() {
        const enabled = document.getElementById("offerEnabled").checked;
        document.getElementById("offerSection").style.display = enabled ? "flex" : "none";
        document.getElementById("offerInfoLabel").textContent = "";
        if (!enabled) {
            document.getElementById("offerName").value = "";
            document.getElementById("offerPrice").value = "";
            document.getElementById("offerStart").value = "";
            document.getElementById("offerEnd").value = "";
        }
    }

    function clearForm() {
        document.getElementById("productId").value = "";
        document.getElementById("barcode").value = "";
        document.getElementById("name").value = "";
        document.getElementById("supplierName").value = "";
        document.getElementById("category").value = "";
        document.getElementById("quantity").value = "";
        document.getElementById("minQuantity").value = "";
        document.getElementById("purchasePrice").value = "";
        document.getElementById("salePrice").value = "";
        document.getElementById("isVatIncluded").checked = true;
        document.getElementById("expiryDate").value = "";
        document.getElementById("offerEnabled").checked = false;
        document.getElementById("offerName").value = "";
        document.getElementById("offerPrice").value = "";
        document.getElementById("offerStart").value = "";
        document.getElementById("offerEnd").value = "";
        document.getElementById("offerVatIncluded").checked = true;
        toggleOfferSection();
    }

    function editProduct(id) {
        const p = products.find(x => x.id === id);
        if (!p) return;

        clearForm();
        document.getElementById("modalTitle").textContent = "تعديل منتج";

        document.getElementById("productId").value = p.id;
        document.getElementById("barcode").value = p.barcode ?? "";
        document.getElementById("name").value = p.name ?? "";
        document.getElementById("supplierName").value = p.supplierName ?? "";
        document.getElementById("category").value = p.category ?? "";
        document.getElementById("quantity").value = p.quantity ?? "";
        document.getElementById("minQuantity").value = p.minQuantity ?? "";
        document.getElementById("purchasePrice").value = p.purchasePrice ?? "";
        document.getElementById("salePrice").value = p.salePrice ?? "";
        document.getElementById("isVatIncluded").checked = !!p.isVatIncluded;
        if (p.expiryDate) {
            document.getElementById("expiryDate").value = p.expiryDate.substring(0, 10);
        }

        document.getElementById("offerEnabled").checked = !!p.offerEnabled;
        document.getElementById("offerName").value = p.offerName ?? "";
        document.getElementById("offerPrice").value = p.offerPrice ?? "";
        if (p.offerStart) document.getElementById("offerStart").value = p.offerStart.substring(0, 10);
        if (p.offerEnd) document.getElementById("offerEnd").value = p.offerEnd.substring(0, 10);
        document.getElementById("offerVatIncluded").checked = !!p.offerVatIncluded;

        toggleOfferSection();
        productModal.show();
    }

    async function saveProduct(event) {
        event.preventDefault();

        const id = document.getElementById("productId").value;
        const offerEnabled = document.getElementById("offerEnabled").checked;
        const offerStart = document.getElementById("offerStart").value;
        const offerEnd = document.getElementById("offerEnd").value;

        if (offerEnabled && (!offerStart || !offerEnd)) {
            alert("حدد تاريخ بداية ونهاية العرض");
            return;
        }

        const product = {
            id: id ? parseInt(id) : 0,
            barcode: document.getElementById("barcode").value.trim(),
            name: document.getElementById("name").value.trim(),
            supplierName: document.getElementById("supplierName").value.trim(),
            category: document.getElementById("category").value.trim(),
            quantity: parseInt(document.getElementById("quantity").value || "0"),
            minQuantity: parseInt(document.getElementById("minQuantity").value || "0"),
            soldQuantity: 0,
            purchasePrice: parseFloat(document.getElementById("purchasePrice").value || "0"),
            salePrice: parseFloat(document.getElementById("salePrice").value || "0"),
            isVatIncluded: document.getElementById("isVatIncluded").checked,
            expiryDate: document.getElementById("expiryDate").value || null,
            offerEnabled: offerEnabled,
            offerName: document.getElementById("offerName").value.trim(),
            offerPrice: document.getElementById("offerPrice").value ? parseFloat(document.getElementById("offerPrice").value) : null,
            offerStart: offerStart || null,
            offerEnd: offerEnd || null,
            offerVatIncluded: document.getElementById("offerVatIncluded").checked
        };

        const isEdit = !!id;
        const url = isEdit ? /api/products/ : "/api/products";
        const method = isEdit ? "PUT" : "POST";

        try {
            const res = await fetch(url, {
                method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(product)
            });

            if (!res.ok) throw new Error("فشل حفظ المنتج");

            const saved = await res.json();

            if (isEdit) {
                const index = products.findIndex(p => p.id === saved.id);
                if (index !== -1) products[index] = saved;
            } else {
                products.push(saved);
            }

            filteredProducts = [...products];
            applyFilters();
            productModal.hide();
        } catch (err) {
            console.error(err);
            alert("تعذر حفظ المنتج");
        }
    }
</script>
</body>
</html>
