<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>شاشة المنتجات</title>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, sans-serif;
            background: #f3f5f9;
            margin: 0;
            padding: 0;
        }
        header {
            background: #1f3b70;
            color: #fff;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header h1 {
            margin: 0;
            font-size: 22px;
        }
        .header-actions {
            display: flex;
            gap: 8px;
        }
        .btn {
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #2563eb;
            color: #fff;
        }
        .btn-secondary {
            background: #e5e7eb;
            color: #111827;
        }
        .btn-danger {
            background: #ef4444;
            color: #fff;
        }
        .btn:disabled {
            opacity: .6;
            cursor: default;
        }
        main {
            padding: 16px 24px 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }
        .toolbar input[type="text"] {
            flex: 1;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(15, 23, 42, .08);
        }
        thead {
            background: #e5e7eb;
        }
        th, td {
            padding: 8px 10px;
            font-size: 14px;
            border-bottom: 1px solid #f3f4f6;
            text-align: center;
        }
        tbody tr:nth-child(even) {
            background: #f9fafb;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
        }
        .badge-success {
            background: #dcfce7;
            color: #15803d;
        }
        .badge-warning {
            background: #fef9c3;
            color: #854d0e;
        }
        .badge-danger {
            background: #fee2e2;
            color: #b91c1c;
        }
        .badge-offer {
            background: #dbeafe;
            color: #1d4ed8;
        }
        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, .45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal {
            background: #fff;
            border-radius: 10px;
            max-width: 850px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 16px 20px 20px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 8px;
            margin-bottom: 12px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
        }
        .modal-body {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px 16px;
        }
        .modal-footer {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            border-top: 1px solid #e5e7eb;
            padding-top: 10px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 13px;
        }
        .form-group label {
            font-weight: 600;
            color: #374151;
        }
        .form-group input,
        .form-group select {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 13px;
        }
        .form-inline {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }
        .hint {
            font-size: 11px;
            color: #6b7280;
        }
        @media (max-width: 768px) {
            .modal-body {
                grid-template-columns: minmax(0, 1fr);
            }
            header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
<header>
    <h1>شاشة المنتجات</h1>
    <div class="header-actions">
        <a href="index.html" class="btn btn-secondary">⬅ العودة للرئيسية</a>
    </div>
</header>

<main>
    <div class="toolbar">
        <input id="searchBox" type="text" placeholder="بحث بالاسم أو الباركود..." oninput="filterProducts()" />
        <button class="btn btn-primary" onclick="openNewProduct()">منتج جديد +</button>
        <button class="btn btn-secondary" onclick="reloadProducts()">تحديث القائمة ⟳</button>
    </div>

    <table>
        <thead>
        <tr>
            <th>الباركود</th>
            <th>اسم المنتج</th>
            <th>المورد</th>
            <th>التصنيف</th>
            <th>السعر</th>
            <th>الكمية المتبقية</th>
            <th>الحالة</th>
            <th>العرض</th>
            <th>إجراءات</th>
        </tr>
        </thead>
        <tbody id="productsBody">
        <!-- بيانات المنتجات -->
        </tbody>
    </table>
</main>

<!-- نافذة إضافة / تعديل منتج -->
<div id="productModalBackdrop" class="modal-backdrop">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modalTitle">إضافة منتج جديد</h2>
            <button class="btn btn-secondary" onclick="closeProductModal()">إغلاق ✕</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="barcode">رقم الباركود</label>
                <input id="barcode" type="text" />
            </div>
            <div class="form-group">
                <label for="name">اسم المنتج</label>
                <input id="name" type="text" />
            </div>
            <div class="form-group">
                <label for="supplierName">المورد</label>
                <input id="supplierName" type="text" />
            </div>
            <div class="form-group">
                <label for="category">التصنيف</label>
                <input id="category" type="text" />
            </div>
            <div class="form-group">
                <label for="quantity">الكمية</label>
                <input id="quantity" type="number" min="0" />
            </div>
            <div class="form-group">
                <label for="minQuantity">حد أدنى للمخزون</label>
                <input id="minQuantity" type="number" min="0" />
            </div>
            <div class="form-group">
                <label for="purchasePrice">سعر الشراء</label>
                <input id="purchasePrice" type="number" min="0" step="0.01" />
            </div>
            <div class="form-group">
                <label for="salePrice">سعر البيع</label>
                <input id="salePrice" type="number" min="0" step="0.01" />
            </div>
            <div class="form-group">
                <label>الضريبة</label>
                <div class="form-inline">
                    <input id="isVatIncluded" type="checkbox" checked />
                    <span>السعر شامل الضريبة</span>
                </div>
            </div>
            <div class="form-group">
                <label for="expiryDate">تاريخ الصلاحية</label>
                <input id="expiryDate" type="date" />
            </div>

            <!-- إعدادات العرض -->
            <div class="form-group">
                <label>تفعيل العرض</label>
                <div class="form-inline">
                    <input id="offerEnabled" type="checkbox" />
                    <span>تشغيل عرض للمنتج</span>
                </div>
                <div class="hint">عند تفعيل العرض يجب تحديد اسم العرض والسعر وتواريخ البداية والنهاية.</div>
            </div>
            <div class="form-group">
                <label for="offerName">اسم العرض</label>
                <input id="offerName" type="text" />
            </div>
            <div class="form-group">
                <label for="offerPrice">سعر العرض</label>
                <input id="offerPrice" type="number" min="0" step="0.01" />
            </div>
            <div class="form-group">
                <label>ضريبة السعر في العرض</label>
                <div class="form-inline">
                    <input id="offerVatIncluded" type="checkbox" checked />
                    <span>سعر العرض شامل الضريبة</span>
                </div>
            </div>
            <div class="form-group">
                <label for="offerStart">بداية العرض</label>
                <input id="offerStart" type="date" />
            </div>
            <div class="form-group">
                <label for="offerEnd">نهاية العرض</label>
                <input id="offerEnd" type="date" />
                <div class="hint">إذا كان العرض مفعَّلًا ولا يوجد تاريخ بداية أو نهاية، لن يتم الحفظ وسيظهر تنبيه.</div>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
                <label>ملاحظات عن مدة العرض</label>
                <div id="offerInfo" class="hint">لم يتم حساب المدة بعد.</div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeProductModal()">إلغاء</button>
            <button class="btn btn-primary" onclick="saveProduct()">حفظ</button>
        </div>
    </div>
</div>

<script>
    let products = [];
    let editingProductId = null;

    function showProductModal() {
        document.getElementById("productModalBackdrop").style.display = "flex";
    }

    function closeProductModal() {
        document.getElementById("productModalBackdrop").style.display = "none";
    }

    function resetProductForm() {
        editingProductId = null;
        document.getElementById("barcode").value = "";
        document.getElementById("name").value = "";
        document.getElementById("supplierName").value = "";
        document.getElementById("category").value = "";
        document.getElementById("quantity").value = "";
        document.getElementById("minQuantity").value = "";
        document.getElementById("purchasePrice").value = "";
        document.getElementById("salePrice").value = "";
        document.getElementById("isVatIncluded").checked = true;
        document.getElementById("expiryDate").value = "";
        document.getElementById("offerEnabled").checked = false;
        document.getElementById("offerName").value = "";
        document.getElementById("offerPrice").value = "";
        document.getElementById("offerVatIncluded").checked = true;
        document.getElementById("offerStart").value = "";
        document.getElementById("offerEnd").value = "";
        document.getElementById("offerInfo").textContent = "لم يتم حساب المدة بعد.";
    }

    function openNewProduct() {
        resetProductForm();
        document.getElementById("modalTitle").textContent = "إضافة منتج جديد";
        showProductModal();
    }

    function openEditProduct(id) {
        const p = products.find(x => x.id === id);
        if (!p) return;

        editingProductId = id;
        document.getElementById("modalTitle").textContent = "تعديل منتج";

        document.getElementById("barcode").value = p.barcode || "";
        document.getElementById("name").value = p.name || "";
        document.getElementById("supplierName").value = p.supplierName || "";
        document.getElementById("category").value = p.category || "";
        document.getElementById("quantity").value = p.quantity ?? "";
        document.getElementById("minQuantity").value = p.minQuantity ?? "";
        document.getElementById("purchasePrice").value = p.purchasePrice ?? "";
        document.getElementById("salePrice").value = p.salePrice ?? "";
        document.getElementById("isVatIncluded").checked = !!p.isVatIncluded;
        document.getElementById("expiryDate").value = p.expiryDate ? p.expiryDate.substring(0, 10) : "";
        document.getElementById("offerEnabled").checked = !!p.offerEnabled;
        document.getElementById("offerName").value = p.offerName || "";
        document.getElementById("offerPrice").value = p.offerPrice ?? "";
        document.getElementById("offerVatIncluded").checked = p.offerVatIncluded !== false;
        document.getElementById("offerStart").value = p.offerStart ? p.offerStart.substring(0, 10) : "";
        document.getElementById("offerEnd").value = p.offerEnd ? p.offerEnd.substring(0, 10) : "";
        updateOfferInfo();
        showProductModal();
    }

    function updateOfferInfo() {
        const startVal = document.getElementById("offerStart").value;
        const endVal = document.getElementById("offerEnd").value;
        const enabled = document.getElementById("offerEnabled").checked;
        const info = document.getElementById("offerInfo");

        if (!enabled) {
            info.textContent = "العرض غير مفعَّل.";
            return;
        }

        if (!startVal || !endVal) {
            info.textContent = "عند تفعيل العرض يجب تحديد تاريخ البداية والنهاية قبل الحفظ.";
            return;
        }

        const start = new Date(startVal);
        const end = new Date(endVal);
        if (isNaN(start) || isNaN(end) || end < start) {
            info.textContent = "تأكد أن تاريخ النهاية أكبر أو يساوي تاريخ البداية.";
            return;
        }

        const diffDays = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;
        info.textContent = "مدة العرض " + diffDays + " يوم/أيام من " + startVal + " إلى " + endVal + ".";
    }

    document.getElementById("offerStart").addEventListener("change", updateOfferInfo);
    document.getElementById("offerEnd").addEventListener("change", updateOfferInfo);
    document.getElementById("offerEnabled").addEventListener("change", updateOfferInfo);

    async function reloadProducts() {
        try {
            const res = await fetch("/api/products");
            if (!res.ok) {
                alert("حدث خطأ في تحميل المنتجات من الخادم.");
                return;
            }
            products = await res.json();
            renderProducts(products);
        } catch (e) {
            console.error(e);
            alert("تعذر الاتصال بالخادم.");
        }
    }

    function renderProducts(list) {
        const body = document.getElementById("productsBody");
        body.innerHTML = "";
        if (!list || list.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 9;
            td.textContent = "لا توجد منتجات مسجلة.";
            tr.appendChild(td);
            body.appendChild(tr);
            return;
        }

        for (const p of list) {
            const tr = document.createElement("tr");

            const stateBadge = document.createElement("span");
            stateBadge.classList.add("badge");
            if (p.remainingQuantity <= 0) {
                stateBadge.classList.add("badge-danger");
                stateBadge.textContent = "نافد";
            } else if (p.remainingQuantity <= (p.minQuantity ?? 0)) {
                stateBadge.classList.add("badge-warning");
                stateBadge.textContent = "منخفض";
            } else {
                stateBadge.classList.add("badge-success");
                stateBadge.textContent = "متوفر";
            }

            const offerBadge = document.createElement("span");
            if (p.offerEnabled) {
                offerBadge.classList.add("badge", "badge-offer");
                offerBadge.textContent = "عرض مفعَّل";
            } else {
                offerBadge.textContent = "-";
            }

            tr.innerHTML = `
                <td>${p.barcode ?? ""}</td>
                <td>${p.name ?? ""}</td>
                <td>${p.supplierName ?? ""}</td>
                <td>${p.category ?? ""}</td>
                <td>${p.salePrice != null ? p.salePrice.toFixed(2) : ""}</td>
                <td>${p.remainingQuantity ?? ""}</td>
                <td></td>
                <td></td>
                <td></td>
            `;

            tr.children[6].appendChild(stateBadge);
            tr.children[7].appendChild(offerBadge);

            const actionsTd = tr.children[8];
            const editBtn = document.createElement("button");
            editBtn.className = "btn btn-secondary";
            editBtn.textContent = "تعديل";
            editBtn.onclick = () => openEditProduct(p.id);

            const delBtn = document.createElement("button");
            delBtn.className = "btn btn-danger";
            delBtn.style.marginRight = "4px";
            delBtn.textContent = "حذف";
            delBtn.onclick = () => deleteProduct(p.id);

            actionsTd.appendChild(editBtn);
            actionsTd.appendChild(delBtn);

            body.appendChild(tr);
        }
    }

    function filterProducts() {
        const q = document.getElementById("searchBox").value.trim();
        if (!q) {
            renderProducts(products);
            return;
        }
        const lower = q.toLowerCase();
        const filtered = products.filter(p =>
            (p.name || "").toLowerCase().includes(lower) ||
            (p.barcode || "").toLowerCase().includes(lower)
        );
        renderProducts(filtered);
    }

    async function saveProduct() {
        const offerEnabled = document.getElementById("offerEnabled").checked;
        const offerStartVal = document.getElementById("offerStart").value;
        const offerEndVal = document.getElementById("offerEnd").value;

        if (offerEnabled) {
            if (!offerStartVal || !offerEndVal) {
                alert("عند تفعيل العرض يجب تحديد تاريخ بداية ونهاية العرض.");
                return;
            }
            const s = new Date(offerStartVal);
            const e = new Date(offerEndVal);
            if (isNaN(s) || isNaN(e) || e < s) {
                alert("تأكد أن تاريخ نهاية العرض بعد أو يساوي تاريخ البداية.");
                return;
            }
        }

        const payload = {
            barcode: document.getElementById("barcode").value.trim(),
            name: document.getElementById("name").value.trim(),
            supplierName: document.getElementById("supplierName").value.trim(),
            category: document.getElementById("category").value.trim(),
            quantity: Number(document.getElementById("quantity").value || 0),
            minQuantity: Number(document.getElementById("minQuantity").value || 0),
            soldQuantity: 0,
            purchasePrice: Number(document.getElementById("purchasePrice").value || 0),
            salePrice: Number(document.getElementById("salePrice").value || 0),
            isVatIncluded: document.getElementById("isVatIncluded").checked,
            expiryDate: document.getElementById("expiryDate").value || null,
            offerEnabled: offerEnabled,
            offerName: offerEnabled ? document.getElementById("offerName").value.trim() : "",
            offerPrice: offerEnabled ? Number(document.getElementById("offerPrice").value || 0) : null,
            offerStart: offerEnabled ? offerStartVal : null,
            offerEnd: offerEnabled ? offerEndVal : null,
            offerVatIncluded: offerEnabled ? document.getElementById("offerVatIncluded").checked : true
        };

        const url = editingProductId ? `/api/products/${editingProductId}` : "/api/products";
        const method = editingProductId ? "PUT" : "POST";

        try {
            const res = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                console.error("Save error", await res.text());
                alert("حدث خطأ أثناء حفظ المنتج.");
                return;
            }
            closeProductModal();
            await reloadProducts();
        } catch (e) {
            console.error(e);
            alert("تعذر الاتصال بالخادم أثناء حفظ المنتج.");
        }
    }

    async function deleteProduct(id) {
        if (!confirm("تأكيد حذف المنتج؟")) return;
        try {
            const res = await fetch(`/api/products/${id}`, { method: "DELETE" });
            if (!res.ok) {
                alert("تعذر حذف المنتج.");
                return;
            }
            await reloadProducts();
        } catch (e) {
            console.error(e);
            alert("تعذر الاتصال بالخادم أثناء الحذف.");
        }
    }

    window.addEventListener("load", reloadProducts);
</script>
</body>
</html>
