<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <title>تقرير فواتير الكاشير</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --bg-page: #f5f7fb;
            --bg-card: #ffffff;
            --accent: #0ea5e9;
            --accent-soft: #e0f2fe;
            --text-main: #0f172a;
            --text-muted: #6b7280;
            --border-soft: #e5e7eb;
            --danger: #ef4444;
            --success: #16a34a;
            --warning: #f97316;
            --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.06);
            --radius-lg: 18px;
        }

        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            margin: 0;
            padding: 24px;
            background: radial-gradient(circle at top, #e0f2fe 0, #f5f7fb 55%, #f5f7fb 100%);
            color: var(--text-main);
        }

        .page {
            max-width: 1300px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-title span.icon {
            width: 38px;
            height: 38px;
            border-radius: 999px;
            background: linear-gradient(135deg, var(--accent), #22c55e);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 20px;
            box-shadow: 0 10px 20px rgba(56, 189, 248, 0.4);
        }

        .header-subtitle {
            font-size: 13px;
            color: var(--text-muted);
        }

        .filters-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            padding: 16px 18px;
            margin-bottom: 18px;
            border: 1px solid #e0f2fe;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 12px;
        }

        .filter-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 4px;
            color: var(--text-muted);
        }

        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 7px 9px;
            font-size: 13px;
            border-radius: 999px;
            border: 1px solid var(--border-soft);
            outline: none;
            transition: all 0.15s ease;
            background: #f9fafb;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            border-color: var(--accent);
            background: #fff;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.15);
        }

        .filters-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 8px;
        }

        .btn {
            border: none;
            cursor: pointer;
            border-radius: 999px;
            padding: 8px 18px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), #38bdf8);
            color: #fff;
            box-shadow: 0 10px 20px rgba(56, 189, 248, 0.45);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-soft);
            color: var(--text-muted);
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: none;
        }

        .status-pill {
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status-normal {
            background: #dcfce7;
            color: #15803d;
        }

        .status-suspended {
            background: #fee2e2;
            color: #b91c1c;
        }

        .status-returned {
            background: #fef3c7;
            color: #92400e;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            padding: 12px 16px;
            margin-bottom: 16px;
            border: 1px solid #e0f2fe;
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 10px;
        }

        .summary-item {
            font-size: 12px;
            color: var(--text-muted);
        }

        .summary-item strong {
            display: block;
            font-size: 14px;
            color: var(--text-main);
            margin-top: 2px;
        }

        .summary-item.total strong {
            color: var(--accent);
            font-size: 15px;
        }

        .table-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .table-wrapper {
            max-height: 520px;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead {
            position: sticky;
            top: 0;
            background: #f1f5f9;
            z-index: 5;
        }

        th,
        td {
            padding: 8px 10px;
            border-bottom: 1px solid #e5e7eb;
            text-align: center;
            white-space: nowrap;
        }

        th {
            font-weight: 600;
            color: #4b5563;
        }

        tbody tr:nth-child(odd) {
            background: #f9fafb;
        }

        tbody tr:hover {
            background: #eff6ff;
        }

        .text-left {
            text-align: right;
        }

        .badge-payment {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 11px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .badge-card {
            background: #e0f2fe;
            color: #0369a1;
        }

        .badge-cash {
            background: #dcfce7;
            color: #166534;
        }

        .badge-deferred {
            background: #fef3c7;
            color: #92400e;
        }

        .muted {
            color: var(--text-muted);
            font-size: 12px;
        }

        .chip-info {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: #e0f2fe;
            color: #0369a1;
            font-size: 11px;
        }

        .empty-state {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .error-msg {
            color: var(--danger);
            font-size: 13px;
            margin-top: 6px;
        }

        .loader {
            font-size: 12px;
            color: var(--text-muted);
        }

        @media (max-width: 900px) {
            body {
                padding: 12px;
            }
            .filters-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .summary-card {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .header-title {
                font-size: 20px;
            }
        }

        @media (max-width: 600px) {
            .filters-grid {
                grid-template-columns: 1fr;
            }
            .summary-card {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="header">
            <div>
                <div class="header-title">
                    <span class="icon">🧾</span>
                    <span>تقرير فواتير الكاشير</span>
                </div>
                <div class="header-subtitle">
                    بحث متقدم في فواتير الكاشير حسب التاريخ، رقم الفاتورة، حالة الفاتورة، وطريقة الدفع مع مجاميع المبالغ.
                </div>
            </div>
            <div class="chip-info">
                <span>💡</span>
                <span>F5 لتحديث الصفحة – النتائج من قاعدة بيانات الكاشير مباشرة</span>
            </div>
        </div>

        <div class="filters-card">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="invoiceId">رقم الفاتورة</label>
                    <input type="number" id="invoiceId" placeholder="مثال: 92" />
                </div>
                <div class="filter-group">
                    <label for="dateFrom">من تاريخ</label>
                    <input type="date" id="dateFrom" />
                </div>
                <div class="filter-group">
                    <label for="dateTo">إلى تاريخ</label>
                    <input type="date" id="dateTo" />
                </div>
                <div class="filter-group">
                    <label for="paymentMethod">طريقة الدفع</label>
                    <select id="paymentMethod">
                        <option value="">الكل</option>
                        <option value="card">شبكة</option>
                        <option value="cash">كاش</option>
                        <option value="deferred">دفع مؤجل</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statusFilter">حالة الفاتورة</label>
                    <select id="statusFilter">
                        <option value="">الكل</option>
                        <option value="normal">فواتير مكتملة</option>
                        <option value="suspended">فواتير معلّقة</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="returnFilter">المرتجع</label>
                    <select id="returnFilter">
                        <option value="">الكل</option>
                        <option value="with">بها مرتجعات</option>
                        <option value="without">بدون مرتجعات</option>
                    </select>
                </div>
            </div>

            <div class="filters-footer">
                <div>
                    <button id="btnSearch" class="btn btn-primary">
                        🔍 بحث
                    </button>
                    <button id="btnClear" class="btn btn-outline">
                        🧹 تصفية الحقول
                    </button>
                </div>
                <div>
                    <span id="loader" class="loader" style="display:none;">جاري تحميل الفواتير...</span>
                    <span id="error" class="error-msg" style="display:none;"></span>
                </div>
            </div>
        </div>

        <div class="summary-card">
            <div class="summary-item">
                عدد الفواتير
                <strong id="sumCount">0</strong>
            </div>
            <div class="summary-item">
                مجموع قبل الضريبة
                <strong id="sumSubTotal">0.00</strong>
            </div>
            <div class="summary-item">
                مجموع الخصم
                <strong id="sumDiscount">0.00</strong>
            </div>
            <div class="summary-item">
                مجموع الضريبة
                <strong id="sumVat">0.00</strong>
            </div>
            <div class="summary-item total">
                مجموع الإجمالي
                <strong id="sumGrand">0.00</strong>
            </div>
            <div class="summary-item">
                إجمالي المرتجع (مستقبلاً)
                <strong id="sumReturn">0.00</strong>
            </div>
            <div class="summary-item">
                آخر تحديث
                <strong id="lastUpdated">-</strong>
            </div>
            <div class="summary-item">
                ملاحظة
                <strong style="font-size:12px;">المرتجع التفصيلي يتم من شاشة المرتجع والكاشير</strong>
            </div>
        </div>

        <div class="table-card">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>رقم</th>
                            <th>التاريخ</th>
                            <th>العميل</th>
                            <th>الجوال</th>
                            <th>طريقة الدفع</th>
                            <th>الحالة</th>
                            <th>قبل الضريبة</th>
                            <th>الخصم</th>
                            <th>الضريبة</th>
                            <th>الإجمالي</th>
                            <th>المرتجع</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesBody">
                        <tr><td colspan="11" class="empty-state">لم يتم البحث بعد...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const apiBase = window.location.origin;
        let currentInvoices = [];

        function mapPaymentMethod(method) {
            switch ((method || "").toLowerCase()) {
                case "card": return { text: "شبكة", cls: "badge-card" };
                case "cash": return { text: "كاش", cls: "badge-cash" };
                case "deferred": return { text: "دفع مؤجل", cls: "badge-deferred" };
                default: return { text: method || "-", cls: "badge-payment" };
            }
        }

        function mapStatus(isSuspended) {
            if (isSuspended)
                return { text: "معلقة", cls: "status-pill status-suspended" };
            return { text: "مكتملة", cls: "status-pill status-normal" };
        }

        function formatNumber(val) {
            if (val == null || isNaN(val)) return "0.00";
            return Number(val).toFixed(2);
        }

        function formatDate(val) {
            if (!val) return "-";
            try {
                const d = new Date(val);
                if (isNaN(d.getTime())) return val;
                return d.toLocaleString("ar-SA");
            } catch {
                return val;
            }
        }

        function clearError() {
            const err = document.getElementById("error");
            err.style.display = "none";
            err.textContent = "";
        }

        function showError(msg) {
            const err = document.getElementById("error");
            err.style.display = "inline";
            err.textContent = msg;
        }

        function setLoading(isLoading) {
            const loader = document.getElementById("loader");
            loader.style.display = isLoading ? "inline" : "none";
        }

        function renderTable() {
            const tbody = document.getElementById("invoicesBody");
            tbody.innerHTML = "";

            if (!currentInvoices || currentInvoices.length === 0) {
                const tr = document.createElement("tr");
                const td = document.createElement("td");
                td.colSpan = 11;
                td.className = "empty-state";
                td.textContent = "لا توجد فواتير مطابقة لخيارات البحث.";
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            currentInvoices.forEach(inv => {
                const tr = document.createElement("tr");

                const pay = mapPaymentMethod(formatPaymentMethod(inv.paymentMethod));
                const st = mapStatus(inv.isSuspended);

                tr.innerHTML = `
                    <td>${inv.id}</td>
                    <td>${formatDate(inv.invoiceDate)}</td>
                    <td class="text-left">${inv.customerName || "-"}</td>
                    <td>${inv.customerPhone || "-"}</td>
                    <td>
                        <span class="badge-payment ${pay.cls}">${pay.text}</span>
                    </td>
                    <td>
                        <span class="${st.cls}">${st.text}</span>
                    </td>
                    <td>${formatNumber(inv.subTotal)}</td>
                    <td>${formatNumber(inv.discountTotal)}</td>
                    <td>${formatNumber(inv.vatTotal)}</td>
                    <td>${formatNumber(inv.grandTotal)}</td>
                    <td>${formatNumber(inv.returnAmount || 0)}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        function renderSummary() {
            const sumCount    = document.getElementById("sumCount");
            const sumSubTotal = document.getElementById("sumSubTotal");
            const sumDiscount = document.getElementById("sumDiscount");
            const sumVat      = document.getElementById("sumVat");
            const sumGrand    = document.getElementById("sumGrand");
            const sumReturn   = document.getElementById("sumReturn");
            const lastUpdated = document.getElementById("lastUpdated");

            let totalSub = 0, totalDisc = 0, totalVat = 0, totalGrand = 0, totalReturn = 0;

            currentInvoices.forEach(inv => {
                totalSub    += Number(inv.subTotal    || 0);
                totalDisc   += Number(inv.discountTotal || 0);
                totalVat    += Number(inv.vatTotal    || 0);
                totalGrand  += Number(inv.grandTotal || 0);
                totalReturn += Number(inv.returnAmount || 0);
            });

            sumCount.textContent    = currentInvoices.length;
            sumSubTotal.textContent = formatNumber(totalSub);
            sumDiscount.textContent = formatNumber(totalDisc);
            sumVat.textContent      = formatNumber(totalVat);
            sumGrand.textContent    = formatNumber(totalGrand);
            sumReturn.textContent   = formatNumber(totalReturn);

            const now = new Date();
            lastUpdated.textContent = now.toLocaleString("ar-SA");
        }

        async function loadInvoices() {
            clearError();
            setLoading(true);

            try {
                const invoiceId    = document.getElementById("invoiceId").value.trim();
                const dateFrom     = document.getElementById("dateFrom").value;
                const dateTo       = document.getElementById("dateTo").value;
                const payment      = document.getElementById("paymentMethod").value;
                const status       = document.getElementById("statusFilter").value;
                const returnFilter = document.getElementById("returnFilter").value;

                const params = new URLSearchParams();

                if (invoiceId) params.append("invoiceId", invoiceId);
                if (dateFrom)  params.append("from", dateFrom);
                if (dateTo)    params.append("to", dateTo);
                if (payment)   params.append("paymentMethod", payment);
                if (status)    params.append("status", status);
                if (returnFilter) params.append("returnFilter", returnFilter);

                const url = apiBase + "/api/cashier/invoices/report" +
                    (params.toString() ? "?" + params.toString() : "");

                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error("فشل في تحميل بيانات الفواتير من الخادم");
                }

                const data = await res.json();
                currentInvoices = Array.isArray(data) ? data : [];

                renderTable();
                renderSummary();
            } catch (err) {
                console.error(err);
                showError(err.message || "حدث خطأ غير متوقع");
            } finally {
                setLoading(false);
            }
        }

        function clearFilters() {
            document.getElementById("invoiceId").value = "";
            document.getElementById("dateFrom").value = "";
            document.getElementById("dateTo").value = "";
            document.getElementById("paymentMethod").value = "";
            document.getElementById("statusFilter").value = "";
            document.getElementById("returnFilter").value = "";
        }

        document.getElementById("btnSearch").addEventListener("click", function () {
            loadInvoices();
        });

        document.getElementById("btnClear").addEventListener("click", function () {
            clearFilters();
        });

        // بحث تلقائي لآخر 7 أيام عند فتح الصفحة
        window.addEventListener("load", () => {
            const today = new Date();
            const weekAgo = new Date();
            weekAgo.setDate(today.getDate() - 7);

            const toStr = today.toISOString().substring(0, 10);
            const fromStr = weekAgo.toISOString().substring(0, 10);

            document.getElementById("dateFrom").value = fromStr;
            document.getElementById("dateTo").value = toStr;

            loadInvoices();
        });

        // Enter في رقم الفاتورة = بحث
        document.getElementById("invoiceId").addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                loadInvoices();
            }
        });
    </script>
<script>
function formatPaymentMethod(pm) {
    if (!pm) return "";
    pm = pm.toLowerCase();
    if (pm === 'cash') return 'نقدي';
    if (pm === 'card') return 'شبكة';
    if (pm === 'deferred') return 'مؤجل';
    return pm;
}
</script>
</body>
</html>




