using Microsoft.EntityFrameworkCore;
using NaderProductsApp.Data;
using NaderProductsApp.Models;
using Npgsql;
using System.Text.Json;
using System.Text.RegularExpressions;

namespace NaderProductsApp
{
    // ================= DTOs + Helper =================

    public record CustomerViewDto(
        int Id,
        string Name,
        string? Phone,
        string? Address,
        string? Notes,
        string Status,
        decimal InvoicesTotal,
        decimal PaymentsTotal,
        decimal Remaining,
        DateTime? LastInvoiceDate
    );

    public record CustomerEditDto(
        string Name,
        string? Phone,
        string? Address,
        string? Notes,
        string Status,
        decimal OpeningBalance
    );

    public record CustomerInvoiceDto(
        decimal Amount,
        string Description,
        DateTime? InvoiceDate
    );

    public class CustomerPaymentDto
    {
        public decimal Amount { get; set; }
        public string? Method { get; set; }
        public string? Note { get; set; }
        public DateTime? PaymentDate { get; set; }
    }

    public static class CustomerCalcHelper
    {
        public static (decimal invoicesTotal, decimal paymentsTotal, decimal remaining, DateTime? lastInvoiceDate)
            CalculateTotals(Customer c)
        {
            // 1) ط¥ط¬ظ…ط§ظ„ظٹ ط§ظ„ظپظˆط§طھظٹط± ظ…ظ† CustomerInvoices
            var invoicesTotalFromInvoices = c.Invoices?.Sum(i => i.Amount) ?? 0m;

            // 2) ظپظˆط§طھظٹط± ظ…ط¤ط¬ظ„ط© ظ…ظ† ط§ظ„ظƒط§ط´ظٹط± ظ…ط­ظپظˆط¸ط© ظپظٹ CustomerPayments ظƒظ€ Method = "deferred" ظˆظ…ط¨ظ„ط؛ ظ…ظˆط¬ط¨
            var deferredFromPayments = c.Payments?
                .Where(p => p.Method != null && p.Method.ToLower() == "deferred" && p.Amount > 0)
                .Sum(p => p.Amount) ?? 0m;

            var invoicesTotal = invoicesTotalFromInvoices + deferredFromPayments;

            // 3) ط§ظ„ظ…ط¯ظپظˆط¹ = ط¬ظ…ظٹط¹ ط§ظ„ظ…ط¯ظپظˆط¹ط§طھ ط؛ظٹط± ط§ظ„ظ…ط¤ط¬ظ„ط© ظˆط¨ظ…ط¨ط§ظ„ط؛ ظ…ظˆط¬ط¨ط©
            var paymentsTotal = c.Payments?
                .Where(p => p.Method == null || p.Method.ToLower() != "deferred")
                .Where(p => p.Amount > 0)
                .Sum(p => p.Amount) ?? 0m;

            // 4) ط§ظ„ظ…طھط¨ظ‚ظٹ
            var remaining = invoicesTotal - paymentsTotal;

            // 5) ط¢ط®ط± طھط§ط±ظٹط® ظپط§طھظˆط±ط©
            DateTime? lastInvoiceDateFromInvoices = c.Invoices?
                .OrderByDescending(i => i.InvoiceDate)
                .FirstOrDefault()?.InvoiceDate;

            DateTime? lastDeferredDate = c.Payments?
                .Where(p => p.Method != null && p.Method.ToLower() == "deferred" && p.Amount > 0)
                .OrderByDescending(p => p.PaymentDate)
                .FirstOrDefault()?.PaymentDate;

            DateTime? lastInvoiceDate = lastInvoiceDateFromInvoices;

            if (lastDeferredDate.HasValue)
            {
                if (!lastInvoiceDate.HasValue || lastDeferredDate > lastInvoiceDate)
                    lastInvoiceDate = lastDeferredDate;
            }

            return (invoicesTotal, paymentsTotal, remaining, lastInvoiceDate);
        }
    }

    // ================= Main App =================

    public class Program
    {
        public static void Main(string[] args)
        {
            var builder = WebApplication.CreateBuilder(args);

            // ================= ط¥ط¹ط¯ط§ط¯ ط§ظ„ط§طھطµط§ظ„ ط¨ظ‚ط§ط¹ط¯ط© ط§ظ„ط¨ظٹط§ظ†ط§طھ =================
            // ظ†ط­ط§ظˆظ„ ط§ظ„ظ‚ط±ط§ط،ط© ظ…ظ†:
            // DB_CONNECTION   ط£ظˆ   POSTGRES_CONNECTION
            var providerEnv = Environment.GetEnvironmentVariable("DB_PROVIDER");
            var connFromDbConnection = Environment.GetEnvironmentVariable("DB_CONNECTION");
            var connFromPostgres = Environment.GetEnvironmentVariable("POSTGRES_CONNECTION");

            var connStr = !string.IsNullOrWhiteSpace(connFromDbConnection)
                ? connFromDbConnection
                : connFromPostgres;

            var hasPostgresConn = !string.IsNullOrWhiteSpace(connStr);

            // ط¥ط°ط§ ظ…ط§ ظپظٹظ‡ DB_PROVIDER ظ„ظƒظ† ظپظٹظ‡ connStr ظ†ظپطھط±ط¶ postgres
            if (string.IsNullOrWhiteSpace(providerEnv) && hasPostgresConn)
            {
                providerEnv = "postgres";
            }

            var isPostgres = string.Equals(providerEnv, "postgres", StringComparison.OrdinalIgnoreCase)
                             && hasPostgresConn;

            if (isPostgres)
            {
                builder.Services.AddDbContext<AppDbContext>(opt =>
                    opt.UseNpgsql(connStr));
            }
            else
            {
                // ظ‚ط§ط¹ط¯ط© ط¨ظٹط§ظ†ط§طھ ظ…ط­ظ„ظٹط© SQLite
                builder.Services.AddDbContext<AppDbContext>(opt =>
                    opt.UseSqlite("Data Source=products.db"));
            }

            builder.Services.AddCors(options =>
            {
                options.AddDefaultPolicy(policy =>
                    policy.AllowAnyOrigin()
                          .AllowAnyHeader()
                          .AllowAnyMethod());
            });

            var app = builder.Build();

            // Ensure database and tables are created
            using (var scope = app.Services.CreateScope())
            {
                var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();

                db.Database.EnsureCreated();

                if (isPostgres)
                {
                    var sql = @"
CREATE TABLE IF NOT EXISTS ""Customers"" (
    ""Id"" SERIAL PRIMARY KEY,
    ""Name"" VARCHAR(200) NOT NULL,
    ""Phone"" TEXT NULL,
    ""Address"" TEXT NULL,
    ""Notes"" TEXT NULL,
    ""Status"" VARCHAR(32) NOT NULL,
    ""CreatedAt"" TIMESTAMPTZ NOT NULL
);

CREATE TABLE IF NOT EXISTS ""CustomerInvoices"" (
    ""Id"" SERIAL PRIMARY KEY,
    ""CustomerId"" INT NOT NULL REFERENCES ""Customers""(""Id"") ON DELETE CASCADE,
    ""InvoiceDate"" TIMESTAMPTZ NOT NULL,
    ""Description"" VARCHAR(500) NOT NULL,
    ""Amount"" NUMERIC(18,2) NOT NULL
);

CREATE TABLE IF NOT EXISTS ""CustomerPayments"" (
    ""Id"" SERIAL PRIMARY KEY,
    ""CustomerId"" INT NOT NULL REFERENCES ""Customers""(""Id"") ON DELETE CASCADE,
    ""PaymentDate"" TIMESTAMPTZ NOT NULL,
    ""Amount"" NUMERIC(18,2) NOT NULL,
    ""Method"" VARCHAR(50) NOT NULL,
    ""Note"" TEXT NULL
);
";
                    db.Database.ExecuteSqlRaw(sql);
                }
            }

            app.UseDefaultFiles();
            app.UseStaticFiles();
            app.UseCors();

            // ---------------- PRODUCTS API ----------------

            app.MapGet("/api/products", async (AppDbContext db) =>
                await db.Products
                    .AsNoTracking()
                    .OrderBy(p => p.Id)
                    .ToListAsync());

            app.MapGet("/api/products/{id:int}", async (AppDbContext db, int id) =>
            {
                var product = await db.Products.FindAsync(id);
                return product is null ? Results.NotFound() : Results.Ok(product);
            });

            app.MapPost("/api/products", async (AppDbContext db, Product input) =>
            {
                input.Id = 0;
                db.Products.Add(input);
                await db.SaveChangesAsync();
                return Results.Ok(new { success = true, id = input.Id });
            });

            app.MapPut("/api/products/{id:int}", async (AppDbContext db, int id, Product input) =>
            {
                var product = await db.Products.FindAsync(id);
                if (product is null) return Results.NotFound();

                product.Barcode = input.Barcode;
                product.Name = input.Name;
                product.SupplierName = input.SupplierName;
                product.Category = input.Category;
                product.Quantity = input.Quantity;
                product.MinQuantity = input.MinQuantity;
                product.SoldQuantity = input.SoldQuantity;
                product.PurchasePrice = input.PurchasePrice;
                product.SalePrice = input.SalePrice;
                product.IsVatIncluded = input.IsVatIncluded;
                product.ExpiryDate = input.ExpiryDate;

                product.OfferEnabled = input.OfferEnabled;
                product.OfferName = input.OfferName;
                product.OfferPrice = input.OfferPrice;
                product.OfferStart = input.OfferStart;
                product.OfferEnd = input.OfferEnd;
                product.OfferVatIncluded = input.OfferVatIncluded;

                await db.SaveChangesAsync();
                return Results.Ok(new { success = true, id = product.Id });
            });

            app.MapDelete("/api/products/{id:int}", async (AppDbContext db, int id) =>
            {
                var product = await db.Products.FindAsync(id);
                if (product is null) return Results.NotFound();

                db.Products.Remove(product);
                await db.SaveChangesAsync();
                return Results.NoContent();
            });

            // ---------------- CUSTOMERS / DEFERRED PAYMENTS API ----------------

            app.MapGet("/api/customers/full", async (AppDbContext db) =>
            {
                var list = await db.Customers
                    .Include(c => c.Invoices)
                    .Include(c => c.Payments)
                    .OrderBy(c => c.Id)
                    .ToListAsync();

                var result = list.Select(c =>
                {
                    var totals = CustomerCalcHelper.CalculateTotals(c);

                    var invoicesManual = c.Invoices
                        .OrderBy(i => i.InvoiceDate)
                        .Select(i => new
                        {
                            id = i.Id,
                            customerId = i.CustomerId,
                            date = i.InvoiceDate,
                            description = i.Description,
                            amount = i.Amount
                        });

                    var invoicesDeferredFromPayments = c.Payments
                        .Where(p => p.Method != null && p.Method.ToLower() == "deferred" && p.Amount > 0)
                        .OrderBy(p => p.PaymentDate)
                        .Select(p => new
                        {
                            id = -p.Id,
                            customerId = p.CustomerId,
                            date = p.PaymentDate,
                            description = p.Note ?? "ظپط§طھظˆط±ط© ظ…ط¤ط¬ظ„ط© ظ…ظ† ط´ط§ط´ط© ط§ظ„ظƒط§ط´ظٹط±",
                            amount = p.Amount
                        });

                    var invoicesAll = invoicesManual.Concat(invoicesDeferredFromPayments);

                    var paymentsNormal = c.Payments
                        .Where(p => p.Method == null || p.Method.ToLower() != "deferred")
                        .OrderBy(p => p.PaymentDate)
                        .Select(p => new
                        {
                            id = p.Id,
                            customerId = p.CustomerId,
                            date = p.PaymentDate,
                            amount = p.Amount,
                            method = p.Method,
                            note = p.Note
                        });

                    return new
                    {
                        c.Id,
                        c.Name,
                        c.Phone,
                        c.Address,
                        c.Notes,
                        c.Status,
                        invoicesTotal = totals.invoicesTotal,
                        paymentsTotal = totals.paymentsTotal,
                        remaining = totals.remaining,
                        lastInvoiceDate = totals.lastInvoiceDate,
                        invoices = invoicesAll,
                        payments = paymentsNormal
                    };
                });

                return Results.Ok(result);
            });

            app.MapPost("/api/customers", async (AppDbContext db, CustomerEditDto req) =>
            {
                if (string.IsNullOrWhiteSpace(req.Name))
                    return Results.BadRequest("ط§ط³ظ… ط§ظ„ط¹ظ…ظٹظ„ ظ…ط·ظ„ظˆط¨.");

                var customer = new Customer
                {
                    Name = req.Name.Trim(),
                    Phone = req.Phone?.Trim(),
                    Address = req.Address?.Trim(),
                    Notes = req.Notes?.Trim(),
                    Status = string.IsNullOrWhiteSpace(req.Status) ? "active" : req.Status,
                    CreatedAt = DateTime.UtcNow
                };

                db.Customers.Add(customer);
                await db.SaveChangesAsync();

                if (req.OpeningBalance > 0)
                {
                    var inv = new CustomerInvoice
                    {
                        CustomerId = customer.Id,
                        Amount = req.OpeningBalance,
                        Description = "ط±طµظٹط¯ ط§ظپطھطھط§ط­ظٹ",
                        InvoiceDate = DateTime.UtcNow
                    };
                    db.CustomerInvoices.Add(inv);
                    await db.SaveChangesAsync();
                }

                return Results.Ok(new { success = true, id = customer.Id });
            });

            app.MapPut("/api/customers/{id:int}", async (AppDbContext db, int id, CustomerEditDto req) =>
            {
                var customer = await db.Customers.FindAsync(id);
                if (customer is null) return Results.NotFound();

                customer.Name = req.Name.Trim();
                customer.Phone = req.Phone?.Trim();
                customer.Address = req.Address?.Trim();
                customer.Notes = req.Notes?.Trim();
                customer.Status = string.IsNullOrWhiteSpace(req.Status) ? "active" : req.Status;

                if (req.OpeningBalance > 0)
                {
                    var inv = new CustomerInvoice
                    {
                        CustomerId = customer.Id,
                        Amount = req.OpeningBalance,
                        Description = "ط±طµظٹط¯ ط§ظپطھطھط§ط­ظٹ ظ…ط¶ط§ظپ ظ…ظ† ط§ظ„طھط¹ط¯ظٹظ„",
                        InvoiceDate = DateTime.UtcNow
                    };
                    db.CustomerInvoices.Add(inv);
                }

                await db.SaveChangesAsync();
                return Results.Ok(new { success = true, id = customer.Id });
            });

            app.MapPost("/api/customers/{id:int}/status", async (AppDbContext db, int id, string status) =>
            {
                var customer = await db.Customers.FindAsync(id);
                if (customer is null) return Results.NotFound();

                customer.Status = string.IsNullOrWhiteSpace(status) ? "active" : status;
                await db.SaveChangesAsync();
                return Results.Ok(new { success = true, id = customer.Id, status = customer.Status });
            });

            app.MapDelete("/api/customers/{id:int}", async (AppDbContext db, int id) =>
            {
                var customer = await db.Customers
                    .Include(c => c.Invoices)
                    .Include(c => c.Payments)
                    .FirstOrDefaultAsync(c => c.Id == id);

                if (customer is null) return Results.NotFound();

                var totals = CustomerCalcHelper.CalculateTotals(customer);
                if (totals.remaining > 0)
                    return Results.BadRequest("ظ„ط§ ظٹظ…ظƒظ† ط­ط°ظپ ط§ظ„ط¹ظ…ظٹظ„ ط·ط§ظ„ظ…ط§ ط¹ظ„ظٹظ‡ ظ…ط¨ط§ظ„ط؛ ظ…طھط¨ظ‚ظٹط©.");

                db.Customers.Remove(customer);
                await db.SaveChangesAsync();
                return Results.NoContent();
            });

            app.MapPost("/api/customers/{id:int}/invoices", async (AppDbContext db, int id, CustomerInvoiceDto req) =>
            {
                var customer = await db.Customers.FindAsync(id);
                if (customer is null) return Results.NotFound();

                if (req.Amount <= 0) return Results.BadRequest("ط§ظ„ظ…ط¨ظ„ط؛ ظٹط¬ط¨ ط£ظ† ظٹظƒظˆظ† ط£ظƒط¨ط± ظ…ظ† طµظپط±.");

                var inv = new CustomerInvoice
                {
                    CustomerId = customer.Id,
                    Amount = req.Amount,
                    Description = string.IsNullOrWhiteSpace(req.Description) ? "طھط¹ط¯ظٹظ„ ط±طµظٹط¯ ظٹط¯ظˆظٹ" : req.Description.Trim(),
                    InvoiceDate = req.InvoiceDate ?? DateTime.UtcNow
                };

                db.CustomerInvoices.Add(inv);
                await db.SaveChangesAsync();
                return Results.Ok(new { success = true, id = inv.Id });
            });

            app.MapPost("/api/customers/{id:int}/payments", async (AppDbContext db, int id, CustomerPaymentDto input) =>
            {
                try
                {
                    if (input == null)
                        return Results.BadRequest("ط¨ظٹط§ظ†ط§طھ ط§ظ„ط¯ظپط¹ ط؛ظٹط± طµط­ظٹط­ط©.");

                    if (input.Amount <= 0)
                        return Results.BadRequest("ط§ظ„ظ…ط¨ظ„ط؛ ظٹط¬ط¨ ط£ظ† ظٹظƒظˆظ† ط£ظƒط¨ط± ظ…ظ† طµظپط±.");

                    var customer = await db.Customers.FindAsync(id);
                    if (customer is null)
                        return Results.NotFound("ط§ظ„ط¹ظ…ظٹظ„ ط؛ظٹط± ظ…ظˆط¬ظˆط¯.");

                    var payment = new CustomerPayment
                    {
                        CustomerId = customer.Id,
                        Amount = input.Amount,
                        Method = string.IsNullOrWhiteSpace(input.Method) ? "ظƒط§ط´" : input.Method!,
                        Note = input.Note?.Trim(),
                        PaymentDate = input.PaymentDate ?? DateTime.UtcNow
                    };

                    db.CustomerPayments.Add(payment);
                    await db.SaveChangesAsync();

                    return Results.Ok(new
                    {
                        success = true,
                        id = payment.Id,
                        customerId = payment.CustomerId,
                        amount = payment.Amount,
                        method = payment.Method,
                        note = payment.Note,
                        paymentDate = payment.PaymentDate
                    });
                }
                catch (Exception ex)
                {
                    return Results.BadRequest("ط®ط·ط£ ط£ط«ظ†ط§ط، ط­ظپط¸ ط§ظ„ط¯ظپط¹ط©: " + ex.Message);
                }
            });

            app.MapPut("/api/customer-payments/{paymentId:int}", async (AppDbContext db, int paymentId, CustomerPaymentDto input) =>
            {
                try
                {
                    if (input == null)
                        return Results.BadRequest("ط¨ظٹط§ظ†ط§طھ ط§ظ„ط¯ظپط¹ ط؛ظٹط± طµط­ظٹط­ط©.");

                    if (input.Amount <= 0)
                        return Results.BadRequest("ط§ظ„ظ…ط¨ظ„ط؛ ظٹط¬ط¨ ط£ظ† ظٹظƒظˆظ† ط£ظƒط¨ط± ظ…ظ† طµظپط±.");

                    var payment = await db.CustomerPayments.FindAsync(paymentId);
                    if (payment is null)
                        return Results.NotFound("ط§ظ„ط¯ظپط¹ط© ط؛ظٹط± ظ…ظˆط¬ظˆط¯ط©.");

                    payment.Amount = input.Amount;
                    payment.Method = string.IsNullOrWhiteSpace(input.Method) ? "ظƒط§ط´" : input.Method!;
                    payment.Note = input.Note?.Trim();
                    payment.PaymentDate = input.PaymentDate ?? payment.PaymentDate;

                    await db.SaveChangesAsync();

                    return Results.Ok(new
                    {
                        success = true,
                        id = payment.Id,
                        customerId = payment.CustomerId,
                        amount = payment.Amount,
                        method = payment.Method,
                        note = payment.Note,
                        paymentDate = payment.PaymentDate
                    });
                }
                catch (Exception ex)
                {
                    return Results.BadRequest("ط®ط·ط£ ط£ط«ظ†ط§ط، طھط¹ط¯ظٹظ„ ط§ظ„ط¯ظپط¹ط©: " + ex.Message);
                }
            });

            app.MapDelete("/api/customer-payments/{paymentId:int}", async (AppDbContext db, int paymentId) =>
            {
                var payment = await db.CustomerPayments.FindAsync(paymentId);
                if (payment is null) return Results.NotFound();

                db.CustomerPayments.Remove(payment);
                await db.SaveChangesAsync();
                return Results.NoContent();
            });

            // ---------------- CASHIER INVOICES API ----------------

            app.MapPost("/api/cashier/invoices", async (HttpRequest http, AppDbContext db) =>
            {
                if (!hasPostgresConn)
                {
                    return Results.Problem("ظ„ظ… ظٹطھظ… ط¥ط¹ط¯ط§ط¯ ط§طھطµط§ظ„ PostgreSQL ط¨ط´ظƒظ„ طµط­ظٹط­ (ظٹط±ط¬ظ‰ ط¶ط¨ط· DB_CONNECTION ط£ظˆ POSTGRES_CONNECTION).");
                }

                using var doc = await JsonDocument.ParseAsync(http.Body);
                var root = doc.RootElement;

                if (!root.TryGetProperty("items", out var itemsElement)
                    || itemsElement.ValueKind != JsonValueKind.Array
                    || itemsElement.GetArrayLength() == 0)
                {
                    return Results.BadRequest("ظ„ط§ ظٹظ…ظƒظ† ط­ظپط¸ ظپط§طھظˆط±ط© ط¨ط¯ظˆظ† ط¨ظ†ظˆط¯.");
                }

                await using var conn = new NpgsqlConnection(connStr);
                await conn.OpenAsync();

                var createSql = @"
CREATE TABLE IF NOT EXISTS ""Invoices"" (
    ""Id"" SERIAL PRIMARY KEY,
    ""CustomerId"" INT NULL,
    ""InvoiceDate"" TIMESTAMPTZ NOT NULL,
    ""PaymentMethod"" VARCHAR(20) NOT NULL,
    ""TaxEnabled"" BOOLEAN NOT NULL,
    ""VatPercent"" NUMERIC(5,2) NOT NULL,
    ""Total"" NUMERIC(18,2) NOT NULL,
    ""Notes"" TEXT NULL
);

CREATE TABLE IF NOT EXISTS ""InvoiceItems"" (
    ""Id"" SERIAL PRIMARY KEY,
    ""InvoiceId"" INT NOT NULL REFERENCES ""Invoices""(""Id"") ON DELETE CASCADE,
    ""ProductName"" VARCHAR(255) NOT NULL,
    ""Price"" NUMERIC(18,2) NOT NULL,
    ""Quantity"" NUMERIC(18,2) NOT NULL,
    ""Discount"" NUMERIC(18,2) NOT NULL,
    ""TaxIncluded"" BOOLEAN NOT NULL,
    ""HasOffer"" BOOLEAN NOT NULL,
    ""OfferName"" VARCHAR(255),
    ""OfferEnd"" TIMESTAMPTZ NULL
);
";

                await using (var cmdCreate = new NpgsqlCommand(createSql, conn))
                {
                    await cmdCreate.ExecuteNonQueryAsync();
                }

                string paymentMethod = "unknown";
                if (root.TryGetProperty("paymentMethod", out var pmElem) &&
                    pmElem.ValueKind == JsonValueKind.String)
                {
                    paymentMethod = pmElem.GetString() ?? "unknown";
                }

                bool taxEnabled = true;
                if (root.TryGetProperty("taxEnabled", out var teElem))
                {
                    taxEnabled = teElem.ValueKind == JsonValueKind.True;
                }

                decimal vatPercent = 15m;
                if (root.TryGetProperty("vatPercent", out var vpElem) &&
                    vpElem.ValueKind == JsonValueKind.Number)
                {
                    vpElem.TryGetDecimal(out vatPercent);
                }

                decimal total = 0m;
                if (root.TryGetProperty("total", out var totalElem) &&
                    totalElem.ValueKind == JsonValueKind.Number)
                {
                    totalElem.TryGetDecimal(out total);
                }

                string? notes = null;
                if (root.TryGetProperty("notes", out var notesElem) &&
                    notesElem.ValueKind == JsonValueKind.String)
                {
                    notes = notesElem.GetString();
                }

                int? customerId = null;
                if (root.TryGetProperty("customerId", out var cidElem) &&
                    cidElem.ValueKind == JsonValueKind.Number &&
                    cidElem.TryGetInt32(out var cidVal))
                {
                    customerId = cidVal;
                }

                await using var tx = await conn.BeginTransactionAsync();

                try
                {
                    const string insertInvoiceSql = @"
INSERT INTO ""Invoices""
(""CustomerId"", ""InvoiceDate"", ""PaymentMethod"", ""TaxEnabled"", ""VatPercent"", ""Total"", ""Notes"")
VALUES (@customerId, @invoiceDate, @paymentMethod, @taxEnabled, @vatPercent, @total, @notes)
RETURNING ""Id"";";

                    await using var cmdInvoice = new NpgsqlCommand(insertInvoiceSql, conn, tx);
                    cmdInvoice.Parameters.AddWithValue("@customerId", (object?)customerId ?? DBNull.Value);
                    cmdInvoice.Parameters.AddWithValue("@invoiceDate", DateTime.UtcNow);
                    cmdInvoice.Parameters.AddWithValue("@paymentMethod", paymentMethod);
                    cmdInvoice.Parameters.AddWithValue("@taxEnabled", taxEnabled);
                    cmdInvoice.Parameters.AddWithValue("@vatPercent", vatPercent);
                    cmdInvoice.Parameters.AddWithValue("@total", total);
                    cmdInvoice.Parameters.AddWithValue("@notes", (object?)notes ?? DBNull.Value);

                    var invoiceIdObj = await cmdInvoice.ExecuteScalarAsync();
                    var invoiceId = Convert.ToInt32(invoiceIdObj);

                    const string insertItemSql = @"
INSERT INTO ""InvoiceItems""
(""InvoiceId"", ""ProductName"", ""Price"", ""Quantity"", ""Discount"", ""TaxIncluded"", ""HasOffer"", ""OfferName"", ""OfferEnd"")
VALUES (@invoiceId, @name, @price, @qty, @discount, @taxIncluded, @hasOffer, @offerName, @offerEnd);";

                    foreach (var itemElement in itemsElement.EnumerateArray())
                    {
                        if (itemElement.ValueKind != JsonValueKind.Object)
                            continue;

                        string name = "";
                        if (itemElement.TryGetProperty("name", out var nameElem) &&
                            nameElem.ValueKind == JsonValueKind.String)
                        {
                            name = nameElem.GetString() ?? "";
                        }

                        decimal price = 0m;
                        if (itemElement.TryGetProperty("price", out var priceElem) &&
                            priceElem.ValueKind == JsonValueKind.Number)
                        {
                            priceElem.TryGetDecimal(out price);
                        }

                        decimal qty = 0m;
                        if (itemElement.TryGetProperty("qty", out var qtyElem) &&
                            qtyElem.ValueKind == JsonValueKind.Number)
                        {
                            qtyElem.TryGetDecimal(out qty);
                        }

                        decimal discount = 0m;
                        if (itemElement.TryGetProperty("discount", out var discElem) &&
                            discElem.ValueKind == JsonValueKind.Number)
                        {
                            discElem.TryGetDecimal(out discount);
                        }

                        bool taxIncludedItem = false;
                        if (itemElement.TryGetProperty("taxIncluded", out var tiElem))
                        {
                            taxIncludedItem = tiElem.ValueKind == JsonValueKind.True;
                        }

                        bool hasOffer = false;
                        if (itemElement.TryGetProperty("hasOffer", out var hoElem))
                        {
                            hasOffer = hoElem.ValueKind == JsonValueKind.True;
                        }

                        string? offerName = null;
                        if (itemElement.TryGetProperty("offerName", out var onElem) &&
                            onElem.ValueKind == JsonValueKind.String)
                        {
                            offerName = onElem.GetString();
                        }

                        DateTime? offerEnd = null;
                        if (itemElement.TryGetProperty("offerEnd", out var oeElem) &&
                            oeElem.ValueKind == JsonValueKind.String &&
                            DateTime.TryParse(oeElem.GetString(), out var dt))
                        {
                            offerEnd = dt;
                        }

                        await using var cmdItem = new NpgsqlCommand(insertItemSql, conn, tx);
                        cmdItem.Parameters.AddWithValue("@invoiceId", invoiceId);
                        cmdItem.Parameters.AddWithValue("@name", name);
                        cmdItem.Parameters.AddWithValue("@price", price);
                        cmdItem.Parameters.AddWithValue("@qty", qty);
                        cmdItem.Parameters.AddWithValue("@discount", discount);
                        cmdItem.Parameters.AddWithValue("@taxIncluded", taxIncludedItem);
                        cmdItem.Parameters.AddWithValue("@hasOffer", hasOffer);
                        cmdItem.Parameters.AddWithValue("@offerName", (object?)offerName ?? DBNull.Value);
                        cmdItem.Parameters.AddWithValue("@offerEnd", (object?)offerEnd ?? DBNull.Value);

                        await cmdItem.ExecuteNonQueryAsync();
                        // === Auto inventory update for NaderPOS (by product name) ===
                        try
                        {
                            if (!string.IsNullOrWhiteSpace(name))
                            {
                                var product = await db.Products.FirstOrDefaultAsync(p => p.Name == name);
                                if (product != null)
                                {
                                    var qtyInt = (int)qty;
                                    var newQty = product.Quantity - qtyInt;
                                    if (newQty < 0)
                                        newQty = 0;

                                    product.Quantity = newQty;
                                    var sold = product.SoldQuantity;
                                    sold += qtyInt;
                                    product.SoldQuantity = sold;
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"[WARN] inventory update failed: {ex.Message}");
                        }
                        // === End auto inventory update ===
                    }

                    if (paymentMethod == "deferred" && customerId.HasValue)
                    {
                        const string insertDeferredSql = @"
INSERT INTO ""CustomerPayments""
(""CustomerId"", ""PaymentDate"", ""Amount"", ""Method"", ""Note"")
VALUES (@custId, @paymentDate, @amount, @method, @note);";

                        await using (var cmdDeferred = new NpgsqlCommand(insertDeferredSql, conn, tx))
                        {
                            cmdDeferred.Parameters.AddWithValue("@custId", customerId.Value);
                            cmdDeferred.Parameters.AddWithValue("@paymentDate", DateTime.UtcNow);
                            cmdDeferred.Parameters.AddWithValue("@amount", total);
                            cmdDeferred.Parameters.AddWithValue("@method", "deferred");

                            var deferredNote = notes;
                            if (string.IsNullOrWhiteSpace(deferredNote))
                            {
                                deferredNote = "ظپط§طھظˆط±ط© ظ…ط¤ط¬ظ„ط© ظ…ظ† ط´ط§ط´ط© ط§ظ„ظƒط§ط´ظٹط± ط±ظ‚ظ… " + invoiceId;
                            }
                            else
                            {
                                deferredNote = deferredNote + " (ظپط§طھظˆط±ط© ط±ظ‚ظ… " + invoiceId + ")";
                            }

                            cmdDeferred.Parameters.AddWithValue("@note", deferredNote);
                            await cmdDeferred.ExecuteNonQueryAsync();
                        }
                    }

                    await tx.CommitAsync();
                    // ط­ظپط¸ طھط¹ط¯ظٹظ„ط§طھ ط§ظ„ظ…ط®ط²ظˆظ† ظپظٹ EF Core ط¨ط¹ط¯ ط­ظپط¸ ط§ظ„ظپط§طھظˆط±ط©
                    await db.SaveChangesAsync();
                    var resultStatus = paymentMethod == "deferred" ? "deferred" : "paid";

                    return Results.Ok(new { invoiceId, status = resultStatus });
                }
                catch (Exception ex)
                {
                    await tx.RollbackAsync();
                    return Results.Problem("ط­ط¯ط« ط®ط·ط£ ط£ط«ظ†ط§ط، ط­ظپط¸ ط§ظ„ظپط§طھظˆط±ط©: " + ex.Message);
                }
            });

            // ================= ط¹ط±ط¶ ظ…ظˆط§ط¯ ط§ظ„ظپط§طھظˆط±ط© ط§ظ„ظ…ط¤ط¬ظ„ط© =================
            app.MapGet("/api/customers/deferred-invoice-items/{paymentId:int}", async (AppDbContext db, int paymentId) =>
            {
                if (!hasPostgresConn)
                    return Results.Problem("ط¹ط±ط¶ ظ…ظˆط§ط¯ ط§ظ„ظپط§طھظˆط±ط© ظ…طھط§ط­ ظپظ‚ط· ط¹ظ†ط¯ ط§ظ„ط§طھطµط§ظ„ ط¨ظ€ PostgreSQLطŒ ظˆظ„ظ… ظٹطھظ… ط¥ط¹ط¯ط§ط¯ ط§طھطµط§ظ„ PostgreSQL.");

                var payment = await db.CustomerPayments.FindAsync(paymentId);
                if (payment is null)
                    return Results.NotFound("ظ„ظ… ظٹطھظ… ط§ظ„ط¹ط«ظˆط± ط¹ظ„ظ‰ ط§ظ„ط­ط±ظƒط©.");

                int? invoiceId = null;

                if (!string.IsNullOrWhiteSpace(payment.Note))
                {
                    var m = Regex.Match(payment.Note, "(\\d+)$");
                    if (m.Success && int.TryParse(m.Groups[1].Value, out var parsed))
                    {
                        invoiceId = parsed;
                    }
                }

                await using var conn = new NpgsqlConnection(connStr);
                await conn.OpenAsync();

                if (!invoiceId.HasValue)
                {
                    const string findSql = @"
SELECT ""Id""
FROM ""Invoices""
WHERE ""CustomerId"" = @custId AND ""Total"" = @total
ORDER BY ABS(EXTRACT(EPOCH FROM (""InvoiceDate"" - @pDate)))
LIMIT 1;";

                    await using var cmdFind = new NpgsqlCommand(findSql, conn);
                    cmdFind.Parameters.AddWithValue("@custId", payment.CustomerId);
                    cmdFind.Parameters.AddWithValue("@total", payment.Amount);
                    cmdFind.Parameters.AddWithValue("@pDate", payment.PaymentDate);

                    var obj = await cmdFind.ExecuteScalarAsync();
                    if (obj != null && obj != DBNull.Value)
                    {
                        invoiceId = Convert.ToInt32(obj);
                    }
                }

                if (!invoiceId.HasValue)
                    return Results.NotFound("ظ„ظ… ظٹطھظ… ط§ظ„ط¹ط«ظˆط± ط¹ظ„ظ‰ ط±ظ‚ظ… ط§ظ„ظپط§طھظˆط±ط©.");

                const string itemsSql = @"
SELECT ""ProductName"", ""Price"", ""Quantity"", ""Discount""
FROM ""InvoiceItems""
WHERE ""InvoiceId"" = @invId;";

                await using var cmdItems = new NpgsqlCommand(itemsSql, conn);
                cmdItems.Parameters.AddWithValue("@invId", invoiceId.Value);

                var items = new List<object>();

                await using (var reader = await cmdItems.ExecuteReaderAsync())
                {
                    while (await reader.ReadAsync())
                    {
                        var name = reader.GetString(0);
                        var price = reader.GetDecimal(1);
                        var qty = reader.GetDecimal(2);
                        var discount = reader.GetDecimal(3);
                        var totalItem = (price - discount) * qty;

                        items.Add(new
                        {
                            productName = name,
                            price,
                            quantity = qty,
                            discount,
                            total = totalItem
                        });
                    }
                }

                return Results.Ok(new { invoiceId = invoiceId.Value, items });
            });

            // ---------------- CASHIER INVOICE ITEMS API ----------------

// إرجاع مواد فاتورة واحدة حسب رقم الفاتورة من شاشة الكاشير
app.MapGet("/api/cashier/invoices/{invoiceId:int}/items", async (int invoiceId) =>
{
    if (!hasPostgresConn)
    {
        return Results.Problem("عرض مواد الفاتورة متاح فقط عند استخدام PostgreSQL، ولم يتم إعداد اتصال PostgreSQL.");
    }

    await using var conn = new NpgsqlConnection(connStr);
    await conn.OpenAsync();

    const string sql = @"
SELECT ii.""ProductName"",
       ii.""Price"",
       ii.""Quantity"",
       ii.""Discount"",
       ii.""TaxIncluded"",
       ii.""HasOffer"",
       ii.""OfferName"",
       COALESCE(p.""Barcode"", '''') AS ""Barcode""
FROM ""InvoiceItems"" ii
LEFT JOIN ""Products"" p ON p.""Name"" = ii.""ProductName""
WHERE ii.""InvoiceId"" = @id
ORDER BY ii.""Id"";";

    await using var cmd = new NpgsqlCommand(sql, conn);
    cmd.Parameters.AddWithValue("@id", invoiceId);

    await using var reader = await cmd.ExecuteReaderAsync();
    var list = new List<object>();

    while (await reader.ReadAsync())
    {
        list.Add(new
        {
            productName = reader.GetString(0),
            price       = reader.GetDecimal(1),
            qty         = reader.GetDecimal(2),
            discount    = reader.GetDecimal(3),
            taxIncluded = reader.GetBoolean(4),
            hasOffer    = reader.GetBoolean(5),
            offerName   = reader.IsDBNull(6) ? null : reader.GetString(6),
            barcode     = reader.IsDBNull(7) ? "" : reader.GetString(7)
        });
    }

    return Results.Ok(list);
});

// ---------------- INVOICES REPORT API (for invoices.html) ----------------

            app.MapGet("/api/invoices", async (HttpRequest http) =>
            {
                if (!hasPostgresConn)
                {
                    return Results.Problem("ط¹ط±ط¶ طھظ‚ط±ظٹط± ط§ظ„ظپظˆط§طھظٹط± ظ…طھط§ط­ ظپظ‚ط· ط¹ظ†ط¯ ط§ط³طھط®ط¯ط§ظ… PostgreSQLطŒ ظˆظ„ظ… ظٹطھظ… ط¥ط¹ط¯ط§ط¯ ط§طھطµط§ظ„ PostgreSQL.");
                }

                int? invoiceId = null;
                var invoiceIdStr = http.Query["invoiceId"];
                if (!string.IsNullOrWhiteSpace(invoiceIdStr) && int.TryParse(invoiceIdStr, out var parsedId))
                    invoiceId = parsedId;

                DateTime? from = null;
                DateTime? to = null;
                var fromStr = http.Query["from"];
                var toStr = http.Query["to"];

                if (!string.IsNullOrWhiteSpace(fromStr) && DateTime.TryParse(fromStr, out var dtFrom))
                    from = dtFrom.Date;
                if (!string.IsNullOrWhiteSpace(toStr) && DateTime.TryParse(toStr, out var dtTo))
                    to = dtTo.Date.AddDays(1).AddTicks(-1);

                string? paymentMethod = http.Query["paymentMethod"];
                string? status = http.Query["status"];

                await using var conn = new NpgsqlConnection(connStr);
                await conn.OpenAsync();

                var sql = @"
SELECT ""Id"", ""InvoiceDate"", ""PaymentMethod"", ""TaxEnabled"", ""VatPercent"", ""Total"", ""Notes"", ""CustomerId""
FROM ""Invoices""
WHERE 1=1";
                var cmd = new NpgsqlCommand();
                cmd.Connection = conn;

                if (invoiceId.HasValue)
                {
                    sql += " AND \"Id\" = @id";
                    cmd.Parameters.AddWithValue("@id", invoiceId.Value);
                }
                if (from.HasValue)
                {
                    sql += " AND \"InvoiceDate\" >= @from";
                    cmd.Parameters.AddWithValue("@from", from.Value.ToUniversalTime());
                }
                if (to.HasValue)
                {
                    sql += " AND \"InvoiceDate\" <= @to";
                    cmd.Parameters.AddWithValue("@to", to.Value.ToUniversalTime());
                }
                if (!string.IsNullOrWhiteSpace(paymentMethod))
                {
                    sql += " AND LOWER(\"PaymentMethod\") = @pm";
                    cmd.Parameters.AddWithValue("@pm", paymentMethod.ToLowerInvariant());
                }

                if (!string.IsNullOrWhiteSpace(status))
                {
                    var st = status.ToLowerInvariant();
                    if (st == "deferred")
                    {
                        sql += " AND LOWER(\"PaymentMethod\") = 'deferred'";
                    }
                    else if (st == "paid")
                    {
                        sql += " AND LOWER(\"PaymentMethod\") <> 'deferred'";
                    }
                }

                sql += " ORDER BY \"InvoiceDate\", \"Id\";";
                cmd.CommandText = sql;

                var list = new List<object>();
                await using (var reader = await cmd.ExecuteReaderAsync())
                {
                    while (await reader.ReadAsync())
                    {
                        list.Add(new
                        {
                            Id = reader.GetInt32(0),
                            InvoiceDate = reader.GetDateTime(1),
                            PaymentMethod = reader.GetString(2),
                            TaxEnabled = reader.GetBoolean(3),
                            VatPercent = reader.GetDecimal(4),
                            Total = reader.GetDecimal(5),
                            Notes = reader.IsDBNull(6) ? null : reader.GetString(6),
                            CustomerId = reader.IsDBNull(7) ? (int?)null : reader.GetInt32(7)
                        });
                    }
                }

                return Results.Ok(list);
            });

            // ---------------- DELETE INVOICE API (with inventory restore) ----------------

            app.MapDelete("/api/invoices/{invoiceId:int}", async (int invoiceId, AppDbContext db) =>
            {
                if (!hasPostgresConn)
                {
                    return Results.Problem("ط­ط°ظپ ط§ظ„ظپط§طھظˆط±ط© ظ…طھط§ط­ ظپظ‚ط· ط¹ظ†ط¯ ط§ط³طھط®ط¯ط§ظ… PostgreSQLطŒ ظˆظ„ظ… ظٹطھظ… ط¥ط¹ط¯ط§ط¯ ط§طھطµط§ظ„ PostgreSQL.");
                }

                await using var conn = new NpgsqlConnection(connStr);
                await conn.OpenAsync();

                await using var tx = await conn.BeginTransactionAsync();

                // ط¬ظ„ط¨ ظ…ظˆط§ط¯ ط§ظ„ظپط§طھظˆط±ط© ظ‚ط¨ظ„ ط§ظ„ط­ط°ظپ ظ„ط§ط³طھط®ط¯ط§ظ…ظ‡ط§ ظپظٹ طھط¹ط¯ظٹظ„ ط§ظ„ظ…ط®ط²ظˆظ†
                var items = new List<(string ProductName, decimal Quantity)>();
                const string selectItemsSql = @"
SELECT ""ProductName"", ""Quantity""
FROM ""InvoiceItems""
WHERE ""InvoiceId"" = @invId;";

                await using (var cmdItems = new NpgsqlCommand(selectItemsSql, conn, tx))
                {
                    cmdItems.Parameters.AddWithValue("@invId", invoiceId);
                    await using var reader = await cmdItems.ExecuteReaderAsync();
                    while (await reader.ReadAsync())
                    {
                        var name = reader.GetString(0);
                        var qty = reader.GetDecimal(1);
                        items.Add((name, qty));
                    }
                }

                // ط§ظ„طھط­ظ‚ظ‚ ظ…ظ† ظˆط¬ظˆط¯ ط§ظ„ظپط§طھظˆط±ط©
                const string existsSql = @"SELECT COUNT(1) FROM ""Invoices"" WHERE ""Id"" = @invId;";
                await using (var cmdExists = new NpgsqlCommand(existsSql, conn, tx))
                {
                    cmdExists.Parameters.AddWithValue("@invId", invoiceId);
                    var countObj = await cmdExists.ExecuteScalarAsync();
                    var count = Convert.ToInt32(countObj);
                    if (count == 0)
                    {
                        await tx.RollbackAsync();
                        return Results.NotFound("ظ„ظ… ظٹطھظ… ط§ظ„ط¹ط«ظˆط± ط¹ظ„ظ‰ ط±ظ‚ظ… ط§ظ„ظپط§طھظˆط±ط©.");
                    }
                }

                // ط­ط°ظپ ط§ظ„ظپط§طھظˆط±ط© (ط³ظٹطھظ… ط­ط°ظپ ط§ظ„ظ…ظˆط§ط¯ طھظ„ظ‚ط§ط¦ظٹط§ظ‹ ط¨ط³ط¨ط¨ ON DELETE CASCADE)
                const string deleteSql = @"DELETE FROM ""Invoices"" WHERE ""Id"" = @invId;";
                await using (var cmdDelete = new NpgsqlCommand(deleteSql, conn, tx))
                {
                    cmdDelete.Parameters.AddWithValue("@invId", invoiceId);
                    await cmdDelete.ExecuteNonQueryAsync();
                }

                await tx.CommitAsync();

                // طھط¹ط¯ظٹظ„ ط§ظ„ظ…ط®ط²ظˆظ† ظپظٹ EF Core ط¨ط¹ط¯ ط§ظ„ط­ط°ظپ
                try
                {
                    foreach (var it in items)
                    {
                        if (string.IsNullOrWhiteSpace(it.ProductName))
                            continue;

                        var product = await db.Products.FirstOrDefaultAsync(p => p.Name == it.ProductName);
                        if (product == null) continue;

                        var qtyInt = (int)it.Quantity;
                        product.Quantity += qtyInt;

                        var sold = product.SoldQuantity;
                        sold -= qtyInt;
                        if (sold < 0) sold = 0;
                        product.SoldQuantity = sold;
                    }

                    await db.SaveChangesAsync();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[WARN] inventory restore after delete failed: {ex.Message}");
                }

                return Results.NoContent();
            });

            // ---------------- RETURNS API (partial / full) ----------------

            app.MapPost("/api/returns", async (HttpRequest http, AppDbContext db) =>
            {
                if (!hasPostgresConn)
                {
                    return Results.Problem("طھط³ط¬ظٹظ„ ط§ظ„ظ…ط±طھط¬ط¹ ظ…طھط§ط­ ظپظ‚ط· ط¹ظ†ط¯ ط§ط³طھط®ط¯ط§ظ… PostgreSQLطŒ ظˆظ„ظ… ظٹطھظ… ط¥ط¹ط¯ط§ط¯ ط§طھطµط§ظ„ PostgreSQL.");
                }

                using var doc = await JsonDocument.ParseAsync(http.Body);
                var root = doc.RootElement;

                if (!root.TryGetProperty("invoiceId", out var invIdElem) ||
                    invIdElem.ValueKind != JsonValueKind.Number ||
                    !invIdElem.TryGetInt32(out var invoiceId))
                {
                    return Results.BadRequest("ط±ظ‚ظ… ط§ظ„ظپط§طھظˆط±ط© (invoiceId) ظ…ظپظ‚ظˆط¯ ط£ظˆ ط؛ظٹط± طµط­ظٹط­.");
                }

                string? returnInvoiceNumber = null;
                if (root.TryGetProperty("returnInvoiceNumber", out var rinElem) &&
                    rinElem.ValueKind == JsonValueKind.String)
                {
                    returnInvoiceNumber = rinElem.GetString();
                }

                string? note = null;
                if (root.TryGetProperty("note", out var noteElem) &&
                    noteElem.ValueKind == JsonValueKind.String)
                {
                    note = noteElem.GetString();
                }

                if (!root.TryGetProperty("items", out var itemsElem) ||
                    itemsElem.ValueKind != JsonValueKind.Array ||
                    itemsElem.GetArrayLength() == 0)
                {
                    return Results.BadRequest("ظ„ط§ ظٹظ…ظƒظ† طھظ†ظپظٹط° ظ…ط±طھط¬ط¹ ط¨ط¯ظˆظ† ط¹ظ†ط§طµط±.");
                }

                await using var conn = new NpgsqlConnection(connStr);
                await conn.OpenAsync();

                // ظ‚ط±ط§ط،ط© ظ…ظˆط§ط¯ ط§ظ„ظپط§طھظˆط±ط© ط§ظ„ط£طµظ„ظٹط© ظ…ظ† ظ‚ط§ط¹ط¯ط© ط§ظ„ط¨ظٹط§ظ†ط§طھ
                var originalItems = new Dictionary<string, decimal>(StringComparer.OrdinalIgnoreCase);
                const string loadItemsSql = @"
SELECT ""ProductName"", ""Quantity""
FROM ""InvoiceItems""
WHERE ""InvoiceId"" = @invId;";

                await using (var cmdLoad = new NpgsqlCommand(loadItemsSql, conn))
                {
                    cmdLoad.Parameters.AddWithValue("@invId", invoiceId);
                    await using var reader = await cmdLoad.ExecuteReaderAsync();
                    while (await reader.ReadAsync())
                    {
                        var name = reader.GetString(0);
                        var qty = reader.GetDecimal(1);
                        if (originalItems.TryGetValue(name, out var existing))
                        {
                            originalItems[name] = existing + qty;
                        }
                        else
                        {
                            originalItems[name] = qty;
                        }
                    }
                }

                if (originalItems.Count == 0)
                {
                    return Results.BadRequest("ظ„ظ… ظٹطھظ… ط§ظ„ط¹ط«ظˆط± ط¹ظ„ظ‰ ظ…ظˆط§ط¯ ظ„ظ‡ط°ظ‡ ط§ظ„ظپط§طھظˆط±ط©.");
                }

                // طھط¬ظ‡ظٹط² ط¨ظٹط§ظ†ط§طھ ط§ظ„ظ…ط±طھط¬ط¹ ظˆط§ظ„طھط­ظ‚ظ‚ ظ…ظ† ط§ظ„ظƒظ…ظٹط§طھ
                var returnLines = new List<(string ProductName, decimal Quantity)>();
                foreach (var item in itemsElem.EnumerateArray())
                {
                    if (item.ValueKind != JsonValueKind.Object)
                        continue;

                    string? productName = null;
                    if (item.TryGetProperty("productName", out var pnElem) &&
                        pnElem.ValueKind == JsonValueKind.String)
                    {
                        productName = pnElem.GetString();
                    }

                    if (string.IsNullOrWhiteSpace(productName))
                        continue;

                    decimal retQty = 0m;
                    if (item.TryGetProperty("quantity", out var rqElem) &&
                        rqElem.ValueKind == JsonValueKind.Number)
                    {
                        rqElem.TryGetDecimal(out retQty);
                    }

                    if (retQty <= 0)
                        continue;

                    if (!originalItems.TryGetValue(productName, out var soldQty))
                    {
                        return Results.BadRequest($"ظ„ط§ ظٹظ…ظƒظ† طھظ†ظپظٹط° ظ…ط±طھط¬ط¹ ظ„ظ„ظ…ظ†طھط¬ '{productName}' ظ„ط£ظ†ظ‡ ط؛ظٹط± ظ…ظˆط¬ظˆط¯ ظپظٹ ط§ظ„ظپط§طھظˆط±ط© ط§ظ„ط£طµظ„ظٹط©.");
                    }

                    if (retQty > soldQty)
                    {
                        return Results.BadRequest($"ظƒظ…ظٹط© ط§ظ„ظ…ط±طھط¬ط¹ ظ„ظ„ظ…ظ†طھط¬ '{productName}' ط£ظƒط¨ط± ظ…ظ† ط§ظ„ظƒظ…ظٹط© ط§ظ„ظ…ط¨ط§ط¹ط© ({soldQty}).");
                    }

                    returnLines.Add((productName, retQty));
                }

                if (returnLines.Count == 0)
                {
                    return Results.BadRequest("ظ„ظ… ظٹطھظ… طھط­ط¯ظٹط¯ ط£ظٹ ظƒظ…ظٹط§طھ طµط§ظ„ط­ط© ظ„ظ„ظ…ط±طھط¬ط¹.");
                }

                // طھط­ط¯ظٹط« ظ…ظ„ط§ط­ط¸ط§طھ ط§ظ„ظپط§طھظˆط±ط© ظ„طھط³ط¬ظٹظ„ ط±ظ‚ظ… ظپط§طھظˆط±ط© ط§ظ„ظ…ط±طھط¬ط¹
                try
                {
                    const string selectInvSql = @"SELECT ""Notes"" FROM ""Invoices"" WHERE ""Id"" = @invId;";
                    string? existingNotes = null;

                    await using (var cmdSel = new NpgsqlCommand(selectInvSql, conn))
                    {
                        cmdSel.Parameters.AddWithValue("@invId", invoiceId);
                        var obj = await cmdSel.ExecuteScalarAsync();
                        if (obj != null && obj != DBNull.Value)
                            existingNotes = Convert.ToString(obj);
                    }

                    var extraNote = "";
                    if (!string.IsNullOrWhiteSpace(returnInvoiceNumber))
                    {
                        extraNote = $"ظ…ط±طھط¬ط¹ ط±ظ‚ظ… {returnInvoiceNumber} ط¹ظ† ظپط§طھظˆط±ط© ط±ظ‚ظ… {invoiceId}";
                    }
                    else
                    {
                        extraNote = $"ظ…ط±طھط¬ط¹ ط¬ط²ط¦ظٹ/ظƒط§ظ…ظ„ ط¹ظ† ظپط§طھظˆط±ط© ط±ظ‚ظ… {invoiceId}";
                    }

                    if (!string.IsNullOrWhiteSpace(note))
                    {
                        extraNote += " - " + note;
                    }

                    string? newNotes;
                    if (string.IsNullOrWhiteSpace(existingNotes))
                    {
                        newNotes = extraNote;
                    }
                    else
                    {
                        newNotes = existingNotes + " | " + extraNote;
                    }

                    const string updateInvSql = @"UPDATE ""Invoices"" SET ""Notes"" = @notes WHERE ""Id"" = @invId;";
                    await using (var cmdUpd = new NpgsqlCommand(updateInvSql, conn))
                    {
                        cmdUpd.Parameters.AddWithValue("@notes", (object?)newNotes ?? DBNull.Value);
                        cmdUpd.Parameters.AddWithValue("@invId", invoiceId);
                        await cmdUpd.ExecuteNonQueryAsync();
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[WARN] failed to update invoice notes for return: {ex.Message}");
                }

                // طھط¹ط¯ظٹظ„ ط§ظ„ظ…ط®ط²ظˆظ† (ط¥ط±ط¬ط§ط¹ ط§ظ„ظƒظ…ظٹط§طھ) ظپظٹ EF Core
                try
                {
                    foreach (var line in returnLines)
                    {
                        var product = await db.Products.FirstOrDefaultAsync(p => p.Name == line.ProductName);
                        if (product == null) continue;

                        var qtyInt = (int)line.Quantity;
                        product.Quantity += qtyInt;

                        var sold = product.SoldQuantity;
                        sold -= qtyInt;
                        if (sold < 0) sold = 0;
                        product.SoldQuantity = sold;
                    }

                    await db.SaveChangesAsync();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[WARN] inventory update for return failed: {ex.Message}");
                }

                return Results.Ok(new
                {
                    success = true,
                    invoiceId,
                    returnInvoiceNumber = returnInvoiceNumber,
                    itemsCount = returnLines.Count
                });
            });

            // ---------------- PRODUCTS REPORT API (top selling) ----------------

            app.MapGet("/api/reports/products", async (HttpRequest http) =>
            {
                if (!hasPostgresConn)
                {
                    return Results.Problem("طھظ‚ط±ظٹط± ط§ظ„ظ…ظ†طھط¬ط§طھ ظ…طھط§ط­ ظپظ‚ط· ط¹ظ†ط¯ ط§ط³طھط®ط¯ط§ظ… PostgreSQLطŒ ظˆظ„ظ… ظٹطھظ… ط¥ط¹ط¯ط§ط¯ ط§طھطµط§ظ„ PostgreSQL.");
                }

                DateTime? from = null;
                DateTime? to = null;
                var fromStr = http.Query["from"];
                var toStr = http.Query["to"];

                if (!string.IsNullOrWhiteSpace(fromStr) && DateTime.TryParse(fromStr, out var dtFrom))
                    from = dtFrom.Date;
                if (!string.IsNullOrWhiteSpace(toStr) && DateTime.TryParse(toStr, out var dtTo))
                    to = dtTo.Date.AddDays(1).AddTicks(-1);

                await using var conn = new NpgsqlConnection(connStr);
                await conn.OpenAsync();

                var sql = @"
SELECT it.""ProductName"",
       SUM(it.""Quantity"") AS TotalQuantity,
       SUM((it.""Price"" - it.""Discount"") * it.""Quantity"") AS TotalAmount
FROM ""Invoices"" AS i
JOIN ""InvoiceItems"" AS it ON it.""InvoiceId"" = i.""Id""
WHERE 1=1";

                var cmd = new NpgsqlCommand();
                cmd.Connection = conn;

                if (from.HasValue)
                {
                    sql += " AND i.\"InvoiceDate\" >= @from";
                    cmd.Parameters.AddWithValue("@from", from.Value.ToUniversalTime());
                }
                if (to.HasValue)
                {
                    sql += " AND i.\"InvoiceDate\" <= @to";
                    cmd.Parameters.AddWithValue("@to", to.Value.ToUniversalTime());
                }

                sql += @"
GROUP BY it.""ProductName""
ORDER BY TotalQuantity DESC, it.""ProductName"";";

                cmd.CommandText = sql;

                var list = new List<object>();
                await using (var reader = await cmd.ExecuteReaderAsync())
                {
                    while (await reader.ReadAsync())
                    {
                        list.Add(new
                        {
                            ProductName = reader.GetString(0),
                            TotalQuantity = reader.GetDecimal(1),
                            TotalAmount = reader.GetDecimal(2)
                        });
                    }
                }

                return Results.Ok(list);
            });

                }

                return Results.Ok(list);
            });

            // ط¥ط±ط¬ط§ط¹ ظ…ظˆط§ط¯ ط¬ظ…ظٹط¹ ظپظˆط§طھظٹط± ط§ظ„ظƒط§ط´ظٹط± ظ„ظ„ط¹ظ…ظٹظ„ ط­ط³ط¨ ظپطھط±ط© ط§ظ„طھط§ط±ظٹط® (ظ„ظ„طھظ‚ط±ظٹط± ط§ظ„طھط¬ظ…ظٹط¹ظٹ)
            app.MapGet("/api/customers/{customerId:int}/all-invoice-items", async (int customerId, DateTime from, DateTime to) =>
            {
                if (!hasPostgresConn)
                {
                    return Results.Problem("ط¹ط±ط¶ ظ…ظˆط§ط¯ ط§ظ„ظپظˆط§طھظٹط± ظ…طھط§ط­ ظپظ‚ط· ط¹ظ†ط¯ ط§ط³طھط®ط¯ط§ظ… PostgreSQLطŒ ظˆظ„ظ… ظٹطھظ… ط¥ط¹ط¯ط§ط¯ ط§طھطµط§ظ„ PostgreSQL.");
                }

                await using var conn = new NpgsqlConnection(connStr);
                await conn.OpenAsync();

                const string sql = @"
SELECT i.""Id"", i.""InvoiceDate"", i.""Total"",
       it.""ProductName"", it.""Price"", it.""Quantity"", it.""Discount""
FROM ""Invoices"" AS i
JOIN ""InvoiceItems"" AS it ON it.""InvoiceId"" = i.""Id""
WHERE i.""CustomerId"" = @custId
  AND i.""InvoiceDate"" >= @from
  AND i.""InvoiceDate"" <= @to
ORDER BY i.""InvoiceDate"", i.""Id"", it.""Id"";";

                await using var cmd = new NpgsqlCommand(sql, conn);
                cmd.Parameters.AddWithValue("@custId", customerId);
                cmd.Parameters.AddWithValue("@from", from.ToUniversalTime());
                cmd.Parameters.AddWithValue("@to", to.ToUniversalTime());

                var reader = await cmd.ExecuteReaderAsync();
                var list = new List<object>();

                while (await reader.ReadAsync())
                {
                    list.Add(new
                    {
                        invoiceId = reader.GetInt32(0),
                        invoiceDate = reader.GetDateTime(1),
                        invoiceTotal = reader.GetDecimal(2),
                        productName = reader.GetString(3),
                        price = reader.GetDecimal(4),
                        qty = reader.GetDecimal(5),
                        discount = reader.GetDecimal(6)
                    });
                }

                return Results.Ok(list);
            });

            // === Invoices report API for invoices.html ===
            app.MapGet("/api/cashier/report-invoices", async (HttpRequest http) =>
            {
                if (!hasPostgresConn)
                {
                    return Results.Problem("ط¹ط±ط¶ طھظ‚ط±ظٹط± ط§ظ„ظپظˆط§طھظٹط± ظ…طھط§ط­ ظپظ‚ط· ط¹ظ†ط¯ ط§ط³طھط®ط¯ط§ظ… PostgreSQL.");
                }

                int? invoiceId = null;
                var invoiceIdStr = http.Query["invoiceId"];
                if (!string.IsNullOrWhiteSpace(invoiceIdStr) && int.TryParse(invoiceIdStr, out var parsedId))
                {
                    invoiceId = parsedId;
                }

                DateTime? from = null;
                DateTime? to = null;

                var fromStr = http.Query["from"];
                var toStr   = http.Query["to"];

                if (!string.IsNullOrWhiteSpace(fromStr) && DateTime.TryParse(fromStr, out var dtFrom))
                {
                    from = dtFrom.Date;
                }

                if (!string.IsNullOrWhiteSpace(toStr) && DateTime.TryParse(toStr, out var dtTo))
                {
                    to = dtTo.Date.AddDays(1).AddTicks(-1);
                }

                string? paymentMethod = http.Query["paymentMethod"];
                string? status        = http.Query["status"];

                await using var conn = new NpgsqlConnection(connStr);
                await conn.OpenAsync();

                var sql = "SELECT \"Id\", \"InvoiceDate\", \"PaymentMethod\", \"TaxEnabled\", \"VatPercent\", \"Total\", \"Notes\", \"CustomerId\" " +
                          "FROM \"Invoices\" WHERE 1=1";

                if (invoiceId.HasValue)
                {
                    sql += " AND \"Id\" = @id";
                }

                if (from.HasValue)
                {
                    sql += " AND \"InvoiceDate\" >= @from";
                }

                if (to.HasValue)
                {
                    sql += " AND \"InvoiceDate\" <= @to";
                }

                if (!string.IsNullOrWhiteSpace(paymentMethod))
                {
                    sql += " AND LOWER(\"PaymentMethod\") = @pm";
                }

                if (!string.IsNullOrWhiteSpace(status))
                {
                    var st = status.ToLowerInvariant();
                    if (st == "deferred")
                    {
                        sql += " AND LOWER(\"PaymentMethod\") = 'deferred'";
                    }
                    else if (st == "paid")
                    {
                        sql += " AND LOWER(\"PaymentMethod\") <> 'deferred'";
                    }
                }

                sql += " ORDER BY \"InvoiceDate\" DESC, \"Id\" DESC;";

                await using var cmd = new NpgsqlCommand(sql, conn);

                if (invoiceId.HasValue)
                {
                    cmd.Parameters.AddWithValue("@id", invoiceId.Value);
                }

                if (from.HasValue)
                {
                    cmd.Parameters.AddWithValue("@from", from.Value.ToUniversalTime());
                }

                if (to.HasValue)
                {
                    cmd.Parameters.AddWithValue("@to", to.Value.ToUniversalTime());
                }

                if (!string.IsNullOrWhiteSpace(paymentMethod))
                {
                    cmd.Parameters.AddWithValue("@pm", paymentMethod.ToLowerInvariant());
                }

                var list = new List<object>();

                await using (var reader = await cmd.ExecuteReaderAsync())
                {
                    while (await reader.ReadAsync())
                    {
                        list.Add(new
                        {
                            Id            = reader.GetInt32(0),
                            InvoiceDate   = reader.GetDateTime(1),
                            PaymentMethod = reader.GetString(2),
                            TaxEnabled    = reader.GetBoolean(3),
                            VatPercent    = reader.GetDecimal(4),
                            Total         = reader.GetDecimal(5),
                            Notes         = reader.IsDBNull(6) ? null : reader.GetString(6),
                            CustomerId    = reader.IsDBNull(7) ? (int?)null : reader.GetInt32(7)
                        });
                    }
                }

                return Results.Ok(list);
            });
            // === Products sales report API for invoices.html (طھظ‚ط±ظٹط± ط§ظ„ظ…ظ†طھط¬ط§طھ ظˆط§ظ„ظƒظ…ظٹط© ط§ظ„ظ…ط¨ط§ط¹ط©) ===
            app.MapGet("/api/reports/products", async (HttpRequest http) =>
            {
                if (!hasPostgresConn)
                {
                    return Results.Problem("طھظ‚ط±ظٹط± ط§ظ„ظ…ظ†طھط¬ط§طھ ظ…طھط§ط­ ظپظ‚ط· ط¹ظ†ط¯ ط§ط³طھط®ط¯ط§ظ… PostgreSQL.");
                }

                DateTime? from = null;
                DateTime? to = null;

                var fromStr = http.Query["from"];
                var toStr   = http.Query["to"];

                if (!string.IsNullOrWhiteSpace(fromStr) && DateTime.TryParse(fromStr, out var dtFrom))
                {
                    from = dtFrom.Date;
                }

                if (!string.IsNullOrWhiteSpace(toStr) && DateTime.TryParse(toStr, out var dtTo))
                {
                    to = dtTo.Date.AddDays(1).AddTicks(-1);
                }

                await using var conn = new NpgsqlConnection(connStr);
                await conn.OpenAsync();

                var sql = @"
SELECT ii.""ProductName"",
       SUM(ii.""Quantity"") AS TotalQuantity,
       SUM((ii.""Price"" * ii.""Quantity"") - ii.""Discount"") AS TotalAmount
FROM ""InvoiceItems"" ii
JOIN ""Invoices"" i ON ii.""InvoiceId"" = i.""Id""
WHERE 1=1";

                if (from.HasValue)
                {
                    sql += " AND i.\"InvoiceDate\" >= @from";
                }

                if (to.HasValue)
                {
                    sql += " AND i.\"InvoiceDate\" <= @to";
                }

                sql += " GROUP BY ii.\"ProductName\" ORDER BY TotalQuantity DESC;";

                await using var cmd = new NpgsqlCommand(sql, conn);

                if (from.HasValue)
                {
                    cmd.Parameters.AddWithValue("@from", from.Value.ToUniversalTime());
                }

                if (to.HasValue)
                {
                    cmd.Parameters.AddWithValue("@to", to.Value.ToUniversalTime());
                }

                var list = new List<object>();

                await using (var reader = await cmd.ExecuteReaderAsync())
                {
                    while (await reader.ReadAsync())
                    {
                        var nameObj = reader.GetValue(0);
                        var qtyObj  = reader.GetValue(1);
                        var amtObj  = reader.GetValue(2);

                        string productName = nameObj == DBNull.Value ? "" : Convert.ToString(nameObj) ?? "";
                        decimal totalQty   = qtyObj  == DBNull.Value ? 0m : Convert.ToDecimal(qtyObj);
                        decimal totalAmt   = amtObj  == DBNull.Value ? 0m : Convert.ToDecimal(amtObj);

                        list.Add(new
                        {
                            ProductName   = productName,
                            TotalQuantity = totalQty,
                            TotalAmount   = totalAmt
                        });
                    }
                }

                return Results.Ok(list);
            });
            // === Invoices report API for invoices.html (طھط·ط¨ظٹط¹ ط·ط±ظٹظ‚ط© ط§ظ„ط¯ظپط¹) ===
            app.MapGet("/api/cashier/report-invoices-alt2", async (HttpRequest http) =>
            {
                if (!hasPostgresConn)
                {
                    return Results.Problem("ط¹ط±ط¶ طھظ‚ط±ظٹط± ط§ظ„ظپظˆط§طھظٹط± ظ…طھط§ط­ ظپظ‚ط· ط¹ظ†ط¯ ط§ط³طھط®ط¯ط§ظ… PostgreSQL.");
                }

                int? invoiceId = null;
                var invoiceIdStr = http.Query["invoiceId"];
                if (!string.IsNullOrWhiteSpace(invoiceIdStr) && int.TryParse(invoiceIdStr, out var parsedId))
                {
                    invoiceId = parsedId;
                }

                DateTime? from = null;
                DateTime? to = null;

                var fromStr = http.Query["from"];
                var toStr   = http.Query["to"];

                if (!string.IsNullOrWhiteSpace(fromStr) && DateTime.TryParse(fromStr, out var dtFrom))
                {
                    from = dtFrom.Date;
                }

                if (!string.IsNullOrWhiteSpace(toStr) && DateTime.TryParse(toStr, out var dtTo))
                {
                    to = dtTo.Date.AddDays(1).AddTicks(-1);
                }

                string? paymentMethodFilter = http.Query["paymentMethod"];
                string? status        = http.Query["status"];

                await using var conn = new NpgsqlConnection(connStr);
                await conn.OpenAsync();

                var sql = @"
SELECT
    ""Id"",
    ""InvoiceDate"",
    CASE
        WHEN LOWER(""PaymentMethod"") IN ('cash','ظ†ظ‚ط¯ظٹ','ظ†ظ‚ط¯') THEN 'ظ†ظ‚ط¯ظٹ'
        WHEN LOWER(""PaymentMethod"") IN ('network','card','ط´ط¨ظƒط©','net') THEN 'ط´ط¨ظƒط©'
        WHEN LOWER(""PaymentMethod"") IN ('deferred','ظ…ط¤ط¬ظ„') THEN 'ظ…ط¤ط¬ظ„'
        ELSE 'ط؛ظٹط± ظ…ط­ط¯ط¯'
    END AS ""PaymentMethod"",
    ""TaxEnabled"",
    ""VatPercent"",
    ""Total"",
    ""Notes"",
    ""CustomerId""
FROM ""Invoices""
WHERE 1=1";

                if (invoiceId.HasValue)
                {
                    sql += " AND \"Id\" = @id";
                }

                if (from.HasValue)
                {
                    sql += " AND \"InvoiceDate\" >= @from";
                }

                if (to.HasValue)
                {
                    sql += " AND \"InvoiceDate\" <= @to";
                }

                if (!string.IsNullOrWhiteSpace(paymentMethodFilter))
                {
                    sql += " AND LOWER(\"PaymentMethod\") = @pmFilter";
                }

                if (!string.IsNullOrWhiteSpace(status))
                {
                    var st = status.ToLowerInvariant();
                    if (st == "deferred")
                    {
                        sql += " AND LOWER(\"PaymentMethod\") = 'deferred'";
                    }
                    else if (st == "paid")
                    {
                        sql += " AND LOWER(\"PaymentMethod\") <> 'deferred'";
                    }
                }

                sql += " ORDER BY \"InvoiceDate\" DESC, \"Id\" DESC;";

                await using var cmd = new NpgsqlCommand(sql, conn);

                if (invoiceId.HasValue)
                {
                    cmd.Parameters.AddWithValue("@id", invoiceId.Value);
                }

                if (from.HasValue)
                {
                    cmd.Parameters.AddWithValue("@from", from.Value.ToUniversalTime());
                }

                if (to.HasValue)
                {
                    cmd.Parameters.AddWithValue("@to", to.Value.ToUniversalTime());
                }

                if (!string.IsNullOrWhiteSpace(paymentMethodFilter))
                {
                    cmd.Parameters.AddWithValue("@pmFilter", paymentMethodFilter.ToLowerInvariant());
                }

                var list = new List<object>();

                await using (var reader = await cmd.ExecuteReaderAsync())
                {
                    while (await reader.ReadAsync())
                    {
                        list.Add(new
                        {
                            Id            = reader.GetInt32(0),
                            InvoiceDate   = reader.GetDateTime(1),
                            PaymentMethod = reader.GetString(2),
                            TaxEnabled    = reader.GetBoolean(3),
                            VatPercent    = reader.GetDecimal(4),
                            Total         = reader.GetDecimal(5),
                            Notes         = reader.IsDBNull(6) ? null : reader.GetString(6),
                            CustomerId    = reader.IsDBNull(7) ? (int?)null : reader.GetInt32(7)
                        });
                    }
                }

                return Results.Ok(list);
            });
            app.Run();
        }
    }
}


