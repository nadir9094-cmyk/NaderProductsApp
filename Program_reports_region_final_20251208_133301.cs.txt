using Npgsql.EntityFrameworkCore.PostgreSQL;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Http;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;

var builder = WebApplication.CreateBuilder(args);

// إضافة DbContext مع دعم Postgres أو SQLite
builder.Services.AddDbContext<AppDbContext>(options =>
{
    // اتصال مباشر بقواعد بيانات Postgres في Render
    var connStr =
        "Host=dpg-d4p8e96uk2gs73d7hqv0-a.virginia-postgres.render.com;Port=5432;Database=naderposdb;Username=naderuser;Password=ESleHPj9Ux6m52uDtFkLoWa1lA4XaTMo;Ssl Mode=Require;Trust Server Certificate=true";

    options.UseNpgsql(connStr);
});

var app = builder.Build();// إنشاء قاعدة البيانات والجداول إذا لم تكن موجودة
using (var scope = app.Services.CreateScope())
{
    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
    db.Database.EnsureCreated();
}

app.UseDefaultFiles();
app.UseStaticFiles();

app.MapGet("/", () => Results.Redirect("/invoices.html"));

#region التقارير

// تقرير المنتجات /api/reports/products
app.MapGet("/api/reports/products", async (AppDbContext db) =>
{
    var data = await db.Products
        .OrderBy(p => p.Name)
        .Select(p => new
        {
            id           = p.Id,
            name         = p.Name,
            barcode      = p.Barcode,
            category     = p.Category,
            quantity     = p.Quantity,
            soldQuantity = p.SoldQuantity,
            minQuantity  = p.MinQuantity,
            purchasePrice= p.PurchasePrice,
            salePrice    = p.SalePrice,
            isVatIncluded= p.IsVatIncluded,
            supplierName = p.SupplierName
        })
        .ToListAsync();

    return Results.Ok(data);
});

// تقرير خصومات الفواتير /api/reports/invoice-discounts
app.MapGet("/api/reports/invoice-discounts", async (AppDbContext db) =>
{
    var invoices = await db.CashierInvoices.ToListAsync();

    var summary = new
    {
        invoicesCount = invoices.Count,
        totalSub      = invoices.Sum(x => (double)x.SubTotal),
        totalDiscount = invoices.Sum(x => (double)x.DiscountTotal),
        totalVat      = invoices.Sum(x => (double)x.VatTotal),
        totalGrand    = invoices.Sum(x => (double)x.GrandTotal)
    };

    return Results.Ok(summary);
});

#endregion

app.Run();

#region EF Core Models

public class AppDbContext : DbContext
{
    public DbSet<Product>            Products            => Set<Product>();
    public DbSet<Customer>           Customers           => Set<Customer>();
    public DbSet<CashierInvoice>     CashierInvoices     => Set<CashierInvoice>();
    public DbSet<CashierInvoiceItem> CashierInvoiceItems => Set<CashierInvoiceItem>();

    public AppDbContext(DbContextOptions<AppDbContext> options) : base(options) { }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<Product>().ToTable("Products");
        modelBuilder.Entity<Customer>().ToTable("Customers");
        modelBuilder.Entity<CashierInvoice>().ToTable("CashierInvoices");
        modelBuilder.Entity<CashierInvoiceItem>().ToTable("CashierInvoiceItems");

        modelBuilder.Entity<CashierInvoice>()
            .HasMany(i => i.Items)
            .WithOne(i => i.Invoice!)
            .HasForeignKey(i => i.InvoiceId)
            .OnDelete(DeleteBehavior.Cascade);
    }
}

public class Product
{
    public int      Id              { get; set; }
    public string?  Name            { get; set; }
    public string?  Barcode         { get; set; }
    public string?  Category        { get; set; }
    public decimal  Quantity        { get; set; }
    public decimal  SoldQuantity    { get; set; }
    public decimal  MinQuantity     { get; set; }
    public decimal  PurchasePrice   { get; set; }
    public decimal  SalePrice       { get; set; }
    public bool     IsVatIncluded   { get; set; }
    public DateTime? ExpiryDate     { get; set; }
    public bool     OfferEnabled    { get; set; }
    public string?  OfferName       { get; set; }
    public decimal? OfferPrice      { get; set; }
    public DateTime? OfferStart     { get; set; }
    public DateTime? OfferEnd       { get; set; }
    public bool     OfferVatIncluded{ get; set; }
    public string?  SupplierName    { get; set; }
}

public class Customer
{
    public int      Id       { get; set; }
    public string   Name     { get; set; } = "";
    public string?  Phone    { get; set; }
    public string?  Address  { get; set; }
    public string?  Note     { get; set; }
    public bool     IsActive { get; set; } = true;
}

public class CashierInvoice
{
    public int      Id            { get; set; }
    public DateTime InvoiceDate   { get; set; }
    public string   PaymentMethod { get; set; } = "";
    public string?  CustomerName  { get; set; }
    public string?  CustomerPhone { get; set; }
    public decimal  SubTotal      { get; set; }
    public decimal  DiscountTotal { get; set; }
    public decimal  VatTotal      { get; set; }
    public decimal  GrandTotal    { get; set; }
    public bool     IsSuspended   { get; set; }
    public string?  Notes         { get; set; }

    public List<CashierInvoiceItem> Items { get; set; } = new();
}

public class CashierInvoiceItem
{
    public int      Id          { get; set; }
    public int      InvoiceId   { get; set; }
    public string   ProductName { get; set; } = "";
    public string?  Barcode     { get; set; }
    public decimal  Quantity    { get; set; }
    public decimal  Price       { get; set; }
    public decimal  Discount    { get; set; }
    public bool     TaxIncluded { get; set; }
    public bool     HasOffer    { get; set; }
    public string?  OfferName   { get; set; }

    public CashierInvoice? Invoice { get; set; }
}

// DTOs لطلبات الحفظ من شاشة الكاشير
public class CashierInvoiceItemRequest
{
    public string   ProductName { get; set; } = "";
    public string?  Barcode     { get; set; }
    public decimal  Quantity    { get; set; }
    public decimal  Price       { get; set; }
    public decimal  Discount    { get; set; }
    public bool     TaxIncluded { get; set; }
    public bool     HasOffer    { get; set; }
    public string?  OfferName   { get; set; }
}

public class CashierInvoiceRequest
{
    public int      Id            { get; set; }
    public DateTime InvoiceDate   { get; set; }
    public string   PaymentMethod { get; set; } = "";
    public string?  CustomerName  { get; set; }
    public string?  CustomerPhone { get; set; }
    public decimal  SubTotal      { get; set; }
    public decimal  DiscountTotal { get; set; }
    public decimal  VatTotal      { get; set; }
    public decimal  GrandTotal    { get; set; }
    public bool     IsSuspended   { get; set; }
    public string?  Notes         { get; set; }

    public List<CashierInvoiceItemRequest> Items { get; set; } = new();
}

#endregion












